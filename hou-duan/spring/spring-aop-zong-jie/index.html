



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="一位Blog" href="http://adamshang2333.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="一位Blog" href="http://adamshang2333.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="一位Blog" href="http://adamshang2333.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="spring,aop" />


<link rel="canonical" href="http://adamshang2333.github.io/hou-duan/spring/spring-aop-zong-jie/">



  <title>
Spring AOP 总结 - 总结 - spring |
bit Blog = 一位 Blog = bit =>byte KB MB GB TB ... 积跬步而行千里</title>
<meta name="generator" content="Hexo 5.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Spring AOP 总结
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2021-05-30 16:53:11">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2021-05-30T16:53:11+08:00">2021-05-30</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>17k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>16 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">bit Blog</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://gitee.com/oldFun/picGitee/raw/master/img/wallhaven-g77wxd.jpg"></li>
          <li class="item" data-background-image="https://gitee.com/oldFun/picGitee/raw/master/img/wallhaven-5d32r9.png"></li>
          <li class="item" data-background-image="https://gitee.com/oldFun/picGitee/raw/master/img/wallhaven-oxkgel.jpg"></li>
          <li class="item" data-background-image="https://gitee.com/oldFun/picGitee/raw/master/img/wallhaven-xlx9pl.jpg"></li>
          <li class="item" data-background-image="https://gitee.com/oldFun/picGitee/raw/master/img/wallhaven-o33gv7.jpg"></li>
          <li class="item" data-background-image="https://gitee.com/oldFun/picGitee/raw/master/img/wallhaven-57wq75.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/spring/" itemprop="item" rel="index" title="分类于 spring"><span itemprop="name">spring</span></a>
<meta itemprop="position" content="1" /></span>
<i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/spring/%E6%80%BB%E7%BB%93/" itemprop="item" rel="index" title="分类于 总结"><span itemprop="name">总结</span></a>
<meta itemprop="position" content="2" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="http://adamshang2333.github.io/hou-duan/spring/spring-aop-zong-jie/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/%E5%90%90%E8%88%8C.jpeg">
    <meta itemprop="name" content="别人都叫我老范">
    <meta itemprop="description" content="bit =>byte KB MB GB TB ... 积跬步而行千里, <div style='font-size: 0.8em;'> I.is (null); <br/>If (U.appear ()) <br/>I.turn (new World ('Fill With Love')) <br/>// 我的世界 <br/>// 直至遇见你 <br/>// 才熠熠生辉 </div> ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="一位 Blog">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="spring-aop-知识点总结"><a class="anchor" href="#spring-aop-知识点总结">#</a> Spring AOP 知识点总结</h1>
<h2 id="aop的设计思想"><a class="anchor" href="#aop的设计思想">#</a> AOP 的设计思想</h2>
<p>开发时将代码<strong>拆分</strong>，运行时<strong>合并运行</strong>。对项目进行<strong>解耦</strong></p>
<blockquote>
<p>对于业务开发，不用关心进入业务方法前后的事情处理 ==&gt; 拆分</p>
<p>运行时，实际是代理类在执行  ==&gt; 将业务代码和统一的处理逻辑合并</p>
<p>===&gt; 对于整个项目流程而言，部分无关业务逻辑的代码可以解耦</p>
</blockquote>
<h2 id="aop的基本概念"><a class="anchor" href="#aop的基本概念">#</a> AOP 的基本概念</h2>
<h3 id="切面aspect"><a class="anchor" href="#切面aspect">#</a> 切面 (Aspect)</h3>
<p>​		切入点和通知的结合</p>
<h3 id="连接点jointpoint"><a class="anchor" href="#连接点jointpoint">#</a> 连接点 (JointPoint)</h3>
<p>​		Spring 允许进行通知的地方，基本上每个方法的前后，抛出异常时都可以是连接点</p>
<blockquote>
<p>Spring 只支持方法连接点，其他如 AspectJ 还支持在构造器或者属性注入时</p>
</blockquote>
<h3 id="切入点pointcut"><a class="anchor" href="#切入点pointcut">#</a> 切入点 (PointCut)</h3>
<p>​		进入切面的入口，使用切点表达式匹配连接点，在 AOP 中通知和一个切入点表达式关联</p>
<blockquote>
<p>在连接点的基础上，使用切点表达式来定义切点 --&gt; 切点来筛选想要增强的连接点</p>
<p>切点表达式 可通过方法的出入参，使用的注解等来表达</p>
</blockquote>
<h3 id="通知advice"><a class="anchor" href="#通知advice">#</a> 通知 (Advice)</h3>
<p>​		通知解决何时执行这个工作切面，是对于某个连接点所产生的动作 .</p>
<p>对同一个目标对象，可以应用多个通知 (将切面织入)</p>
<blockquote>
<p>通知使用了模板设计模式</p>
<p>通知分为多种:</p>
<p><strong>前置通知 (@Before)</strong> : 在目标方法被调用之前调用通知</p>
<p><strong>后置通知 (@After)</strong> : 在目标方法<strong>完成之后</strong>调用通知 不会关心方法的输出</p>
<p><strong>返回通知 (@AfterReturning)</strong> : 在目标方法<strong>成功执行</strong>之后调用通知</p>
<p><code>和后置通知的区别:</code></p>
<p><code>返回通知一定是方法正常结束时才会执行;后置通知不管方法是否有异常</code></p>
<p><strong>异常通知 (@AfterThrowing)</strong> : 在目标方法抛出异常退出执行时调用通知</p>
<p><strong>环绕通知 (@Around)</strong>: 在目标方法调用之前和之后执行，类似 Filter 的拦截器链</p>
</blockquote>
<h3 id="目标对象target"><a class="anchor" href="#目标对象target">#</a> 目标对象 (Target)</h3>
<p>​		被一个或多个切面所通知的对象</p>
<h3 id="aop代理aop-proxy"><a class="anchor" href="#aop代理aop-proxy">#</a> AOP 代理 (Aop Proxy)</h3>
<p>​		持有被代理对象引用的代理类</p>
<blockquote>
<p>Spring Aop 提供两种代理方式:</p>
<p>1  JDK 动态代理，默认采用。目标对象实现了接口时使用</p>
<p>2  CGlib 动态代理，没有接口时 使用字节码技术生成代理对象</p>
</blockquote>
<h3 id="织入"><a class="anchor" href="#织入">#</a> 织入</h3>
<p>​		把切面应用到目标对象的过程</p>
<p>==&gt; 即：将目标方法和通知触发的增强内容合并 创建运行时的代理对象</p>
<h2 id="aop的应用场景"><a class="anchor" href="#aop的应用场景">#</a> AOP 的应用场景</h2>
<h3 id="调用日志"><a class="anchor" href="#调用日志">#</a> 调用日志</h3>
<h3 id="缓存"><a class="anchor" href="#缓存">#</a> 缓存</h3>
<p>​		前置通知判断是否有缓存，没有通过返回通知存入缓存</p>
<h3 id="监听"><a class="anchor" href="#监听">#</a> 监听</h3>
<h3 id="拦截器"><a class="anchor" href="#拦截器">#</a> 拦截器</h3>
<h3 id="调试"><a class="anchor" href="#调试">#</a> 调试</h3>
<h3 id="权限"><a class="anchor" href="#权限">#</a> 权限</h3>
<h3 id="事务"><a class="anchor" href="#事务">#</a> 事务</h3>
<h2 id="aop中通知的顺序"><a class="anchor" href="#aop中通知的顺序">#</a> AOP 中通知的顺序</h2>
<h3 id="通知的优先级"><a class="anchor" href="#通知的优先级">#</a> 通知的优先级</h3>
<p>对同一个目标方法，可以匹配多个通知进行织入</p>
<p><strong>通知的顺序和声明顺序无关，只与方法的执行有关:</strong></p>
<p>优先级从上到下 :</p>
<pre><code>环绕通知
前置通知
异常通知
返回通知(方法有没有return关键字 正常执行结束都会触发)
后置通知(方法有没有正常执行结束 都会触发)
</code></pre>
<p>### 示例</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// AOP 切面类 </span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(public * com.aop.demo.service.*.*(..))"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token comment">// 切点表达式的定义 传入一个切点方法</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"before()"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doBefore</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> jp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"=== 进入前置通知"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token comment">// 切点表达式 亦可直接做为 value 值传入</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@After</span><span class="token punctuation">(</span><span class="token string">"execution(public * com.aop.demo.service.*.*(..))"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAfter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"=== 进入后置通知"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    </pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token annotation punctuation">@AfterThrowing</span><span class="token punctuation">(</span><span class="token string">"execution(public * com.aop.demo.service.*.*(..))"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doThrowing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"=== 进入异常通知"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    </pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span><span class="token string">"execution(public * com.aop.demo.service.*.*(..))"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"=== 进入返回通知"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"execution(public * com.aop.demo.service.*.*(..))"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doAround</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"=== 进入环绕通知"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">Object</span> result <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"=== 环绕通知执行后"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token comment">// 被代理目标类的方法</span></pre></td></tr><tr><td data-num="29"></td><td><pre>		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">voidMother</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===执行无返回值的方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">division</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===进入有返回值的方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>       <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">int</span> c <span class="token operator">=</span>  a <span class="token operator">/</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===返回之前"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" === 返回值 :"</span> <span class="token operator">+</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">return</span> c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"=== 执行方法异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>有异常:</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">15.206</span> INFO <span class="token number">51535</span> <span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>   <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 进入环绕通知</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">15.206</span> INFO <span class="token number">51535</span> <span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>   <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 进入前置通知</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">15.259</span> INFO <span class="token number">51535</span> <span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">demo<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>AopService</span> <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span>进入有返回值的方法</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">15.259</span> INFO <span class="token number">51535</span> <span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>   <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 进入异常通知</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">15.259</span> INFO <span class="token number">51535</span> <span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>   <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 进入后置通知</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ArithmeticException</span><span class="token operator">:</span> <span class="token operator">/</span> by zero</pre></td></tr></table></figure><blockquote>
<p>异常通知触发之后，会阻断之后的运行 ---&gt; pjp.proceed () 之后的 AOP 增强 都不会被执行.</p>
<p>异常被捕获，目标方法不会抛出异常时 不会触发异常通知</p>
</blockquote>
<p>异常被捕获:</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">14.451</span>  INFO <span class="token number">52208</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>  <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 进入环绕通知</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">14.451</span>  INFO <span class="token number">52208</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>  <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 进入前置通知</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">14.505</span>  INFO <span class="token number">52208</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>AopService</span><span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span>进入有返回值的方法</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">14.506</span>  INFO <span class="token number">52208</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>AopService</span><span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 执行方法异常被捕获</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">14.506</span>  INFO <span class="token number">52208</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>  <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 进入返回通知</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">14.506</span>  INFO <span class="token number">52208</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>  <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 进入后置通知</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">14.506</span>  INFO <span class="token number">52208</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>  <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 环绕通知执行后</pre></td></tr></table></figure><p>正常返回:</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">37.792</span>  INFO <span class="token number">51803</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>   <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 进入环绕通知</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">37.792</span>  INFO <span class="token number">51803</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>   <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 进入前置通知</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">37.846</span>  INFO <span class="token number">51803</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">demo<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>AopService</span> <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span>进入有返回值的方法</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">37.846</span>  INFO <span class="token number">51803</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">demo<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>AopService</span> <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span>返回之前</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">37.846</span>  INFO <span class="token number">51803</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>   <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 进入返回通知</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">37.846</span>  INFO <span class="token number">51803</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>   <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 进入后置通知</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">2021</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">37.847</span>  INFO <span class="token number">51803</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">demo<span class="token punctuation">.</span>aspect<span class="token punctuation">.</span></span>AopAspect</span>   <span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">=</span> 环绕通知执行后</pre></td></tr></table></figure><h2 id="切点表达式"><a class="anchor" href="#切点表达式">#</a> 切点表达式</h2>
<h3 id="切点表达式概念"><a class="anchor" href="#切点表达式概念">#</a> 切点表达式概念</h3>
<p>切点表达式，目的是描述目标方法的方法签名信息</p>
<blockquote>
<p>方法描述主要有以下关键部分:</p>
<p><strong>权限修饰符</strong> (public private protect , 可省略)</p>
<p><strong>返回值</strong> (void / 具体类型 / *)</p>
<p><strong>所在包名，类名</strong> (..* 当前路径下的所有递归子包，类比 url 的 ../)</p>
<p><strong>方法名</strong> (具体方法名 / *)</p>
<p><strong>方法参数</strong> (具体参数顺序 &amp;&amp; 类型 /.. (通配任意) )</p>
</blockquote>
<p><strong> <code>!!切点表达式要切入的目标方法 , 不能出现final / static关键字</code> </strong></p>
<blockquote>
<p><strong>static 或 final 修饰的方法不能被代理</strong></p>
<p>代理类需要重写继承或实现接口的被代理类方法，使用 static 或 final 修饰的方法 不能被继承重写</p>
</blockquote>
<p>### 切点表达式的声明方式</p>
<p>切点表达式有两种声明方式:</p>
<h4 id="1-piontcut-和before等配合使用"><a class="anchor" href="#1-piontcut-和before等配合使用">#</a> 1.  @Piontcut 和 @Before 等配合使用</h4>
<p>使用 <code>@Pointcut()</code>  注解标注一个无参 void 空方法，在 Advice 的通知注解中，</p>
<p>value 值为 @Pointcut 注解标注的方法名 ==&gt; 方便对切点表达式的复用</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(public * com.aop.demo.service.*.*(..))"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token comment">// 切点表达式的定义 传入一个被 @Pointcut 标注的切点方法</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"before()"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doBefore</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> jp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"=== 进入前置通知"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="2-before等注解的values中直接写切点表达式"><a class="anchor" href="#2-before等注解的values中直接写切点表达式">#</a> 2.  @Before () 等注解的 values 中直接写切点表达式</h4>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"execution(public * com.aop.demo.service.*.*(..))"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doBefore</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> jp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"=== 进入前置通知"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="切点指示符"><a class="anchor" href="#切点指示符">#</a> 切点指示符</h3>
<blockquote>
<p>切点指示符是切点定义的关键字，切点表达式以切点指示符开始。开发人员使切点指示符来告诉切点将要匹配什么，有以下 9 种切点指示符：**execution、within、this、target、args、@target、@args、@within、@annotation，** 下面一一介结这 9 种切点指示符。</p>
</blockquote>
<h4 id="切点表达式的通配符"><a class="anchor" href="#切点表达式的通配符">#</a> 切点表达式的通配符</h4>
<p>与正则表达式有点类似，主要有 <code>*</code>  和  <code>..</code>  两种通配符，让切点表达式更加灵活</p>
<blockquote>
<p><code>*</code>    :  匹配任意一个单词，或者以某个单词为前缀或后缀的单词<br />
 <code>..</code>  :  匹配 0 项或多项，用于包名和参数的匹配<br />
注 :    <code>..</code>  <strong>匹配包名时，表示指定包及其子包；匹配参数时可在指定参数类型后添加，表示以指定参数类型开头，其他参数任意</strong></p>
<p><code>＋</code>  ：匹配给定类的<strong>任意子类</strong></p>
</blockquote>
<p>####execution ---&gt; 方法级别</p>
<p>使用频率最高的指示符，从方法级别标识切点，表达式用来匹配方法的签名信息，方法签名使用全限定名，</p>
<p>包括访问修饰符（public/private/protected）、返回类型，包名、类名、方法名、参数、抛出异常，</p>
<p><strong>其中返回类型，包名，类名，方法，参数是必须的</strong></p>
<p>** 示例 : **</p>
<p><code>execution(public * com.aop.demo.service.*.*(..))</code></p>
<p>===&gt; 任意返回值，在 com.aop.demo.service 包下的任意类的任意一个方法，方法参数为 0~n 个</p>
<p><code>execution(* com.spring.service.Business*.*())</code></p>
<p>===&gt; 任意返回值，在 com.spring.service 包下，以 Business 开头的类中的任意方法，方法参数为空</p>
<p><code>execution(* com.spring.service..*.businessService())</code></p>
<p>===&gt; 任意返回值 在 com.spring.service 包以及 service 包下的子包中，任意类中的方法名为 businessService 的空参方法</p>
<blockquote>
<p><code>service..*.businessService() </code>  这里， <code>service..*</code>  的解读，理解为延续前面的 service 路径 从而包含其子路径</p>
<p><code>*.businessService()</code>  这里的 * 表示匹配一个单词，因为是在方法名前，因而表示匹配任意的类。</p>
</blockquote>
<p><code>execution(* com.spring.service.BusinessObject.businessService(java.lang.String,..))</code></p>
<p>===&gt; 任意返回值，包路径为 com.spring.service 下的 BusinessObject 类，businessService 方法，第一个参数是 string 其他参数任意</p>
<h4 id="within-类级别"><a class="anchor" href="#within-类级别">#</a> within ---&gt; 类级别</h4>
<p>within 表达式的粒度为类，<strong>其参数为全路径的类名（可使用通配符）</strong>，表示匹配当前表达式的所有类都将被当前方法环绕。</p>
<p><strong>示例 :</strong></p>
<p><code>within(com.spring.service.*)</code></p>
<p>===&gt; com.spring.service 包下的所有类的所有方法 <strong>(不包含 service 子包中的类)</strong></p>
<p><code>within(com.spring.service..*)</code></p>
<p>===&gt; com.spring.service 包及其子包下的所有类的所有方法 <strong>(包含 service 子包中的类)</strong></p>
<h4 id="args-参数级别"><a class="anchor" href="#args-参数级别">#</a> args ---&gt; 参数级别</h4>
<p>匹配指定参数类型和指定参数数量的方法，<strong> 无论其类路径或者是方法名是什么</strong>。需要注意的是，<strong>args 指定的参数必须是全路径的</strong>。</p>
<blockquote>
<p>注意 : <strong>参数的通配符匹配不能使用 <code>*</code>  , 只有  <code>..</code>  可以使用</strong></p>
<p>使用  <code>*</code>  会直接抛出异常:    <code>@Before(&quot;args(java.lang.*)&quot;)</code></p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Caused</span> by<span class="token operator">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>IllegalArgumentException</span><span class="token operator">:</span> error wildcard type pattern not allowed<span class="token punctuation">,</span> must use type name</pre></td></tr><tr><td data-num="3"></td><td><pre>at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>aspectj<span class="token punctuation">.</span>weaver<span class="token punctuation">.</span>tools<span class="token punctuation">.</span></span>PointcutParser</span><span class="token punctuation">.</span><span class="token function">parsePointcutExpression</span><span class="token punctuation">(</span><span class="token class-name">PointcutParser</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">319</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>aspectjweaver<span class="token operator">-</span><span class="token number">1.9</span><span class="token number">.6</span><span class="token punctuation">.</span>jar<span class="token operator">:</span>na<span class="token punctuation">]</span></pre></td></tr></table></figure></blockquote>
<p><strong>示例 :</strong></p>
<p><code>args(java.lang.String)</code></p>
<p>===&gt; 匹配所有的只有一个参数，并且参数是 java.lang.String 的方法</p>
<p><code>args(java.lang.String,..,java.lang.Integer)</code></p>
<p>===&gt; 匹配第一个参数为 java.lang.String，最后一个参数为 java.lang.Integer，并且中间可以有任意个数和类型参数的方法</p>
<h4 id="this-和-target-类级别代理类"><a class="anchor" href="#this-和-target-类级别代理类">#</a> this 和 target ---&gt; 类级别 (代理类)</h4>
<blockquote>
<p>this : 如果当前对象生成的代理对象符合 this 指定的类型，那么就为其织入切面逻辑。简单的说就是，this 将匹配代理对象为指定类型的类</p>
<p>target : 匹配业务对象为指定类型的类</p>
</blockquote>
<p>匹配代理对象时 this 和 target 会有区别:</p>
<p><strong>基于接口的 jdk 代理</strong>  ==&gt; <strong>target</strong> 指示符用于基于 JDK 动态代理的代理类</p>
<p><strong>未实现接口的 cglib 代理</strong> ==&gt;  <strong>this</strong> 指示符就是用来匹配基于 CGLIB 的代理类</p>
<h4 id="within-类级别关注类上注解"><a class="anchor" href="#within-类级别关注类上注解">#</a> @within --&gt; 类级别 (关注类上注解)</h4>
<p>通过描述类上的注解全限定名，匹配带有指定注解的类下的方法</p>
<p><strong>示例 :</strong></p>
<p><code>@within(com.business.annotation.FruitAspect)</code></p>
<p>===&gt; 类上注解包含  <code>com.business.annotation.FruitAspect</code>  类型的类中方法</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 注解类</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>PARAMETER<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">FruitAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 目标类</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@FruitAspect</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Apple</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// !! eat () 方法将会被匹配，进行 AOP 织入</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Apple.eat method invoked."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// 切面类</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token annotation punctuation">@Aspect</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"@within(com.business.annotation.FruitAspect)"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"this is before around advice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">Object</span> result <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"this is after around advice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="annotation-方法级别关注方法上注解"><a class="anchor" href="#annotation-方法级别关注方法上注解">#</a> @annotation --&gt; 方法级别 (关注方法上注解)</h4>
<p>通过描述方法上的注解全限定名，匹配使用 @annotation 指定注解标注的方法将会被环绕</p>
<p><strong>示例 :</strong></p>
<p><code>@annotation(com.spring.annotation.BusinessAspect)</code></p>
<p>===&gt; 方法签名上包含 <code>com.spring.annotation.BusinessAspect</code>  的方法</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 注解类</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>PARAMETER<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">FruitAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 目标类</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Apple</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">// !! eat () 方法将会被匹配，进行 AOP 织入</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token annotation punctuation">@FruitAspect</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Apple.eat method invoked."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// 切面类</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token annotation punctuation">@Aspect</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"@annotation(com.business.annotation.FruitAspect)"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"this is before around advice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">Object</span> result <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"this is after around advice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="args-参数级别关注参数类上的注解"><a class="anchor" href="#args-参数级别关注参数类上的注解">#</a> @args --&gt; 参数级别 (关注参数类上的注解)</h4>
<p>使用指定注解标注的类作为某个方法的参数时该方法将会被匹配。</p>
<p><strong>示例 :</strong></p>
<p><code>@args(com.spring.annotation.FruitAspect)</code></p>
<p>===&gt; 方法入参的参数中，类上注解包含 <code>com.spring.annotation.FruitAspect</code>  的方法会被匹配</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 注解类</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>PARAMETER<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">FruitAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 使用注解标注的参数类</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@FruitAspect</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Apple</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Apple.eat method invoked."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FruitBucket</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">// !! 使用 Apple 参数的目标方法 会被匹配后 AOP 织入</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putIntoBucket</span><span class="token punctuation">(</span><span class="token class-name">Apple</span> apple<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"put apple into bucket."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">// 切面类</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token annotation punctuation">@Aspect</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"@args(chapter7.eg6.FruitAspect)"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"this is before around advice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token class-name">Object</span> result <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"this is after around advice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="declareparents-特殊-向目标类添加新的属性和方法"><a class="anchor" href="#declareparents-特殊-向目标类添加新的属性和方法">#</a> @DeclareParents --&gt;[特殊] 向目标类添加新的属性和方法</h4>
<p>在通过 AOP 对代理类进行织入的时候，是比较方便可以进行代理类的操作的</p>
<p>如果想为指定的目标类引入新的属性和方法 可以通过 <code>@DeclareParents</code>  来实现</p>
<blockquote>
<p><code>@DeclareParents</code>  中 需要传入两个值:</p>
<p>@DeclareParents (value =  织入<strong>目标类的全限定名</strong>，defaultImpl = 要织入的方法的<strong>具体实现类</strong>)</p>
<p><strong>使用这个切点表达式，需要定义一个织入方法的接口；和该接口的一个默认实现类</strong></p>
<p>@DeclareParents  对项目中的类做方法添加一般不会用，更适用对第三方引入的 jar 包中的类做方法增强的场景</p>
</blockquote>
<p><strong>示例 :</strong></p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 要织入的接口</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AddFunction</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 要织入接口的默认实现</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AddFunctionImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AddFunction</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----- 执行添加的新方法 ---- "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"im sign"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 切面实例</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Aspect</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AddFunctionAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 目标类 A 中 会织入添加默认实现类的 sing () 方法</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@DeclareParents</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"com.aop.demo.dto.A"</span><span class="token punctuation">,</span> defaultImpl <span class="token operator">=</span> <span class="token class-name">AddFunctionImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">AddFunction</span> addFunction<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addFuncctionTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"AopUtils.isAopProxy(a) = "</span> <span class="token operator">+</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">isAopProxy</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// true</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">Object</span> a <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> method <span class="token operator">:</span> methods<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>          <span class="token comment">//method.getName () = sing 即使是 A 类型 也是有 sing () 方法的</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"method.getName() = "</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token comment">// 测试是可以强转并执行新增方法</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">AddFunction</span> addFunction <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AddFunction</span><span class="token punctuation">)</span> a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">String</span> sing <span class="token operator">=</span> addFunction<span class="token punctuation">.</span><span class="token function">sing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//----- 执行添加的新方法 ---- </span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="perthis和pertarget-特殊-多aop代理类处理"><a class="anchor" href="#perthis和pertarget-特殊-多aop代理类处理">#</a> perthis 和 pertarget --&gt; [特殊] 多 AOP 代理类处理</h4>
<blockquote>
<p>spring 默认会生成一个单例的代理类，在特殊场景下 (例如多线程) 可能会需要和 IOC 类似的多例代理类</p>
<p>此时就需要通过 perthis 和 pertarget 来实现 (都是<strong>使用在切面类的 @Aspect 注解中的，perthis 和 pertarget 中传入节点表达式)</strong></p>
<p>关于这一点 在 @Aspect 的注释中亦有体现:</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Aspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token comment">/**</pre></td></tr><tr><td data-num="5"></td><td><pre>     * @return the per clause expression, defaults to singleton aspect.</pre></td></tr><tr><td data-num="6"></td><td><pre>     * Valid values are "" (singleton), "perthis(...)", etc</pre></td></tr><tr><td data-num="7"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></blockquote>
<p><strong>示例 :</strong></p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 使用 pertarget /perthis 对其中符合切点表达式的类创建多例的代理类</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Aspect</span><span class="token punctuation">(</span><span class="token string">"pertarget(target(com.spring.service.Apple))"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@component</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// !! 注意代理类声明为多例</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span><span class="token string">"prototype"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">public</span> <span class="token class-name">MyAspect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"create MyAspect instance, address: "</span> <span class="token operator">+</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"target(com.spring.service.Apple)"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"this is before around advice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">Object</span> result <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"this is after around advice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>#### 切点表达式组合</p>
<p>可以使用 &amp;&amp;、||、!、三种运算符来组合切点表达式，表示与或非的关系。</p>
<pre><code class="language-JAVA">@Pointcut(&quot;@target(org.springframework.stereotype.Repository)&quot;)
public void repositoryMethods() &#123;&#125;
 
@Pointcut(&quot;execution(* *..create*(Long,..))&quot;)
public void firstLongParamMethods() &#123;&#125;
 
@Pointcut(&quot;repositoryMethods() &amp;&amp; firstLongParamMethods()&quot;)
public void entityCreationMethods() &#123;&#125;
</code></pre>
<h2 id="aop使用的坑"><a class="anchor" href="#aop使用的坑">#</a> AOP 使用的坑</h2>
<h3 id="关于环绕通知null-return-value-问题"><a class="anchor" href="#关于环绕通知null-return-value-问题">#</a> 关于环绕通知 Null return value 问题</h3>
<blockquote>
<p>** 前提: **</p>
<p><strong>1 . AOP 的环绕通知，如果返回值为 void  则 AOP 会返回 null</strong></p>
<p><strong>2 . 被环绕的方法返回值为基本类型，无法接收 null</strong></p>
<p>​      <strong>===&gt; 根本原因：基本类型无法接收可能为 null 的值</strong></p>
</blockquote>
<p>#### 异常的重现</p>
<p>AOP 切面类</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"execution(public * com.aop.demo.service.*.*(..))"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>		<span class="token comment">// 返回值为 Object 类型 return null 时，也会触发异常</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAround</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"=== 进入环绕通知"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">Object</span> result <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"proceed = "</span> <span class="token operator">+</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"=== 环绕通知执行后"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>被环绕目标类</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">division</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===进入有返回值的方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"====="</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token keyword">int</span> c <span class="token operator">=</span>  a <span class="token operator">/</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===返回之前"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" === 返回值 :"</span> <span class="token operator">+</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">return</span> c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"=== 执行方法异常被捕获"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>异常:</p>
<pre><code>org.springframework.aop.AopInvocationException: Null return value from advice does not match primitive return type for: public double com.aop.demo.service.AopService.division(int,int) throws java.lang.Exception

	at org.springframework.aop.framework.CglibAopProxy.processReturnType(CglibAopProxy.java:395)
	at org.springframework.aop.framework.CglibAopProxy.access$000(CglibAopProxy.java:85)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:694)
	at com.aop.demo.service.AopService$$EnhancerBySpringCGLIB$$72c4b668.division(&lt;generated&gt;)
	at com.aop.demo.service.AopServiceTest.division(AopServiceTest.java:30)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:59)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:56)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
	at org.springframework.test.context.junit4.statements.RunBeforeTestExecutionCallbacks.evaluate(RunBeforeTestExecutionCallbacks.java:74)
</code></pre>
<h4 id="问题解决方案"><a class="anchor" href="#问题解决方案">#</a> 问题解决方案</h4>
<ol>
<li>
<p><strong>环绕通知返回值不为 void, 且有返回值情况下不返回 null</strong></p>
</li>
<li>
<p><strong> <code>被增强的方法返回值的声明不使用基本类型,改用包装类型</code> </strong></p>
</li>
</ol>
<h3 id="aop的自调用问题"><a class="anchor" href="#aop的自调用问题">#</a> AOP 的自调用问题</h3>
<blockquote>
<p>调用被 AOP 增强的目标方法时，使用 this 来自我调用 AOP 方法  AOP 不会生效</p>
<p>== &gt; this 实际指向的还是未经 AOP 环绕的原始目标类</p>
<p>!!  <code>spring事务实际上也是通过AOP实现的,如果@Transaction的使用也出现了自调用形式 事务会失效</code></p>
</blockquote>
<h4 id="问题复现"><a class="anchor" href="#问题复现">#</a> 问题复现</h4>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SelfService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selfInvoke</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"AopUtils.isAopProxy(this) = "</span> <span class="token operator">+</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">isAopProxy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token function">talking</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">talking</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">talking</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"==== talking invoke ==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" talking输出 == "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token annotation punctuation">@Aspect</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SelfAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(public * com.aop.demo.service.SelfService.talking(..))"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selfAOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"selfAOP()"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"进入前置通知 == "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="运行结果"><a class="anchor" href="#运行结果">#</a> 运行结果</h4>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">isAopProxy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span> talking invoke <span class="token operator">==</span><span class="token operator">=</span></pre></td></tr><tr><td data-num="3"></td><td><pre> talking输出 <span class="token operator">==</span> 这是个自调用test</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span> talking invoke <span class="token operator">==</span><span class="token operator">=</span></pre></td></tr><tr><td data-num="5"></td><td><pre> talking输出 <span class="token operator">==</span> 这是个自调用test</pre></td></tr></table></figure><p><code>可以看到 自调用时,被环绕的talking方法并没有按照预期的对方法进行增强</code></p>
<h4 id="解决方案"><a class="anchor" href="#解决方案">#</a> 解决方案</h4>
<blockquote>
<p>解决 AOP 自调用问题的核心思想，就是 ** <code>想办法获取到交给IOC容器的代理类</code>  **</p>
</blockquote>
<ol>
<li>
<p><strong> <code>AopContext</code>  暴露当前线程的代理对象</strong></p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//step1  配置允许 spring 暴露代理类 </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>exposeProxy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@SpringBootApplication</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoApplication</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">//step2  通过 AOPContext 获取暴露的代理对象</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token class-name">SelfService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SelfService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"AopUtils.isAopProxy(proxy) = "</span> <span class="token operator">+</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">isAopProxy</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span></pre></td></tr><tr><td data-num="10"></td><td><pre>proxy<span class="token punctuation">.</span><span class="token function">talking</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 此时 通过代理对象调用</span></pre></td></tr></table></figure></li>
<li>
<p><strong>通过初始化方法在目标对象中注入代理对象 ( <code>@PostConstruct</code> )</strong></p>
</li>
</ol>
<blockquote>
<p><strong>@PostConstruct 注解，是由 Java 提供的，它用来修饰一个非静态的 void 方法。</strong></p>
<p><strong>spring 中会在执行完构造方法并注入依赖后执行，并且只运行一次</strong>。</p>
<p>===&gt; 实际上是由 spring 中的 CommonAnnotationBeanPostProcessor , 来实现 @PostConstruct 的方法的</p>
<p>CommonAnnotationBeanPostProcessor 的无参构造方法中，会调用 this.setInitAnnotationType (PostConstruct.class) 来设置 .</p>
<p>它实际上是实现了 BeanPostProcessor 接口，来在 bean 的生命周期中进行后置处理操作。</p>
</blockquote>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 将获取到的代理对象注入回来</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">SelfService</span> selfService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">ApplicationContext</span> context<span class="token punctuation">;</span>    </pre></td></tr><tr><td data-num="6"></td><td><pre>	</pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">// 在完成 IOC 容器的依赖注入之后，将最终的代理类注入回成员变量</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	 <span class="token annotation punctuation">@PostConstruct</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>selfService <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">SelfService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>注: <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC82MmY3NTQ1YTNlMWI=">Spring 的 @PostConstruct 和 Aware 接口实现原理博文</span></p>
<ol start="3">
<li><strong>通过 <code>BeanPostProcessor </code> 在目标对象中注入代理对象</strong></li>
</ol>
<blockquote>
<p>实际上，与方案 2 的解决殊途同归</p>
</blockquote>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 自定义 BeaBPostProcessor</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InjectBeanSelfProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">BeanPostProcessor</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span> bean<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">BeanSelfAware</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 如果 Bean 实现了 BeanSelfAware 标识接口，就将代理对象注入</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanSelfAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSelf</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 即使是 prototype Bean 也可以使用此种方式</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span> bean<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">// 注入代理类的标识接口</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BeanSelfAware</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">setSelf</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxyBean<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">// 调用时解决 AOP 的自调用问题</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SelfService</span> <span class="token keyword">implements</span> <span class="token class-name">BeanSelfAware</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">SelfService</span> selfService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSelf</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxyBean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>selfService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SelfService</span><span class="token punctuation">)</span>proxyBean<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  </pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selfInvoke</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=== selfInvoke ===="</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"AopUtils.isAopProxy(selfService) = "</span> <span class="token operator">+</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">isAopProxy</span><span class="token punctuation">(</span>selfService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        selfService<span class="token punctuation">.</span><span class="token function">talking</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol start="4">
<li><strong>使用 @autowired 注入代理对象</strong></li>
</ol>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SelfService</span>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Lazy</span>  <span class="token comment">// 防止循环依赖问题</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">SelfService</span> selfService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selfInvoke</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=== selfInvoke ===="</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"AopUtils.isAopProxy(selfService) = "</span> <span class="token operator">+</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">isAopProxy</span><span class="token punctuation">(</span>selfService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        selfService<span class="token punctuation">.</span><span class="token function">talking</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="aop实现原理源码浅析"><a class="anchor" href="#aop实现原理源码浅析">#</a> AOP 实现原理 &amp;&amp; 源码浅析</h2>
<h3 id="aop的工作流程"><a class="anchor" href="#aop的工作流程">#</a> AOP 的工作流程</h3>
<blockquote>
<p>AOP 的实现 是依赖于 IOC 容器的，需要等到 IOC 容器启动之后 进行二次操作</p>
</blockquote>
<h4 id="1-ioc容器初始化"><a class="anchor" href="#1-ioc容器初始化">#</a> 1  IOC 容器初始化</h4>
<h4 id="2-从xml或者注解中解析获取aopconfig对象-获取匹配的目标对象"><a class="anchor" href="#2-从xml或者注解中解析获取aopconfig对象-获取匹配的目标对象">#</a> 2 从 xml 或者注解中解析获取 AopConfig 对象 (获取匹配的目标对象)</h4>
<h4 id="3-从ioc中获取目标对象的引用"><a class="anchor" href="#3-从ioc中获取目标对象的引用">#</a> 3 从 IOC 中获取目标对象的引用</h4>
<blockquote>
<p>交给 AopProxyFactory , 调用一个 creteAopProxy 方法</p>
</blockquote>
<h4 id="4-获取方法的拦截器链methodinterceptor"><a class="anchor" href="#4-获取方法的拦截器链methodinterceptor">#</a> 4 获取方法的拦截器链 (MethodInterceptor [] )</h4>
<p><code>在调用方法之前/之后 会先调用方法拦截器</code></p>
<blockquote>
<p>MethodInterceptor, 是由切点转换而来，保存在一个 <code>链表结构(有顺序)</code>  的容器中</p>
<p>调用 AdvisedSupport 的  <code>getInterceptorsAndDynamicInterceptionAdvice</code> ,</p>
<p>获取方法拦截器链并保存到容器</p>
</blockquote>
<h4 id="5-递归执行拦截器"><a class="anchor" href="#5-递归执行拦截器">#</a> 5 递归执行拦截器</h4>
<p>拦截器链为空，使用反射执行目标对象方法；</p>
<p>拦截器链不为空，递归执行链中的拦截器</p>
<p>​		==&gt; 最终链表中的拦截器都执行完之后，执行自身的方法 ( <code>jointPoint.proceed( )</code></p>
<blockquote>
<p>递归执行拦截器链表的优点 :</p>
<p>1  所有拦截器按照递归顺序依次执行，能实现不同通知的优先级顺序</p>
<p>2  调用某个拦截器过程中 出现异常可以阻断递归，</p>
</blockquote>

      <div class="tags">
          <a href="/tags/spring/" rel="tag"><i class="ic i-tag"></i> spring</a>
          <a href="/tags/aop/" rel="tag"><i class="ic i-tag"></i> aop</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2023-03-08 23:35:38" itemprop="dateModified" datetime="2023-03-08T23:35:38+08:00">2023-03-08</time>
  </span>
  <span id="hou-duan/spring/spring-aop-zong-jie/" class="item leancloud_visitors" data-flag-title="Spring AOP 总结" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="别人都叫我老范 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="别人都叫我老范 支付宝">
        <p>支付宝</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="别人都叫我老范 贝宝">
        <p>贝宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>别人都叫我老范 <i class="ic i-at"><em>@</em></i>一位 Blog
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="http://adamshang2333.github.io/hou-duan/spring/spring-aop-zong-jie/" title="Spring AOP 总结">http://adamshang2333.github.io/hou-duan/spring/spring-aop-zong-jie/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/cai-keng-hui-zong/springaop-cai-keng/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;oldFun&#x2F;picGitee&#x2F;raw&#x2F;master&#x2F;img&#x2F;wallhaven-vg7vk8.jpg" title="Spring AOP踩坑">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> spring</span>
  <h3>Spring AOP踩坑</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/hou-duan/spring/springmvc-yuan-ma-qian-xi/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;oldFun&#x2F;picGitee&#x2F;raw&#x2F;master&#x2F;img&#x2F;wallhaven-57wx33.jpg" title="SpringMvc 源码浅析">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> 总结</span>
  <h3>SpringMvc 源码浅析</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#spring-aop-%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93"><span class="toc-number">1.</span> <span class="toc-text"> Spring AOP 知识点总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#aop%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="toc-number">1.1.</span> <span class="toc-text"> AOP 的设计思想</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aop%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.</span> <span class="toc-text"> AOP 的基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E9%9D%A2aspect"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 切面 (Aspect)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E7%82%B9jointpoint"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 连接点 (JointPoint)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E5%85%A5%E7%82%B9pointcut"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 切入点 (PointCut)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5advice"><span class="toc-number">1.2.4.</span> <span class="toc-text"> 通知 (Advice)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87%E5%AF%B9%E8%B1%A1target"><span class="toc-number">1.2.5.</span> <span class="toc-text"> 目标对象 (Target)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#aop%E4%BB%A3%E7%90%86aop-proxy"><span class="toc-number">1.2.6.</span> <span class="toc-text"> AOP 代理 (Aop Proxy)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%87%E5%85%A5"><span class="toc-number">1.2.7.</span> <span class="toc-text"> 织入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aop%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.</span> <span class="toc-text"> AOP 的应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E6%97%A5%E5%BF%97"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 调用日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E5%90%AC"><span class="toc-number">1.3.3.</span> <span class="toc-text"> 监听</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">1.3.4.</span> <span class="toc-text"> 拦截器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">1.3.5.</span> <span class="toc-text"> 调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%99%90"><span class="toc-number">1.3.6.</span> <span class="toc-text"> 权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.3.7.</span> <span class="toc-text"> 事务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aop%E4%B8%AD%E9%80%9A%E7%9F%A5%E7%9A%84%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.4.</span> <span class="toc-text"> AOP 中通知的顺序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 通知的优先级</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%87%E7%82%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.5.</span> <span class="toc-text"> 切点表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E7%82%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A6%82%E5%BF%B5"><span class="toc-number">1.5.1.</span> <span class="toc-text"> 切点表达式概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-piontcut-%E5%92%8Cbefore%E7%AD%89%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8"><span class="toc-number">1.5.1.1.</span> <span class="toc-text"> 1.  @Piontcut 和 @Before 等配合使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-before%E7%AD%89%E6%B3%A8%E8%A7%A3%E7%9A%84values%E4%B8%AD%E7%9B%B4%E6%8E%A5%E5%86%99%E5%88%87%E7%82%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.5.1.2.</span> <span class="toc-text"> 2.  @Before () 等注解的 values 中直接写切点表达式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E7%82%B9%E6%8C%87%E7%A4%BA%E7%AC%A6"><span class="toc-number">1.5.2.</span> <span class="toc-text"> 切点指示符</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%87%E7%82%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E9%80%9A%E9%85%8D%E7%AC%A6"><span class="toc-number">1.5.2.1.</span> <span class="toc-text"> 切点表达式的通配符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#within-%E7%B1%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">1.5.2.2.</span> <span class="toc-text"> within ---&gt; 类级别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#args-%E5%8F%82%E6%95%B0%E7%BA%A7%E5%88%AB"><span class="toc-number">1.5.2.3.</span> <span class="toc-text"> args ---&gt; 参数级别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#this-%E5%92%8C-target-%E7%B1%BB%E7%BA%A7%E5%88%AB%E4%BB%A3%E7%90%86%E7%B1%BB"><span class="toc-number">1.5.2.4.</span> <span class="toc-text"> this 和 target ---&gt; 类级别 (代理类)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#within-%E7%B1%BB%E7%BA%A7%E5%88%AB%E5%85%B3%E6%B3%A8%E7%B1%BB%E4%B8%8A%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.5.2.5.</span> <span class="toc-text"> @within --&gt; 类级别 (关注类上注解)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#annotation-%E6%96%B9%E6%B3%95%E7%BA%A7%E5%88%AB%E5%85%B3%E6%B3%A8%E6%96%B9%E6%B3%95%E4%B8%8A%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.5.2.6.</span> <span class="toc-text"> @annotation --&gt; 方法级别 (关注方法上注解)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#args-%E5%8F%82%E6%95%B0%E7%BA%A7%E5%88%AB%E5%85%B3%E6%B3%A8%E5%8F%82%E6%95%B0%E7%B1%BB%E4%B8%8A%E7%9A%84%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.5.2.7.</span> <span class="toc-text"> @args --&gt; 参数级别 (关注参数类上的注解)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#declareparents-%E7%89%B9%E6%AE%8A-%E5%90%91%E7%9B%AE%E6%A0%87%E7%B1%BB%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.2.8.</span> <span class="toc-text"> @DeclareParents --&gt;[特殊] 向目标类添加新的属性和方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#perthis%E5%92%8Cpertarget-%E7%89%B9%E6%AE%8A-%E5%A4%9Aaop%E4%BB%A3%E7%90%86%E7%B1%BB%E5%A4%84%E7%90%86"><span class="toc-number">1.5.2.9.</span> <span class="toc-text"> perthis 和 pertarget --&gt; [特殊] 多 AOP 代理类处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aop%E4%BD%BF%E7%94%A8%E7%9A%84%E5%9D%91"><span class="toc-number">1.6.</span> <span class="toc-text"> AOP 使用的坑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E7%8E%AF%E7%BB%95%E9%80%9A%E7%9F%A5null-return-value-%E9%97%AE%E9%A2%98"><span class="toc-number">1.6.1.</span> <span class="toc-text"> 关于环绕通知 Null return value 问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.6.1.1.</span> <span class="toc-text"> 问题解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#aop%E7%9A%84%E8%87%AA%E8%B0%83%E7%94%A8%E9%97%AE%E9%A2%98"><span class="toc-number">1.6.2.</span> <span class="toc-text"> AOP 的自调用问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.6.2.1.</span> <span class="toc-text"> 问题复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">1.6.2.2.</span> <span class="toc-text"> 运行结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.6.2.3.</span> <span class="toc-text"> 解决方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aop%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90"><span class="toc-number">1.7.</span> <span class="toc-text"> AOP 实现原理 &amp;&amp; 源码浅析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#aop%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.7.1.</span> <span class="toc-text"> AOP 的工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-ioc%E5%AE%B9%E5%99%A8%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.7.1.1.</span> <span class="toc-text"> 1  IOC 容器初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BB%8Exml%E6%88%96%E8%80%85%E6%B3%A8%E8%A7%A3%E4%B8%AD%E8%A7%A3%E6%9E%90%E8%8E%B7%E5%8F%96aopconfig%E5%AF%B9%E8%B1%A1-%E8%8E%B7%E5%8F%96%E5%8C%B9%E9%85%8D%E7%9A%84%E7%9B%AE%E6%A0%87%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.7.1.2.</span> <span class="toc-text"> 2 从 xml 或者注解中解析获取 AopConfig 对象 (获取匹配的目标对象)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%BB%8Eioc%E4%B8%AD%E8%8E%B7%E5%8F%96%E7%9B%AE%E6%A0%87%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BC%95%E7%94%A8"><span class="toc-number">1.7.1.3.</span> <span class="toc-text"> 3 从 IOC 中获取目标对象的引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%8E%B7%E5%8F%96%E6%96%B9%E6%B3%95%E7%9A%84%E6%8B%A6%E6%88%AA%E5%99%A8%E9%93%BEmethodinterceptor"><span class="toc-number">1.7.1.4.</span> <span class="toc-text"> 4 获取方法的拦截器链 (MethodInterceptor [] )</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E9%80%92%E5%BD%92%E6%89%A7%E8%A1%8C%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">1.7.1.5.</span> <span class="toc-text"> 5 递归执行拦截器</span></a></li></ol></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li class="active"><a href="/hou-duan/spring/spring-aop-zong-jie/" rel="bookmark" title="Spring AOP总结">Spring AOP总结</a></li><li><a href="/hou-duan/spring/springmvc-yuan-ma-qian-xi/" rel="bookmark" title="SpringMvc 源码浅析">SpringMvc 源码浅析</a></li><li><a href="/hou-duan/spring/springboot-zhu-jie/" rel="bookmark" title="Spring Boot注解总结">Spring Boot注解总结</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="别人都叫我老范"
      data-src="/images/%E5%90%90%E8%88%8C.jpeg">
  <p class="name" itemprop="name">别人都叫我老范</p>
  <div class="description" itemprop="description"><div style='font-size: 0.8em;'> I.is (null); <br/>If (U.appear ()) <br/>I.turn (new World ('Fill With Love')) <br/>// 我的世界 <br/>// 直至遇见你 <br/>// 才熠熠生辉 </div> </div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">44</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">17</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">14</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL093bGNpdHkyMzMz" title="https:&#x2F;&#x2F;github.com&#x2F;Owlcity2333"><i class="ic i-github"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTI1MTg0NjMxMw==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;251846313"><i class="ic i-cloud-music"></i></span>
      <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yourname"><i class="ic i-zhihu"></i></span>
      <span class="exturl item weixin" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTI1MTg0NjMxMw==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;251846313"><i class="ic i-weixin"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOjc1OTU0NzkxNkBxcS5jb20=" title="mailto:759547916@qq.com"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>文章</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>

</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/cai-keng-hui-zong/springaop-cai-keng/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/hou-duan/spring/springmvc-yuan-ma-qian-xi/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/hou-duan/spring/springmvc-lan-jie-qi-fang-fa-can-shu-jie-xi-qi/" title="SpringMVC 拦截器&amp;方法参数解析器">SpringMVC 拦截器&方法参数解析器</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/qian-duan/angular/angular-ru-men/" title="Angular入门">Angular入门</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CI-CD/" title="分类于 CI/CD">CI/CD</a>
</div>

    <span><a href="/hou-duan/ci-cd/ci-cd-jenkins/" title="CI_CD&amp;&amp;Jenkins">CI_CD&&Jenkins</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%85%B6%E4%BB%96/" title="分类于 其他">其他</a>
<i class="ic i-angle-right"></i>
<a href="/categories/%E5%85%B6%E4%BB%96/Markdown/" title="分类于 Markdown">Markdown</a>
</div>

    <span><a href="/qi-ta/markdown-yu-fa-zong-jie/" title="Markdown语法">Markdown语法</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/hou-duan/bing-fa-fen-bu-shi/redis-gao-bing-fa-fen-bu-shi-suo/" title="Redis高并发分布式锁">Redis高并发分布式锁</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" title="分类于 数据库">数据库</a>
<i class="ic i-angle-right"></i>
<a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/" title="分类于 mysql">mysql</a>
<i class="ic i-angle-right"></i>
<a href="/categories/hexo/" title="分类于 hexo">hexo</a>
</div>

    <span><a href="/shu-ju-ku/mysql-you-hua-shen-ru/" title="MySQL 深入优化总结">MySQL 深入优化总结</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/shu-ju-ku/shu-ju-ku-ji-chu/" title="数据库基础">数据库基础</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/spring/" title="分类于 spring">spring</a>
<i class="ic i-angle-right"></i>
<a href="/categories/spring/%E6%80%BB%E7%BB%93/" title="分类于 总结">总结</a>
</div>

    <span><a href="/hou-duan/spring/springboot-zhu-jie/" title="Spring Boot注解总结">Spring Boot注解总结</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/MQ/" title="分类于 MQ">MQ</a>
<i class="ic i-angle-right"></i>
<a href="/categories/MQ/%E5%88%86%E5%B8%83%E5%BC%8F/" title="分类于 分布式">分布式</a>
<i class="ic i-angle-right"></i>
<a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" title="分类于 微服务">微服务</a>
</div>

    <span><a href="/hou-duan/zhong-jian-jian/rocketmq-ru-men/" title="RocketMQ">RocketMQ</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/hou-duan/zhong-jian-jian/swagger-shi-yong-wen-dang/" title="swagger使用文档">swagger使用文档</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">别人都叫我老范 @ bit Blog</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">295k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">4:29</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: 'hou-duan/spring/spring-aop-zong-jie/',
    favicon: {
      show: "(^_^) 呦吼~",
      hide: "(´Д｀)哪去了?"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"superSample":2,"width":180,"height":360,"position":"right","hOffset":-20,"vOffset":-15},"log":false,"tagMode":false});</script></body>
</html>
