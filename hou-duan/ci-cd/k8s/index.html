



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="一位Blog" href="http://adamshang2333.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="一位Blog" href="http://adamshang2333.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="一位Blog" href="http://adamshang2333.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="K8s,容器化" />


<link rel="canonical" href="http://adamshang2333.github.io/hou-duan/ci-cd/k8s/">



  <title>
Kubernetes - CI/CD |
bit Blog = 一位 Blog = bit =>byte KB MB GB TB ... 积跬步而行千里</title>
<meta name="generator" content="Hexo 5.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Kubernetes
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2023-03-07 19:23:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2023-03-07T19:23:00+08:00">2023-03-07</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>66k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>1:01</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">bit Blog</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://gitee.com/oldFun/picGitee/raw/master/img/wallhaven-ym1jpg.jpg"></li>
          <li class="item" data-background-image="https://gitee.com/oldFun/picGitee/raw/master/img/wallhaven-57wq75.jpg"></li>
          <li class="item" data-background-image="https://gitee.com/oldFun/picGitee/raw/master/img/wallhaven-xlxdvo.jpg"></li>
          <li class="item" data-background-image="https://gitee.com/oldFun/picGitee/raw/master/img/wallhaven-v9gwyp.jpg"></li>
          <li class="item" data-background-image="https://gitee.com/oldFun/picGitee/raw/master/img/wallhaven-q6wyer.jpg"></li>
          <li class="item" data-background-image="https://gitee.com/oldFun/picGitee/raw/master/img/wallhaven-y88q3g.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CI-CD/" itemprop="item" rel="index" title="分类于 CI/CD"><span itemprop="name">CI/CD</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="http://adamshang2333.github.io/hou-duan/ci-cd/k8s/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/%E5%90%90%E8%88%8C.jpeg">
    <meta itemprop="name" content="别人都叫我老范">
    <meta itemprop="description" content="bit =>byte KB MB GB TB ... 积跬步而行千里, <div style='font-size: 0.8em;'> I.is (null); <br/>If (U.appear ()) <br/>I.turn (new World ('Fill With Love')) <br/>// 我的世界 <br/>// 直至遇见你 <br/>// 才熠熠生辉 </div> ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="一位 Blog">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="一-简介"><a class="anchor" href="#一-简介">#</a> 一。简介</h1>
<h2 id="了解k8s-容器化"><a class="anchor" href="#了解k8s-容器化">#</a> 了解 K8s &amp; 容器化</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvb3ZlcnZpZXcv">Kubernetes</span> 也称为 K8s，是一个可移植、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。 Kubernetes 拥有一个庞大且快速增长的生态，其服务、支持和工具的使用范围相当广泛。</p>
<h3 id="什么是容器"><a class="anchor" href="#什么是容器">#</a> 什么是容器</h3>
<p>容器是一种<strong>沙盒技术</strong>，主要目的是为了将应用运行在其中，与外界隔离；及方便这个沙盒可以被转移到其它宿主机器。本质上，它是一个特殊的进程。通过名称空间（Namespace）、控制组（Control groups）、切根（chroot）技术把资源、文件、设备、状态和配置划分到一个独立的空间。</p>
<p>通俗点的理解就是一个装应用软件的箱子，箱子里面有软件运行所需的依赖库和配置。开发人员可以把这个箱子搬到任何机器上，且不影响里面软件的运行。</p>
<p>此外，需要明确的一个概念是: <strong>容器技术并不等同于 docker</strong>. 容器相关的技术实现，除了 Docker 以外 还有 <code>podman</code> , <code>LXC</code> , <code>  containerd</code> , <code> Buildah</code>  等，它们都能像 docker 一样构建镜像 运行容器.</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2c2VThXN3AwNmRDTzk5ZlEzL2FydGljbGUvZGV0YWlscy8xMjcyOTMzODQ=">参考：除 docker 外的其他容器化工具</span></p>
<h3 id="容器标准"><a class="anchor" href="#容器标准">#</a> 容器标准</h3>
<blockquote>
<p>容器世界里并不是只有 docker 一家。既然不是一家就很容易出现分歧。任何技术出现都需要一个标准来规范它，不然各搞各的很容易导致技术实现的碎片化，出现大量的冲突和冗余。因此，在 2015 年，由 Google，Docker、CoreOS、IBM、微软、红帽等厂商联合发起的 <code>OCI</code> （Open Container  Initiative）组织成立了，并于 2016 年 4 月推出了第一个开放容器标准。标准主要包括 runtime 运行时标准和 image 镜像标准。</p>
</blockquote>
<p><strong>容器运行时标准 （runtime spec）</strong></p>
<ul>
<li>
<p>creating：使用 create 命令创建容器，这个过程称为创建中</p>
</li>
<li>
<p>created：容器创建出来，但是还没有运行，表示镜像和配置没有错误，容器能够运行在当前平台</p>
</li>
<li>
<p>running：容器的运行状态，里面的进程处于 up 状态，正在执行用户设定的任务</p>
</li>
<li>
<p>stopped：容器运行完成，或者运行出错，或者  stop 命令之后，容器处于暂停状态。这个状态，容器还有很多信息保存在平台中，并没有完全被删除</p>
</li>
</ul>
<p><strong>容器镜像标准（image spec）</strong></p>
<ul>
<li>文件系统：以 layer 保存的文件系统，每个 layer 保存了和上层之间变化的部分，layer  应该保存哪些文件，怎么表示增加、修改和删除的文件等；</li>
<li>config 文件：保存了文件系统的层级信息（每个层级的 hash  值，以及历史信息），以及容器运行时需要的一些信息（比如环境变量、工作目录、命令参数、mount  列表），指定了镜像在某个特定平台和系统的配置。比较接近我们使用 docker inspect &lt;image_id&gt; 看到的内容；</li>
<li>manifest 文件：镜像的 config 文件索引，有哪些 layer，额外的 annotation 信息，manifest  文件中保存了很多和当前平台有关的信息；</li>
<li>index 文件：可选的文件，指向不同平台的 manifest  文件，这个文件能保证一个镜像可以跨平台使用，每个平台拥有不同的 manifest 文件，使用 index 作为索引。</li>
</ul>
<h3 id="关于k8s和docker的关系"><a class="anchor" href="#关于k8s和docker的关系">#</a> 关于 K8s 和 Docker 的关系</h3>
<p>K8s 和 docker 关系可以简单用下图实例:</p>
<p><img data-src="https://pic1.zhimg.com/80/v2-3386b7a906cc4ae4bc2750273a4c69ec_1440w.jpg" alt="docker&amp;&amp;k8s" /></p>
<p>其工作流程简单来说是这样的：</p>
<ol>
<li>Docker，Kubernetes 等工具来运行一个容器时会调用容器运行时（CRI）比如 containerd，CRI-O</li>
<li>通过容器运行时来完成容器的创建、运行、销毁等实际工作</li>
</ol>
<ul>
<li>Docker 使用的是 containerd 作为其运行时；Kubernetes 支持 containerd，CRI-O 等多种容器运行时</li>
<li>这些容器运行时都遵循了 OCI 规范，并通过 runc 来实现与操作系统内核交互来完成容器的创建和运行</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80OTA1ODU2ODM=">参考: k8s 和 docker 关系</span></p>
<h2 id="k8s的功能特性"><a class="anchor" href="#k8s的功能特性">#</a> k8s 的功能特性</h2>
<h4 id="自动化上线和回滚"><a class="anchor" href="#自动化上线和回滚">#</a> <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2RlcGxveW1lbnQv">自动化上线和回滚</span></h4>
<p>Kubernetes 会分步骤地将针对应用或其配置的更改上线，同时监视应用程序运行状况以确保你不会同时终止所有实例。如果出现问题，Kubernetes 会为你回滚所作更改。你应该充分利用不断成长的部署方案生态系统。</p>
<h4 id="服务发现与负载均衡"><a class="anchor" href="#服务发现与负载均衡">#</a> <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvc2VydmljZXMtbmV0d29ya2luZy9zZXJ2aWNlLw==">服务发现与负载均衡</span></h4>
<p>无需修改你的应用程序去使用陌生的服务发现机制。Kubernetes 为容器提供了自己的 IP 地址和一个 DNS 名称，并且可以在它们之间实现负载均衡。</p>
<h4 id="自我修复"><a class="anchor" href="#自我修复">#</a> <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL3JlcGxpY2FzZXQvI3JlcGxpY2F0aW9uY29udHJvbGxlci0lRTUlQTYlODIlRTQlQkQlOTUlRTUlQjclQTUlRTQlQkQlOUM=">自我修复</span></h4>
<p>重新启动失败的容器，在节点死亡时替换并重新调度容器， 杀死不响应用户定义的健康检查的容器， 并且在它们准备好服务之前不会将它们公布给客户端。</p>
<h4 id="存储编排"><a class="anchor" href="#存储编排">#</a> <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvc3RvcmFnZS9wZXJzaXN0ZW50LXZvbHVtZXMv">存储编排</span></h4>
<p>自动挂载所选存储系统，包括本地存储、诸如 <span class="exturl" data-url="aHR0cHM6Ly9hd3MuYW1hem9uLmNvbS9wcm9kdWN0cy9zdG9yYWdlLw==">AWS</span> 或 <span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC5nb29nbGUuY29tL3N0b3JhZ2Uv">GCP</span> 之类公有云提供商所提供的存储或者诸如 NFS、iSCSI、Ceph、Cinder 这类网络存储系统。</p>
<h4 id="secret-和配置管理"><a class="anchor" href="#secret-和配置管理">#</a> <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvY29uZmlndXJhdGlvbi9zZWNyZXQv">Secret 和配置管理</span></h4>
<p>部署和更新 Secret 和应用程序的配置而不必重新构建容器镜像， 且不必将软件堆栈配置中的秘密信息暴露出来。</p>
<h4 id="自动装箱"><a class="anchor" href="#自动装箱">#</a> <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvY29uZmlndXJhdGlvbi9tYW5hZ2UtcmVzb3VyY2VzLWNvbnRhaW5lcnMv">自动装箱</span></h4>
<p>根据资源需求和其他限制自动放置容器，同时避免影响可用性。 将关键性的和尽力而为性质的工作负载进行混合放置，以提高资源利用率并节省更多资源。</p>
<h4 id="批量执行"><a class="anchor" href="#批量执行">#</a> <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2pvYi8=">批量执行</span></h4>
<p>除了服务之外，Kubernetes 还可以管理你的批处理和 CI 工作负载，在期望时替换掉失效的容器。</p>
<h4 id="ipv4ipv6-双协议栈"><a class="anchor" href="#ipv4ipv6-双协议栈">#</a> <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvc2VydmljZXMtbmV0d29ya2luZy9kdWFsLXN0YWNrLw==">IPv4/IPv6 双协议栈</span></h4>
<p>为 Pod 和 Service 分配 IPv4 和 IPv6 地址</p>
<h4 id="水平扩缩"><a class="anchor" href="#水平扩缩">#</a> <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvdGFza3MvcnVuLWFwcGxpY2F0aW9uL2hvcml6b250YWwtcG9kLWF1dG9zY2FsZS8=">水平扩缩</span></h4>
<p>使用一个简单的命令、一个 UI 或基于 CPU 使用情况自动对应用程序进行扩缩。</p>
<h4 id="为扩展性设计"><a class="anchor" href="#为扩展性设计">#</a> <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvZXh0ZW5kLWt1YmVybmV0ZXMv">为扩展性设计</span></h4>
<p>无需更改上游源码即可扩展你的 Kubernetes 集群。</p>
<h1 id="二-k8s的集群架构和组件"><a class="anchor" href="#二-k8s的集群架构和组件">#</a> 二.  K8s 的集群架构和组件</h1>
<h2 id="集群架构"><a class="anchor" href="#集群架构">#</a> 集群架构</h2>
<p>一个正常运行的 Kubernetes 集群可以从逻辑上分为两个部分：</p>
<ul>
<li><strong>Control Plane</strong> (控制平面，可集群)
<ul>
<li>负责维护集群的预期状态，例如运行哪个应用以及使用哪个容器镜像</li>
<li>又可以称为主控节点 / Master 节点</li>
</ul>
</li>
<li><strong>Node 集群</strong> (计算设备）
<ul>
<li>负责应用和工作负载的实际运行</li>
<li><strong>每个 Node 节点都有自己的 Linux 环境，可以是物理机也可以是虚拟机。</strong></li>
<li>每个节点都运行由若干容器组成的容器集 (docker containers)</li>
</ul>
</li>
</ul>
<p>K8s 官方架构图:</p>
<p><img data-src="https://d33wubrfki0l68.cloudfront.net/2475489eaf20163ec0f54ddc1d92aa8d4c87c96b/e7c81/images/docs/components-of-kubernetes.svg" alt="" /></p>
<blockquote>
<p>从官方架构图中，可以发现在 Control Plane 中，组件是可以有多个实例的</p>
<blockquote>
<p>上图中除了 etcd 组件外 其它组件都是以集群形式搭建</p>
</blockquote>
</blockquote>
<p>更详细的架构图如下:</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/AdamShang2333/picGo/img/856154-20191023003358108-1816205812.png" alt="" /></p>
<blockquote>
<p>不难发现，Node 节点中是包含了多个 Pod 的，每一个 Pod 单独运行一个 docker 的 container 组</p>
</blockquote>
<h2 id="集群组件"><a class="anchor" href="#集群组件">#</a> 集群组件</h2>
<h3 id="master组件"><a class="anchor" href="#master组件">#</a> Master 组件</h3>
<blockquote>
<p>控制平面组件会为集群做出全局决策，比如资源的调度。 以及检测和响应集群事件，例如当不满足部署的  <code>replicas</code>  字段时， 要启动新的 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL3BvZHMv">pod</span>）。</p>
</blockquote>
<blockquote>
<p>控制平面组件可以在集群中的任何节点上运行。 然而，为了简单起见，设置脚本通常会在同一个计算机上启动所有控制平面组件， 并且不会在此计算机上运行用户容器。</p>
</blockquote>
<h4 id="1-api-kube-apiserver"><a class="anchor" href="#1-api-kube-apiserver">#</a> 1. api (kube-apiserver)</h4>
<p>该组件负责公开了 Kubernetes API，负责处理接受请求的工作。 API 服务器是 Kubernetes 控制平面的前端。</p>
<p>Kubernetes API 服务器的主要实现是 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2NvbW1hbmQtbGluZS10b29scy1yZWZlcmVuY2Uva3ViZS1hcGlzZXJ2ZXIv">kube-apiserver</span>。  <code>kube-apiserver</code>  设计上考虑了水平扩缩，也就是说，它可通过部署多个实例来进行扩缩。 可以通过运行  <code>kube-apiserver</code>  的多个实例，在这些实例之间平衡流量。</p>
<blockquote>
<p>apisever 可以理解为整个 k8s 集群中的统一入口，各组件协调者。是 Master 节点和 Nodes 通信的桥梁</p>
<p>除了集群内部通信会使用到 kube-apiserver, kubectl 和 K8s 的 UI 控制台 也会与 apiserver 通信.</p>
</blockquote>
<h4 id="2-etcd"><a class="anchor" href="#2-etcd">#</a> 2. etcd</h4>
<p>一致且高可用的 <code>分布式键值存储</code> ，主要用途是共享配置和服务发现，保存集群状态数据，比如 Pod、Service 等对象信息。用作 <strong>Kubernetes 所有集群数据的后台数据库。</strong></p>
<p>如果你的 Kubernetes 集群使用 etcd 作为其后台数据库， 请确保你针对这些数据有一份 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvdGFza3MvYWRtaW5pc3Rlci1jbHVzdGVyL2NvbmZpZ3VyZS11cGdyYWRlLWV0Y2QvI2JhY2tpbmctdXAtYW4tZXRjZC1jbHVzdGVy">备份</span>计划。</p>
<blockquote>
<p>etcd 采用了 <code>RAFT</code>  的共识算法 (最终一致算法) 来保证集群的高可用，通过投票选举来完成的节点切换</p>
<p><strong>基于 etcd 的算法，Master 中的 etcd 集群的节点数量，只能是奇数</strong></p>
<ul>
<li>3 个节点 可以保证 1 次高可用；5 节点 2 次；7 节点 3 次...</li>
</ul>
<blockquote>
<p>每一个 Raft 集群都包含多个服务器，在任意时刻，每台服务器只可能处于 <code>Leader</code> ,  <code>Follower</code> ,  <code>Candidate(候选人)</code>  三种状态；<strong>在处于正常的状态时，集群中只会存在一个 Leader, 其余的服务器都是 Follower</strong></p>
</blockquote>
</blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0NTU2NDE0L2FydGljbGUvZGV0YWlscy8xMjU1Njg3Mzk=">图解 etcd 中的 Raft 算法</span></p>
<h4 id="3-kube-scheduler"><a class="anchor" href="#3-kube-scheduler">#</a> 3. kube-scheduler</h4>
<p><code>kube-scheduler</code>  是 K8s 的<strong>调度器，</strong> 负责监视新创建的、未指定运行<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvYXJjaGl0ZWN0dXJlL25vZGVzLw==">节点（node）</span>的 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL3BvZHMv">Pods</span>， 并选择节点来让 Pod 在上面运行。</p>
<p>调度决策考虑的因素包括单个 Pod 及 Pods 集合的资源需求、软硬件及策略约束、 亲和性及反亲和性规范、数据位置、工作负载间的干扰及最后时限。</p>
<h4 id="4-c-m-kube-controller-manager"><a class="anchor" href="#4-c-m-kube-controller-manager">#</a> 4. c-m (kube-controller-manager)</h4>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2NvbW1hbmQtbGluZS10b29scy1yZWZlcmVuY2Uva3ViZS1jb250cm9sbGVyLW1hbmFnZXIv">kube-controller-manager</span> 负责运行<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvYXJjaGl0ZWN0dXJlL2NvbnRyb2xsZXIv"> controller (控制器)</span> 进程。</p>
<blockquote>
<p><code>controller</code>  通过 <code>apiserver</code>  监控集群的公共状态，并致力于将当前状态转变为期望的状态.</p>
<p>Kubernetes 内置一组 <code>controller</code> ，运行在 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2NvbW1hbmQtbGluZS10b29scy1yZWZlcmVuY2Uva3ViZS1jb250cm9sbGVyLW1hbmFnZXIv">kube-controller-manager</span> 内。 这些内置的控制器提供了重要的核心功能，每个控制器管理集群状态的一个特定方面。</p>
</blockquote>
<p>从逻辑上讲， 每个<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvYXJjaGl0ZWN0dXJlL2NvbnRyb2xsZXIv">控制器</span>都是一个单独的进程， 但是为了降低复杂性，它们都被编译到同一个可执行文件，并在同一个进程中运行。</p>
<p>这些控制器包括：</p>
<ul>
<li>节点控制器（Node Controller）：负责在节点出现故障时进行通知和响应</li>
<li>任务控制器（Job Controller）：监测代表一次性任务的 Job 对象，然后创建 Pods 来运行这些任务直至完成</li>
<li>端点分片控制器（EndpointSlice controller）：填充端点分片（EndpointSlice）对象（以提供 Service 和 Pod 之间的链接）。</li>
<li>服务账号控制器（ServiceAccount controller）：为新的命名空间创建默认的服务账号（ServiceAccount）。</li>
</ul>
<h4 id="5-c-c-m-cloud-controller-manager"><a class="anchor" href="#5-c-c-m-cloud-controller-manager">#</a> 5. c-c-m (cloud-controller-manager)</h4>
<p>一个 Kubernetes <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2dsb3NzYXJ5Lz9hbGw9dHJ1ZSN0ZXJtLWNvbnRyb2wtcGxhbmU=">控制平面</span>组件， 嵌入了特定于云平台的控制逻辑。 云控制器管理器（Cloud Controller Manager）允许你将你的集群连接到云提供商的 API 之上， 并将与该云平台交互的组件同与你的集群交互的组件分离开来。</p>
<p><code>cloud-controller-manager</code>  仅运行特定于云平台的控制器。 因此如果你在自己的环境中运行 Kubernetes，或者在本地计算机中运行学习环境， 所部署的集群不需要有云控制器管理器。</p>
<p>与  <code>kube-controller-manager</code>  类似， <code>cloud-controller-manager</code>  将若干逻辑上独立的控制回路组合到同一个可执行文件中， 供你以同一进程的方式运行。 你可以对其执行水平扩容（运行不止一个副本）以提升性能或者增强容错能力。</p>
<p>下面的控制器都包含对云平台驱动的依赖：</p>
<ul>
<li>节点控制器（Node Controller）：用于在节点终止响应后检查云提供商以确定节点是否已被删除</li>
<li>路由控制器（Route Controller）：用于在底层云基础架构中设置路由</li>
<li>服务控制器（Service Controller）：用于创建、更新和删除云提供商负载均衡器</li>
</ul>
<h3 id="node组件"><a class="anchor" href="#node组件">#</a> Node 组件</h3>
<p>节点组件会在每个节点上运行，负责维护运行的 Pod 并提供 Kubernetes 运行环境。</p>
<h4 id="1-kubelet"><a class="anchor" href="#1-kubelet">#</a> 1. kubelet<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvb3ZlcnZpZXcvY29tcG9uZW50cy8ja3ViZWxldA=="> </span></h4>
<p><code>kubelet</code>  会在集群中每个<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvYXJjaGl0ZWN0dXJlL25vZGVzLw==">节点（node）</span>上运行。 它保证<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvb3ZlcnZpZXcvd2hhdC1pcy1rdWJlcm5ldGVzLyN3aHktY29udGFpbmVycw==">容器（containers）</span>都运行在 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL3BvZHMv">Pod</span> 中。</p>
<p>kubelet 接收一组通过各类机制提供给它的 PodSpecs， 确保这些 PodSpecs 中描述的容器处于运行状态且健康。 kubelet 不会管理不是由 Kubernetes 创建的容器。</p>
<blockquote>
<p>kubelet 会监听 <code>api-server</code>  的通知，将 api 指令转换为 OCI 标准 来实现 pod 中 docker 容器的创建；</p>
<p>PodSpec 是描述一个 Pod 的 YAML 或 JSON 对象。</p>
</blockquote>
<h4 id="2-kube-proxy"><a class="anchor" href="#2-kube-proxy">#</a> 2. kube-proxy</h4>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2NvbW1hbmQtbGluZS10b29scy1yZWZlcmVuY2Uva3ViZS1wcm94eS8=">kube-proxy</span> 是集群中每个<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvYXJjaGl0ZWN0dXJlL25vZGVzLw==">节点（node）</span>上所运行的网络代理， 实现 Kubernetes <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvc2VydmljZXMtbmV0d29ya2luZy9zZXJ2aWNlLw==">服务（Service）</span> 概念的一部分。</p>
<p>kube-proxy 维护节点上的一些网络规则， 这些网络规则会允许从集群内部或外部的网络会话与 Pod 进行网络通信。</p>
<p>如果操作系统提供了可用的数据包过滤层，则 kube-proxy 会通过它来实现网络规则。 否则，kube-proxy 仅做流量转发。</p>
<h4 id="3-容器运行时container-runtime"><a class="anchor" href="#3-容器运行时container-runtime">#</a> 3. 容器运行时（Container Runtime）</h4>
<p>容器运行环境是负责运行容器的软件。</p>
<p>Kubernetes 支持许多容器运行环境，例如 <span class="exturl" data-url="aHR0cHM6Ly9jb250YWluZXJkLmlvL2RvY3Mv">containerd</span>、 <span class="exturl" data-url="aHR0cHM6Ly9jcmktby5pby8jd2hhdC1pcy1jcmktbw==">CRI-O</span> 以及 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2t1YmVybmV0ZXMvY29tbXVuaXR5L2Jsb2IvbWFzdGVyL2NvbnRyaWJ1dG9ycy9kZXZlbC9zaWctbm9kZS9jb250YWluZXItcnVudGltZS1pbnRlcmZhY2UubWQ=">Kubernetes CRI (容器运行环境接口)</span> 的其他任何实现。</p>
<h2 id="插件addons"><a class="anchor" href="#插件addons">#</a> 插件（Addons）</h2>
<p>插件使用 Kubernetes 资源（<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2RhZW1vbnNldC8=">DaemonSet</span>、 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2RlcGxveW1lbnQv">Deployment</span> 等）实现集群功能。 因为这些插件提供集群级别的功能，插件中命名空间域的资源属于  <code>kube-system</code>  命名空间。</p>
<p>有关可用插件的完整列表，请参见 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvY2x1c3Rlci1hZG1pbmlzdHJhdGlvbi9hZGRvbnMv">插件（Addons）</span>。</p>
<h3 id="常用的插件"><a class="anchor" href="#常用的插件">#</a> 常用的插件</h3>
<h4 id="coredns"><a class="anchor" href="#coredns">#</a> CoreDNS</h4>
<p>为整个集群提供 DNS 服务。</p>
<p>尽管其他插件都并非严格意义上的必需组件，但几乎所有 Kubernetes 集群都应该有<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvc2VydmljZXMtbmV0d29ya2luZy9kbnMtcG9kLXNlcnZpY2Uv">集群 DNS</span>， 因为很多示例都需要 DNS 服务。</p>
<p>集群 DNS 是一个 DNS 服务器，和环境中的其他 DNS 服务器一起工作，它为 Kubernetes 服务提供 DNS 记录。</p>
<p>Kubernetes 启动的容器自动将此 DNS 服务器包含在其 DNS 搜索列表中。</p>
<h4 id="ingresscontroller"><a class="anchor" href="#ingresscontroller">#</a> ingressController</h4>
<p>为 k8s 中的服务提供外网入口，实现七层网络调度</p>
<h4 id="prometheus"><a class="anchor" href="#prometheus">#</a> Prometheus</h4>
<p>为整个集群提供资源监控能力，其本质是一个时序数据库</p>
<h4 id="dashboard仪表盘"><a class="anchor" href="#dashboard仪表盘">#</a> Dashboard（仪表盘）<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvb3ZlcnZpZXcvY29tcG9uZW50cy8jd2ViLXVpLWRhc2hib2FyZA=="> </span></h4>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvdGFza3MvYWNjZXNzLWFwcGxpY2F0aW9uLWNsdXN0ZXIvd2ViLXVpLWRhc2hib2FyZC8=">Dashboard</span> 是 Kubernetes 集群的通用的、基于 Web 的用户界面。 它使用户可以管理集群中运行的应用程序以及集群本身， 并进行故障排除。</p>
<h4 id="容器资源监控"><a class="anchor" href="#容器资源监控">#</a> 容器资源监控</h4>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvdGFza3MvZGVidWcvZGVidWctY2x1c3Rlci9yZXNvdXJjZS11c2FnZS1tb25pdG9yaW5nLw==">容器资源监控</span> 将关于容器的一些常见的时间序列度量值保存到一个集中的数据库中， 并提供浏览这些数据的界面。</p>
<h4 id="集群层面日志"><a class="anchor" href="#集群层面日志">#</a> 集群层面日志</h4>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvY2x1c3Rlci1hZG1pbmlzdHJhdGlvbi9sb2dnaW5nLw==">集群层面日志</span>机制负责将容器的日志数据保存到一个集中的日志存储中， 这种集中日志存储提供搜索和浏览接口。</p>
<h3 id="rancher"><a class="anchor" href="#rancher">#</a> Rancher</h3>
<p>可以理解为一个 k8s 的超集，Rancher 是一个 Kubernetes 管理工具，让你能在任何地方和任何提供商上部署和运行集群。</p>
<p>Rancher 可以创建来自 Kubernetes 托管服务提供商的集群，创建节点并安装 Kubernetes，或者导入在任何地方运行的现有 Kubernetes 集群。</p>
<p>此外，Rancher 可以为集群和资源提供更精细的监控和告警，将日志发送到外部提供商，并通过应用商店（Application  Catalog）直接集成 Helm。如果你拥有外部 CI/CD 系统，你可以将其与 Rancher 对接。没有的话，你也可以使用 Rancher 提供的 Fleet 自动部署和升级工作负载。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9yYW5jaGVybWFuYWdlci5kb2NzLnJhbmNoZXIuY29tL3poLw==">注:rancher 官方文档</span></p>
<h3 id="federation"><a class="anchor" href="#federation">#</a> Federation</h3>
<p>提供跨可用区的集群，提供不同数据中心的 k8s 集群管理能力.</p>
<h1 id="三-k8s核心概念"><a class="anchor" href="#三-k8s核心概念">#</a> 三.  k8s 核心概念</h1>
<h2 id="k8s对象"><a class="anchor" href="#k8s对象">#</a> K8S 对象</h2>
<h3 id="什么是对象"><a class="anchor" href="#什么是对象">#</a> 什么是对象</h3>
<p>在 Kubernetes 系统中，<strong>Kubernetes 对象</strong> 是持久化的实体。 Kubernetes 使用这些实体去表示集群中各种资源，以及跟踪他们在集群中的状态。 比较特别地是，它们描述了如下信息：</p>
<ul>
<li>哪些容器化应用正在运行（以及在哪些节点上运行）</li>
<li>可以被应用使用的资源</li>
<li>关于应用运行时表现的策略，比如重启策略、升级策略以及容错策略</li>
</ul>
<p>Kubernetes 对象是 “<strong>目标性记录</strong>” —— 一旦创建该对象，Kubernetes 系统将不断工作以确保该对象存在。 <strong>通过创建对象，你就是在告知 Kubernetes 系统，你想要的集群工作负载状态看起来应是什么样子的</strong>， 这就是 Kubernetes 集群所谓的 <strong>期望状态（Desired State）</strong>。</p>
<p>使用命令 <code>kubectl api-resources</code> , 可以列出当前集群中所有的资源定义。</p>
<h3 id="如何描述k8s对象"><a class="anchor" href="#如何描述k8s对象">#</a> 如何描述 k8s 对象</h3>
<p>k8s 可以通过 <code>json</code>  和 <code>yaml</code>  两种格式来描述一个对象资源，但为了可读性和可维护性，通常会使用 yaml 格式。</p>
<p>在常用的 yaml 格式文件中，会通过各种对象字段，来描述对对象的期望状态.</p>
<p>下面是一个 pod 的最简单例子:</p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># simple-pod.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.14.2</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr></table></figure><p>可以看到 Pod 的一级字段，主要分成 5 个部分：</p>
<ol>
<li><code>apiVersion</code> ：api 版本，可以通过 kubectl api-resources 查询，或者直接看 explain 的结果</li>
<li><code>kind</code> ：资源类型，可以通过 kubectl api-resources 查询，或者直接看 explain 的结果</li>
<li><code>metadata</code> ：元信息，比如 name, namespace， label 和 annotation 等</li>
<li><code>spec</code> ：资源的具体配置，比如磁盘、网络、镜像等</li>
<li><code>status</code> ：存储一些正在运行的对象的一些状态信息</li>
</ol>
<h4 id="查询对象配置文件结构"><a class="anchor" href="#查询对象配置文件结构">#</a> 查询对象配置文件结构</h4>
<p>kubectl 提供给我们一个命令 <code>kubectl explain</code>  ，可以输出资源对应的属性字段及定义，它在定义资源配置文件时候非常有用。</p>
<p>这个指令支持查询二级或者更多层级下的字段及定义:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>~   master ●✚  kubectl explain pod</pre></td></tr><tr><td data-num="2"></td><td><pre>KIND:     Pod</pre></td></tr><tr><td data-num="3"></td><td><pre>VERSION:  v1</pre></td></tr><tr><td data-num="4"></td><td><pre>DESCRIPTION:</pre></td></tr><tr><td data-num="5"></td><td><pre>     Pod is a collection of containers that can run on a host. This resource is</pre></td></tr><tr><td data-num="6"></td><td><pre>     created by clients and scheduled onto hosts.</pre></td></tr><tr><td data-num="7"></td><td><pre>FIELDS:</pre></td></tr><tr><td data-num="8"></td><td><pre>   apiVersion	<span class="token operator">&lt;</span>string<span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre>     APIVersion defines the versioned schema of this representation of an</pre></td></tr><tr><td data-num="10"></td><td><pre>     object. Servers should convert recognized schemas to the latest internal</pre></td></tr><tr><td data-num="11"></td><td><pre>     value, and may reject unrecognized values. More info:</pre></td></tr><tr><td data-num="12"></td><td><pre>     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="token comment">#resources</span></pre></td></tr><tr><td data-num="13"></td><td><pre>   kind	<span class="token operator">&lt;</span>string<span class="token operator">></span></pre></td></tr><tr><td data-num="14"></td><td><pre>     Kind is a string value representing the REST resource this object</pre></td></tr><tr><td data-num="15"></td><td><pre>     represents. Servers may infer this from the endpoint the client submits</pre></td></tr><tr><td data-num="16"></td><td><pre>     requests to. Cannot be updated. In CamelCase. More info:</pre></td></tr><tr><td data-num="17"></td><td><pre>     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="token comment">#types-kinds</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   metadata	<span class="token operator">&lt;</span>Object<span class="token operator">></span></pre></td></tr><tr><td data-num="19"></td><td><pre>     Standard object's metadata. More info:</pre></td></tr><tr><td data-num="20"></td><td><pre>     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="token comment">#metadata</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   spec	<span class="token operator">&lt;</span>Object<span class="token operator">></span></pre></td></tr><tr><td data-num="22"></td><td><pre>     Specification of the desired behavior of the pod. More info:</pre></td></tr><tr><td data-num="23"></td><td><pre>     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="token comment">#spec-and-status</span></pre></td></tr><tr><td data-num="24"></td><td><pre>   status	<span class="token operator">&lt;</span>Object<span class="token operator">></span></pre></td></tr><tr><td data-num="25"></td><td><pre>     Most recently observed status of the pod. This data may not be up to date.</pre></td></tr><tr><td data-num="26"></td><td><pre>     Populated by the system. Read-only. More info:</pre></td></tr><tr><td data-num="27"></td><td><pre>     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="token comment">#spec-and-status</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl explain pod.spec</pre></td></tr><tr><td data-num="2"></td><td><pre>KIND:     Pod</pre></td></tr><tr><td data-num="3"></td><td><pre>VERSION:  v1</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>RESOURCE: spec <span class="token operator">&lt;</span>Object<span class="token operator">></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>DESCRIPTION:</pre></td></tr><tr><td data-num="8"></td><td><pre>     Specification of the desired behavior of the pod. More info:</pre></td></tr><tr><td data-num="9"></td><td><pre>     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="token comment">#spec-and-status</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>     PodSpec is a description of a pod.</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>FIELDS:</pre></td></tr><tr><td data-num="14"></td><td><pre>   hostNetwork	<span class="token operator">&lt;</span>boolean<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre>     Host networking requested <span class="token keyword">for</span> this pod. Use the <span class="token function">host</span><span class="token string">'s network namespace.</pre></td></tr><tr><td data-num="16"></td><td><pre>     If this option is set, the ports that will be used must be specified.</pre></td></tr><tr><td data-num="17"></td><td><pre>     Default to false.</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>   hostPID	&lt;boolean></pre></td></tr><tr><td data-num="20"></td><td><pre>     Use the host'</span>s pid namespace. Optional: Default to false.</pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token function">hostname</span>	<span class="token operator">&lt;</span>string<span class="token operator">></span></pre></td></tr><tr><td data-num="23"></td><td><pre>     Specifies the <span class="token function">hostname</span> of the Pod If not specified, the pod's <span class="token function">hostname</span> will</pre></td></tr><tr><td data-num="24"></td><td><pre>     be <span class="token builtin class-name">set</span> to a system-defined value.</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># -required-, 表明 pod 对象的 yaml 中必须指定 containers 字段</span></pre></td></tr><tr><td data-num="26"></td><td><pre>   containers	<span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token operator">></span> -required-</pre></td></tr><tr><td data-num="27"></td><td><pre>     List of containers belonging to the pod. Containers cannot currently be</pre></td></tr><tr><td data-num="28"></td><td><pre>     added or removed. There must be at least one container <span class="token keyword">in</span> a Pod. Cannot be</pre></td></tr><tr><td data-num="29"></td><td><pre>     updated.</pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>   dnsConfig	<span class="token operator">&lt;</span>Object<span class="token operator">></span></pre></td></tr><tr><td data-num="32"></td><td><pre>     Specifies the DNS parameters of a pod. Parameters specified here will be</pre></td></tr><tr><td data-num="33"></td><td><pre>     merged to the generated DNS configuration based on DNSPolicy.</pre></td></tr><tr><td data-num="34"></td><td><pre>		<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>略</pre></td></tr></table></figure><h4 id="常用的对象字段"><a class="anchor" href="#常用的对象字段">#</a> 常用的对象字段</h4>
<p>k8s 中，对象一级字段常见的有五个:<strong>apiVersion</strong>; <strong>kind</strong>; <strong>metadata</strong>; <strong>spec</strong>; <strong>status</strong></p>
<p>以 Deployment 为例:</p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1beta1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.7.9</pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr></table></figure><ul>
<li>
<p>apiVersion  api 版本</p>
</li>
<li>
<p>kind  资源类型</p>
</li>
<li>
<p>metadata 元信息</p>
<ul>
<li>name
<ul>
<li>创建资源时的必需项</li>
<li>创建后无法更改 name 字段值</li>
<li>Name 字段必须在同一 namespace 内是唯一的</li>
</ul>
</li>
<li>namespace
<ul>
<li>不填时默认值为 &quot;default&quot;</li>
<li>命名空间的值必须唯一</li>
</ul>
</li>
<li>labels
<ul>
<li>可用于组织和分类（确定范围和选择）对象的字符串键和值的映射。</li>
</ul>
</li>
<li>annotations
<ul>
<li>非结构化的 kv map, 功能与 java 注解类似，向 pod 中的工作负载提供可以自定义元数据的能力</li>
</ul>
</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2t1YmVybmV0ZXMtYXBpL2NvbW1vbi1kZWZpbml0aW9ucy9vYmplY3QtbWV0YS8=">注：官网参考</span></p>
</li>
<li>
<p>spec 资源具体配置</p>
<blockquote>
<p>对于具有  <code>spec</code>  的对象，你必须在创建对象时设置其内容，描述你希望对象所具有的特征： <strong>期望状态（Desired State）</strong>。</p>
<p>spec 的字段值，根据使用的对象不同，在规约上各有不同的要求.</p>
</blockquote>
<p>Pod</p>
<ul>
<li>
<p><strong>containers</strong> (<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2t1YmVybmV0ZXMtYXBpL3dvcmtsb2FkLXJlc291cmNlcy9wb2QtdjEvI0NvbnRhaW5lcg==">Container[]</span>)，必需</p>
<ul>
<li>
<p><strong>name</strong> (string)，必需</p>
</li>
<li>
<p><strong>image</strong> (string)</p>
<p>镜像名称，此字段是可选的，以允许更高层的配置管理进行默认设置或覆盖工作负载控制器（如 Deployment 和 StatefulSets） 中的容器镜像。</p>
</li>
<li>
<p><strong>imagePullPolicy</strong> (string)</p>
<p>镜像拉取策略。 <code>&quot;Always&quot;</code> 、 <code>&quot;Never&quot;</code> 、 <code>&quot;IfNotPresent&quot;</code>  之一。如果指定了  <code>:latest</code>  标签，则默认为  <code>&quot;Always&quot;</code> ， 否则默认为  <code>&quot;IfNotPresent&quot;</code> 。</p>
</li>
</ul>
</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2t1YmVybmV0ZXMtYXBpL3dvcmtsb2FkLXJlc291cmNlcy9wb2QtdjEv">参考: k8s Api - 工作负载 - pod</span></p>
<p>Deployment</p>
<ul>
<li>
<p><strong>selector</strong> (<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2t1YmVybmV0ZXMtYXBpL2NvbW1vbi1kZWZpbml0aW9ucy9sYWJlbC1zZWxlY3Rvci8jTGFiZWxTZWxlY3Rvcg==">LabelSelector</span>)，必需</p>
<ul>
<li>供 Pod 所用的标签选择算符。通过此字段选择现有 ReplicaSet 的 Pod 集合， 被选中的 ReplicaSet 将受到这个 Deployment 的影响。此字段必须与 Pod 模板的标签匹配。</li>
</ul>
</li>
<li>
<p><strong>template</strong> (<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2t1YmVybmV0ZXMtYXBpL3dvcmtsb2FkLXJlc291cmNlcy9wb2QtdGVtcGxhdGUtdjEvI1BvZFRlbXBsYXRlU3BlYw==">PodTemplateSpec</span>)，必需</p>
<ul>
<li>template 描述将要创建的 Pod。</li>
</ul>
</li>
<li>
<p><strong>replicas</strong></p>
<ul>
<li>预期 Pod 的数量。这是一个指针，用于辨别显式零和未指定的值。默认为 1。</li>
</ul>
</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2t1YmVybmV0ZXMtYXBpL3dvcmtsb2FkLXJlc291cmNlcy9kZXBsb3ltZW50LXYxLw==">参考: k8s Api - 工作负载 - deployment</span></p>
</li>
<li>
<p>status 对象状态</p>
<blockquote>
<p><code>status</code>  描述了正在运行的对象的<strong>当前状态（Current State）</strong>，它是由 Kubernetes 系统和组件设置并更新的</p>
</blockquote>
</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2t1YmVybmV0ZXMtYXBpL3dvcmtsb2FkLXJlc291cmNlcy8=">注：工作负载的字段参考</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2t1YmVybmV0ZXMtYXBpL3NlcnZpY2UtcmVzb3VyY2VzLw==">注:service 资源的字段参考</span></p>
<h3 id="如何创建k8s对象"><a class="anchor" href="#如何创建k8s对象">#</a> 如何创建 k8s 对象</h3>
<p>创建一个资源对象的方式有好多种，从调用方式上可以分为两种：</p>
<ul>
<li>调用 HTTP 接口：用于上层业务的开发</li>
<li>调用 client 命令：即 kubectl 命令行工具</li>
</ul>
<p>目前对于刚学习的新手来说，kubectl 是熟悉各种资源对象最好的工具.</p>
<p>使用了 kubectl，创建资源对象，又可以分为两种：</p>
<ul>
<li><code>kubectl apply</code>  (推荐)</li>
<li><code>kubectl create</code></li>
</ul>
<p>这两种有什么区别呢？</p>
<p><strong>kubectl create 是命令式 API</strong>，体现的是我要怎么样（创建）？</p>
<p>对于同一个 pod.yaml create 多次是会报错的，原因是 <strong>k8s 中资源名称必须是唯一的</strong>，而该名称的 pod 资源已经创建过了。</p>
<p><img data-src="http://image.iswbm.com/image-20220117224832316.png" alt="http://image.iswbm.com/image-20220117224832316.png" /></p>
<p><strong>kubectl apply 是声明式 API</strong>，体现的是我要什么样？</p>
<p>对于同一个 pod.yaml apply 完全没有任何问题，若第二次 apply 之前，修改了 pod 中的一些内容，也会更新上去。</p>
<p><img data-src="http://image.iswbm.com/image-20220117225254152.png" alt="http://image.iswbm.com/image-20220117225254152.png" /></p>
<h2 id="pod"><a class="anchor" href="#pod">#</a> Pod</h2>
<h3 id="简介"><a class="anchor" href="#简介">#</a> 简介</h3>
<p><strong>Pod</strong> 是在 Kubernetes 中可以创建和管理的、<strong>最小的可部署的计算单元</strong>。Pod 所建模的是特定于应用的 “<strong>逻辑主机</strong>”，其中包含一个或多个应用容器， 这些容器相对紧密地耦合在一起。(<em>如果它们紧耦合并且需要共享磁盘等资源，这些容器应在一个 Pod 中编排。</em>)</p>
<p><img data-src="https://d33wubrfki0l68.cloudfront.net/fe03f68d8ede9815184852ca2a4fd30325e5d15a/98064/docs/tutorials/kubernetes-basics/public/images/module_03_pods.svg" alt="pod示意图" /></p>
<blockquote>
<p>Pod --&gt; 逻辑主机</p>
<p>Nod --&gt; 物理主机 (虚拟机或服务器)</p>
</blockquote>
<p>在 Kubernetes 中，无论你的负载是由单个组件还是由多个一同工作的组件构成， 你都可以在一组 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods"><strong>Pod</strong></a> 中运行它。 在 Kubernetes 中，Pod 类似于<mark>共享网络资源，namespace 并共享文件系统卷的一组容器</mark>，由一个或多个 <span class="exturl" data-url="aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/cT1jb250YWluZXImYW1wO3NwbT0xMDAxLjIxMDEuMzAwMS43MDIw">container</span> 组成，代表的是集群上处于运行状态的一组 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvb3ZlcnZpZXcvd2hhdC1pcy1rdWJlcm5ldGVzLyN3aHktY29udGFpbmVycw==">容器</span> 的集合。<strong>(pod 中的一组 container, 并不局限于同一种镜像 可以是多种镜像的组合)</strong></p>
<p>Pod 的共享上下文包括一组 Linux 名字空间、控制组（cgroup）和可能一些其他的隔离方面， 即用来隔离<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvb3ZlcnZpZXcvd2hhdC1pcy1rdWJlcm5ldGVzLyN3aHktY29udGFpbmVycw==">容器</span>的技术。 在 Pod 的上下文中，每个独立的应用可能会进一步实施隔离。</p>
<blockquote>
<p>在 k8s 中，一切资源对象的调度都是为了用来支撑或扩展 pod 对象的，比如控制器对象是用来管控 Pod 对象的，Service 或者 Ingress 资源对象是用来暴露 Pod 引用对象的，PersistentVolume 资源对象是用来为 Pod 提供存储等等，k8s 不会直接处理容器，而是 Pod</p>
</blockquote>
<h3 id="pod的创建流程"><a class="anchor" href="#pod的创建流程">#</a> pod 的创建流程</h3>
<p>示意图:</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/AdamShang2333/picGo/img/20230312192631.png" alt="创建流程图" /></p>
<h3 id="pause容器"><a class="anchor" href="#pause容器">#</a> pause 容器</h3>
<p>api-server 将创建 pod 的指令下发给 kubelet 时，kubelet 会先创建一个容器 <code>pause</code> ,  无论 pod 想创建的目标容器是什么.</p>
<p><strong>pod 中，pause 容器是第一个被创建出来的</strong>，它的作用是:</p>
<ul>
<li>
<p>挂载网络卷</p>
<ul>
<li>如果 pod 中的容器间需要共享数据，那么就需要依赖于 pause 完成 volume 的挂载和共享</li>
</ul>
</li>
<li>
<p>初始化网络栈</p>
<ul>
<li>创建 veth</li>
<li>veth 连接至网桥</li>
</ul>
</li>
</ul>
<p>pause 容器的网络共享示意:</p>
<p><img data-src="http://image.iswbm.com/image-20220129125243265.png" alt="pause网络共享" /></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/AdamShang2333/picGo/img/20230310123818.png" alt="" /></p>
<blockquote>
<p>没有 pause 容器，那么 A 和 B 要共享网络，要不就是 A 加入 B 的 network namespace，要嘛就是 B 加入 A 的 network namespace， 而无论是谁加入谁，只要 network 的 owner 退出了，该 Pod 里的所有其他容器网络都会立马异常，这显然是不合理的。</p>
<p>反过来，由于 pause 里只有是挂起一个容器，里面没有任何复杂的逻辑，只要不主动杀掉 Pod，pause 都会一直存活，这样一来就能保证在 Pod 运行期间同一 Pod 里的容器网络的稳定。</p>
<p>我们在同一 Pod 里所有容器里看到的网络视图，都是完全一样的，包括网络设备、IP 地址、Mac 地址等等，因为他们其实全是同一份，而这一份都来自于 Pod 第一次创建的这个 Infra container。</p>
<p>由于所有的应用容器都要依赖于 pause 容器，因此在 Pod 启动时，它总是创建的第一个容器，可以说 Pod 的生命周期就是 pause 容器的生命周期。</p>
</blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9rOHMuaXN3Ym0uY29tL2MwMi9wMDJfbGVhcm4ta3ViZXJuZXRlcy1wb2QtdmlhLXBhdXNlLWNvbnRhaW5lci5odG1s">参考：从 Pause 容器理解 Pod 的本质</span></p>
<h2 id="node"><a class="anchor" href="#node">#</a> Node</h2>
<p>Node 是 Pod 真正运行的主机，可以是物理机，也可以是虚拟机。为了管理 Pod，每个 Node 节点上至少要运行 container runtime（比如 docker 或者 rkt）、 <code>kubelet</code>  和  <code>kube-proxy</code>  服务。</p>
<p><img data-src="https://static.sitestack.cn/projects/feiskyer-kubernetes-handbook-202005/introduction/media/node.png" alt="node" /></p>
<h3 id="节点名称唯一性"><a class="anchor" href="#节点名称唯一性">#</a> 节点名称唯一性</h3>
<p>节点的<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvb3ZlcnZpZXcvd29ya2luZy13aXRoLW9iamVjdHMvbmFtZXMjbmFtZXM=">名称</span>用来标识 Node 对象。 没有两个 Node 可以同时使用相同的名称。 Kubernetes 还假定名字相同的资源是同一个对象。 就 Node 而言，隐式假定使用相同名称的实例会具有相同的状态（例如网络配置、根磁盘内容） 和类似节点标签这类属性。这可能在节点被更改但其名称未变时导致系统状态不一致。 如果某个 Node 需要被替换或者大量变更，需要从 API 服务器移除现有的 Node 对象， 之后再在更新之后重新将其加入。</p>
<h2 id="namespace"><a class="anchor" href="#namespace">#</a> Namespace</h2>
<p>Namespace  是对一组资源和对象的抽象集合，比如可以用来将系统内部的对象划分为不同的项目组或用户组。</p>
<blockquote>
<p>通俗一点理解，Namespace 可以支持 K8s 创建多个虚拟集群</p>
</blockquote>
<p>常见的 pods, services,  replication controllers 和 deployments 等都是属于某一个 namespace 的（默认是  default），而 node, persistentVolumes 等则不属于任何 namespace。</p>
<h2 id="label"><a class="anchor" href="#label">#</a> Label</h2>
<p>Label 是识别 Kubernetes 对象的标签，以 key/value 的方式附加到对象上（key 最长不能超过 63 字节，value 可以为空，也可以是不超过 253 字节的字符串）。</p>
<p>Label 不提供唯一性，并且实际上经常是很多对象（如 Pods）都使用相同的 label 来标志具体的应用。</p>
<p>Label 定义好后其他对象可以使用 Label Selector 来选择一组相同 label 的对象（比如 ReplicaSet 和 Service 用 label 来选择一组 Pod）。Label Selector 支持以下几种方式：</p>
<ul>
<li>等式，如  <code>app=nginx</code>  和  <code>env!=production</code></li>
<li>集合，如  <code>env in (production, qa)</code></li>
<li>多个 label（它们之间是 AND 关系），如  <code>app=nginx,env=test</code></li>
</ul>
<h2 id="annotations"><a class="anchor" href="#annotations">#</a> Annotations</h2>
<p>Annotations 是 key/value 形式附加于对象的注解。不同于 Labels 用于标志和选择对象，Annotations  则是用来记录一些附加信息，用来辅助应用部署、安全策略以及调度策略等。比如 deployment 使用 annotations 来记录  rolling update 的状态。</p>
<h2 id="controller"><a class="anchor" href="#controller">#</a> controller</h2>
<h3 id="什么是controller"><a class="anchor" href="#什么是controller">#</a> 什么是 controller</h3>
<p>Kubernetes 中 conroller (控制器) 通过监控<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2dsb3NzYXJ5Lz9hbGw9dHJ1ZSN0ZXJtLWNsdXN0ZXI=">集群</span> 的公共状态，并<strong>致力于将当前状态转变为期望的状态</strong>。</p>
<p>K8s 内建了很多 controller（资源控制器），这些相当于一个状态机，用来控制 Pod 的具体状态和行为</p>
<h3 id="控制器种类"><a class="anchor" href="#控制器种类">#</a> 控制器种类</h3>
<ul>
<li><strong>ReplicationController (RC) 和 ReplicaSet (RS)</strong></li>
<li><strong>Deployment</strong></li>
<li><strong>DaemonSet</strong></li>
<li><strong>StateFulSet</strong></li>
<li><strong>Job/CronJob</strong></li>
<li><strong>Horizontal Pod Autoscaling</strong></li>
</ul>
<h3 id="控制器分类"><a class="anchor" href="#控制器分类">#</a> 控制器分类</h3>
<p>根据控制器的使用场景，可以分类如下:</p>
<h4 id="无状态应用"><a class="anchor" href="#无状态应用">#</a> 无状态应用</h4>
<h5 id="通用型"><a class="anchor" href="#通用型">#</a> 通用型</h5>
<p>​	RC: 副本数量与期望值之间的管理</p>
<p>​	RS: 功能类似 RC, 多了集合式的标签选择器</p>
<p>​	Deployment: 支持滚动更新以及回滚</p>
<h5 id="特殊场景"><a class="anchor" href="#特殊场景">#</a> 特殊场景</h5>
<p>批处理任务 (目标数成功退出)</p>
<ul>
<li>Job: 保障任务一次或多次的成功</li>
<li>CornJob: 在轮询计划下定期执行 Job 实现批处理任务的运行</li>
</ul>
<p>每个节点有且只有一个 pod</p>
<p>​	DaemonSet</p>
<p>自动水平扩缩容</p>
<p>​	HPA (依赖于 RC/RS/Deployment)</p>
<h4 id="有状态应用"><a class="anchor" href="#有状态应用">#</a> 有状态应用</h4>
<p>​	StatefulSet</p>
<h4 id="自定义控制器"><a class="anchor" href="#自定义控制器">#</a> 自定义控制器</h4>
<h4 id="支持基于集合需求的资源"><a class="anchor" href="#支持基于集合需求的资源">#</a> 支持基于集合需求的资源</h4>
<p>比较新的资源，例如 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/job/"> <code>Job</code> </a>、 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/"> <code>Deployment</code> </a>、 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/replicaset/"> <code>ReplicaSet</code> </a> 和 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/daemonset/"> <code>DaemonSet</code> </a>， 也支持<strong>基于集合的</strong>需求。</p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">component</span><span class="token punctuation">:</span> redis</pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> tier<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>cache<span class="token punctuation">]</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> environment<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> NotIn<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>dev<span class="token punctuation">]</span> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>matchLabels</code>  是由  <code>&#123;key,value&#125;</code>  对组成的映射。  <code>matchLabels</code>  映射中的单个  <code>&#123;key,value&#125;</code>  等同于  <code>matchExpressions</code>  的元素， 其  <code>key</code>  字段为 &quot;key&quot;， <code>operator</code>  为 &quot;In&quot;，而  <code>values</code>  数组仅包含 &quot;value&quot;。  <code>matchExpressions</code>  是 Pod 选择算符需求的列表。 有效的运算符包括  <code>In</code> 、 <code>NotIn</code> 、 <code>Exists</code>  和  <code>DoesNotExist</code> 。 在  <code>In</code>  和  <code>NotIn</code>  的情况下，设置的值必须是非空的。 来自  <code>matchLabels</code>  和  <code>matchExpressions</code>  的所有要求都按逻辑与的关系组合到一起 -- 它们必须都满足才能匹配。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvb3ZlcnZpZXcvd29ya2luZy13aXRoLW9iamVjdHMvbGFiZWxzLyNtb3RpdmF0aW9u">参考:k8s 的标签 &amp; 选择符</span></p>
<hr />
<h3 id="rc-rs"><a class="anchor" href="#rc-rs">#</a> RC / RS</h3>
<p><strong>RC</strong> (ReplicationController) 用来确保容器应用的副本数始终保持在用户定义的副本数，即如果有容器异常退出，会自动创建新的 Pod 来替代；而如果异常多出来的容器也会自动回收；</p>
<p>** 在新版本的 Kubernetes 中建议使用 RC (ReplicaSet) 来取代 RC **。ReplicaSet 跟 ReplicationController 没有本质的不同，只是名字不一样，并且<mark> ReplicaSet 支持集合式的 selector</mark>；</p>
<blockquote>
<p>RS 特性:</p>
<p><strong>一个 ReplicaSet 中可以包含异质的 Pod 集合</strong></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL3JlcGxpY2FzZXQvI25vbi10ZW1wbGF0ZS1wb2QtYWNxdWlzaXRpb25z">注：RS 的异质 pod</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL3JlcGxpY2FzZXQvI25vbi10ZW1wbGF0ZS1wb2QtYWNxdWlzaXRpb25z">注：RS 的异质 pod</span></p>
</blockquote>
<blockquote>
<p>RS 虽然可独立使用，但是现在一般还是建议使用 Deployment 来自动管理 RS</p>
<p>----&gt; <strong>RS 不支持滚动更新和回滚机制</strong>，但 Deployment 支持</p>
</blockquote>
<h3 id="deployment"><a class="anchor" href="#deployment">#</a> Deployment</h3>
<p>Deployment 为<span class="exturl" data-url="aHR0cDovL2RvY3Mua3ViZXJuZXRlcy5vcmcuY24vMzEyLmh0bWw="> Pod</span> 和<span class="exturl" data-url="aHR0cDovL2RvY3Mua3ViZXJuZXRlcy5vcmcuY24vMzE0Lmh0bWw="> Replica Set</span>（升级版的 <span class="exturl" data-url="aHR0cDovL2RvY3Mua3ViZXJuZXRlcy5vcmcuY24vNDM3Lmh0bWw=">Replication Controller</span>）提供声明式更新。</p>
<p>你只需要在 Deployment 中描述您想要的目标状态是什么，Deployment controller 就会帮您将 Pod  和 ReplicaSet 的实际状态改变到您的目标状态。您可以定义一个全新的 Deployment 来创建 ReplicaSet 或者删除已有的  Deployment 并创建一个新的来替换。</p>
<p>以下是 Deployments 的典型用例：</p>
<ul>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2RlcGxveW1lbnQvI2NyZWF0aW5nLWEtZGVwbG95bWVudA==">创建 Deployment 以将 ReplicaSet 上线</span>。ReplicaSet 在后台创建 Pod。 检查 ReplicaSet 的上线状态，查看其是否成功。</p>
</li>
<li>
<p>通过更新 Deployment 的 PodTemplateSpec，<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2RlcGxveW1lbnQvI3VwZGF0aW5nLWEtZGVwbG95bWVudA==">声明 Pod 的新状态</span> 。 新的 ReplicaSet 会被创建，Deployment 以受控速率将 Pod 从旧 ReplicaSet 迁移到新 ReplicaSet。 每个新的 ReplicaSet 都会更新 Deployment 的修订版本。</p>
</li>
<li>
<p>如果 Deployment 的当前状态不稳定，<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2RlcGxveW1lbnQvI3JvbGxpbmctYmFjay1hLWRlcGxveW1lbnQ=">回滚到较早的 Deployment 版本</span>。 每次回滚都会更新 Deployment 的修订版本。</p>
</li>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2RlcGxveW1lbnQvI3NjYWxpbmctYS1kZXBsb3ltZW50">扩大 Deployment 规模以承担更多负载</span>。</p>
</li>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2RlcGxveW1lbnQvI3BhdXNpbmctYW5kLXJlc3VtaW5nLWEtZGVwbG95bWVudA==">暂停 Deployment 的上线</span> 以应用对 PodTemplateSpec 所作的多项修改， 然后恢复其执行以启动新的上线版本。</p>
</li>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2RlcGxveW1lbnQvI2RlcGxveW1lbnQtc3RhdHVz">使用 Deployment 状态</span>来判定上线过程是否出现停滞。</p>
</li>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2RlcGxveW1lbnQvI2NsZWFuLXVwLXBvbGljeQ==">清理较旧的不再需要的 ReplicaSet</span> 。</p>
</li>
</ul>
<blockquote>
<p>Deployment 如何实现滚动更新和回滚:</p>
<ol>
<li>
<p>Deployment 会自动创建出来 RS 资源，根据 pod 的 <code>template</code> , <code>replicas</code>  等 逐个创建出符合预期的 pod 资源.</p>
</li>
<li>
<p>需要滚动更新时，Deployment 会创建新的 RS, 并根据 pod 的 <code>template</code>  描述 逐个创建新版本的 pod, 并逐个删除旧版本 RS 中的 pod, 来实现滚动更新</p>
</li>
<li>
<p>需要滚动回滚时，与上述类似 Deployment 中旧版本的 RS 会逐步创建旧版本 pod; 新版本的 RS 逐步删除新版本的 pod, 最终实现滚动回滚</p>
</li>
</ol>
</blockquote>
<h3 id="statefulset"><a class="anchor" href="#statefulset">#</a> <strong>StatefulSet</strong></h3>
<p>StatefulSet 作为 Controller 为 Pod 提供唯一的标识。它可以保证部署和 scale 的顺序</p>
<p>StatefulSet 是为了解决有状态服务的问题（对应 Deployments 和 ReplicaSets 是为无状态服务而设计），其应用场景包括：</p>
<ul>
<li>稳定的持久化存储，即 Pod 重新调度后还是能访问到相同的持久化数据，基于 PVC 来实现</li>
<li>稳定的网络标志，即 Pod 重新调度后其 PodName 和 HostName 不变，基于 Headless Service（即没有 Cluster IP 的 Service）来实现</li>
<li>有序部署，有序扩展，即 Pod 是有顺序的，在部署或者扩展的时候要依据定义的顺序依次依次进行（即从 0 到 N-1，在下一个 Pod 运行之前所有之前的 Pod 必须都是 Running 和 Ready 状态），基于 init containers 来实现</li>
<li>有序收缩，有序删除（即从 N-1 到 0）</li>
</ul>
<h3 id="daemonset"><a class="anchor" href="#daemonset">#</a> DaemonSet</h3>
<p><em>DaemonSet</em> 确保全部（或者一些）Node 上<strong>运行一个 Pod 的副本</strong>。当有 Node 加入集群时，也会为他们新增一个 Pod 。当有 Node 从集群移除时，这些 Pod 也会被回收。删除 DaemonSet 将会删除它创建的所有 Pod</p>
<blockquote>
<p>简单来说，DaemonSet 就是为了保证 &quot;<strong> 每个 Node 上，有且只有一个 pod</strong>&quot;</p>
</blockquote>
<p>使用 DaemonSet 的一些典型用法：</p>
<ul>
<li>运行集群存储 daemon，例如在每个 Node 上运行  <code>glusterd</code> 、 <code>ceph</code></li>
<li>在每个 Node 上运行日志收集 daemon，例如 <code>ELK</code> 、 <code>fluentd</code> 、 <code>logstash</code></li>
<li>在每个 Node 上运行监控 daemon，例如 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Byb21ldGhldXMvbm9kZV9leHBvcnRlcg==">Prometheus Node Exporter</span>、 <code>collectd</code> 、Datadog 代理、New Relic 代理，或 Ganglia  <code>gmond</code></li>
</ul>
<h3 id="job"><a class="anchor" href="#job">#</a> Job</h3>
<p>Job 负责批处理任务，即仅执行一次的任务，它保证批处理任务的一个或多个 Pod 成功结束</p>
<p>Job 会创建一个或者多个 Pod，并将继续重试 Pod 的执行，直到指定数量的 Pod 成功终止。 随着 Pod 成功结束，Job 跟踪记录成功完成的 Pod 个数。 当数量达到指定的成功个数阈值时，任务（即 Job）结束。 删除 Job 的操作会清除所创建的全部 Pod。 挂起 Job 的操作会删除 Job 的所有活跃 Pod，直到 Job 被再次恢复执行。</p>
<p>适合以 Job 形式来运行的任务主要有三种：</p>
<ol>
<li>非并行 Job：
<ul>
<li>通常只启动一个 Pod，除非该 Pod 失败。</li>
<li>当 Pod 成功终止时，立即视 Job 为完成状态。</li>
</ul>
</li>
<li>具有<strong>确定完成计数</strong>的并行 Job：
<ul>
<li><code>.spec.completions</code>  字段设置为非 0 的正数值。</li>
<li>Job 用来代表整个任务，当成功的 Pod 个数达到  <code>.spec.completions</code>  时，Job 被视为完成。</li>
<li>当使用  <code>.spec.completionMode=&quot;Indexed&quot;</code>  时，每个 Pod 都会获得一个不同的 索引值，介于 0 和  <code>.spec.completions-1</code>  之间。</li>
</ul>
</li>
<li>带<strong>工作队列</strong>的并行 Job：
<ul>
<li>不设置  <code>spec.completions</code> ，默认值为  <code>.spec.parallelism</code> 。</li>
<li>多个 Pod 之间必须相互协调，或者借助外部服务确定每个 Pod 要处理哪个工作条目。 例如，任一 Pod 都可以从工作队列中取走最多 N 个工作条目。</li>
<li>每个 Pod 都可以独立确定是否其它 Pod 都已完成，进而确定 Job 是否完成。</li>
<li>当 Job 中<strong>任何</strong> Pod 成功终止，不再创建新 Pod。</li>
<li>一旦至少 1 个 Pod 成功完成，并且所有 Pod 都已终止，即可宣告 Job 成功完成。</li>
<li>一旦任何 Pod 成功退出，任何其它 Pod 都不应再对此任务执行任何操作或生成任何输出。 所有 Pod 都应启动退出过程。</li>
</ul>
</li>
</ol>
<h3 id="cronjob"><a class="anchor" href="#cronjob">#</a> <strong>CronJob</strong></h3>
<p><em>Cron Job</em> 管理基于时间间隔重复调度的 Job，即：</p>
<ul>
<li>在给定时间点只运行一次</li>
<li>周期性地在给定时间点运行</li>
</ul>
<p>使用前提条件：当前使用的 Kubernetes 集群，版本 &gt;= 1.8（对 CronJob）。对于先前版本的集群，版本 &lt; 1.8，启动 API Server 时，通过传递选项  <code>--runtime-config=batch/v2alpha1=true</code>  可以开启 batch/v2alpha1 API</p>
<p>典型的用法如下所示：</p>
<ul>
<li>在给定的时间点调度 Job 运行</li>
<li>创建周期性运行的 Job，例如：数据库备份、发送邮件</li>
</ul>
<h3 id="hpa"><a class="anchor" href="#hpa">#</a> <strong>HPA</strong></h3>
<p>应用的资源使用率通常都有高峰和低谷的时候，如何削峰填谷，提高集群的整体资源利用率，让 service 中的 Pod 个数自动调整呢？这就有赖于 HPA （Horizontal Pod Autoscaling）了，顾名思义，<strong>使 Pod 水平自动缩放</strong></p>
<p>HPA 会根据 Pod 资源的使用情况，来自动调整副本数量，它依赖于 RC/RS/Deployment 之上.</p>
<p>====&gt; 需要明确的一点是: <strong>HPA 本身没有创建 销毁 pod 的能力</strong></p>
<blockquote>
<p>HPA 需要设置监控指标阈值，和扩缩的限定值</p>
<p>例如: cpu 使用率 80%; 最小 pod 数: 2 ; 最大 pod 数: 20</p>
<p>那么 :</p>
<ul>
<li>当 pod 的 cpu 使用率超过 80% 时  HPA 会自动增加 pod 数量 (最大不超过 20 个 pod), 来应对负载上升；</li>
<li>当负载减少，并且 Pod 的数量高于配置的最小值时，HPA 会指示工作负载资源（Deployment、StatefulSet 或其他类似资源）缩减</li>
</ul>
</blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvdGFza3MvcnVuLWFwcGxpY2F0aW9uL2hvcml6b250YWwtcG9kLWF1dG9zY2FsZS8=">参考:k8s 文档 - HPA</span></p>
<h3 id="k8s中的水平扩缩和垂直扩缩"><a class="anchor" href="#k8s中的水平扩缩和垂直扩缩">#</a> K8s 中的水平扩缩和垂直扩缩</h3>
<p>水平扩缩：对增加的负载的响应是部署更多的 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL3BvZHMv">Pod</span>。</p>
<p>垂直扩缩：将更多资源（例如：内存或 CPU）分配给已经为工作负载运行的 Pod。</p>
<h2 id="service"><a class="anchor" href="#service">#</a> Service</h2>
<h3 id="功能"><a class="anchor" href="#功能">#</a> 功能</h3>
<p>Service 是应用服务的抽象，通过 labels 为应用提供负载均衡和服务发现。匹配 labels 的 Pod IP 和端口列表组成 <code>endpoints</code>  (被选中的 Pod 叫做 Service 的 endPoints)，由 kube-proxy 负责将服务 IP 负载均衡到这些 endpoints 上。</p>
<p>每个 Service 都会自动分配一个 cluster IP（<strong>仅在集群内部可访问的虚拟地址</strong>）和 DNS 名，其他容器可以通过该地址或 DNS 来访问服务，而不需要了解后端容器的运行。</p>
<p><img data-src="https://static.sitestack.cn/projects/feiskyer-kubernetes-handbook-202005/introduction/media/14731220608865.png" alt="Kubernetes 基本概念 - 图3" /></p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token key atrule">selector</span><span class="token punctuation">:</span>    </pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token key atrule">app</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token key atrule">ports</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8078</span> <span class="token comment"># The port that will be exposed by this service.    </span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token comment"># The name of this port within the service. This must be a DNS_LABEL.</span></pre></td></tr><tr><td data-num="11"></td><td><pre>		<span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>  <span class="token comment"># Number or name of the port to access on the pods targeted by the service   </span></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP  <span class="token comment">#The IP protocol for this port. Supports "TCP", "UDP", and "SCTP". Default is TCP.</span></pre></td></tr></table></figure><h3 id="service的公开方式"><a class="anchor" href="#service的公开方式">#</a> service 的公开方式</h3>
<p>Kubernetes Service 在 <code>spec.type</code>  允许指定一个需要的类型的 Service，默认是 ClusterIP 类型。</p>
<p>Type 的取值以及行为如下：</p>
<ul>
<li>
<p><strong>ClusterIP</strong>：通过集群的内部 IP 暴露服务，选择该值，服务只能够在集群内部使用 <code>&lt;ClusterIP&gt;:&lt;port&gt;</code>  方式访问，这也是<strong>默认的 ServiceType</strong>。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/AdamShang2333/picGo/img/20230312192436.png" alt="" /></p>
</li>
<li>
<p><strong>NodePort</strong>：通过每个 Node 上的 IP  和静态端口（NodePort）暴露服务。NodePort 服务会路由到 ClusterIP 服务，这个 ClusterIP 服务会自动创建。通过请求  <code>&lt;NodeIP&gt;:&lt;NodePort&gt;</code> ，可以从集群的外部访问一个 NodePort 服务。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/AdamShang2333/picGo/img/20230312192504.png" alt="" /></p>
<blockquote>
<p>NodePort 类型的 Service 是向集群外暴露服务的最原始方式，也是最好让人理解的。优点是简单，好理解，通过 IP + 端口的方式就能访问，不过它的缺点也很明显。</p>
<ul>
<li>每向外暴露一个服务都要占用所有 Node 的一个端口，如果多了难以管理。</li>
<li>NodePort 的端口区间固定，只能使用 30000–32767 间的端口。</li>
<li>如果 Node 的 IP 发生改变，负载均衡代理需要跟着改后端端点 IP 才行。</li>
</ul>
</blockquote>
</li>
<li>
<p><strong>LoadBalancer</strong>：使用云提供商的负载局衡器，可以向外部暴露服务。外部的负载均衡器可以路由到 NodePort 服务和 ClusterIP 服务。</p>
</li>
<li>
<p><strong>ExternalName</strong>：通过返回 CNAME 和它的值，可以将服务映射到 externalName 字段的内容（例如， <span class="exturl" data-url="aHR0cDovL2Zvby5iYXIuZXhhbXBsZS5jb20=">foo.bar.example.com</span>）。 没有任何类型代理被创建，这只有 Kubernetes 1.7 或更高版本的 kube-dns 才支持。</p>
</li>
</ul>
<h2 id="ingress"><a class="anchor" href="#ingress">#</a> ingress</h2>
<p>Ingress 是对集群中服务的外部访问进行管理的 API 对象，典型的访问方式是 HTTP。可以提供负载均衡、SSL 终结和基于名称的虚拟托管。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvcmVmZXJlbmNlL2dlbmVyYXRlZC9rdWJlcm5ldGVzLWFwaS92MS4yNi8jaW5ncmVzcy12MS1uZXR3b3JraW5nLWs4cy1pbw==">Ingress</span> 公开从集群外部到集群内<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvc2VydmljZXMtbmV0d29ya2luZy9zZXJ2aWNlLw==">服务</span>的 HTTP 和 HTTPS 路由。 流量路由由 Ingress 资源上定义的规则控制。</p>
<blockquote>
<p>Ingress 在 K8s 集群里的角色是给 Service 充当反向代理。它可以位于多个 Service 的前端，给这些 Service 充当 “智能路由” 或者集群的入口点。</p>
</blockquote>
<p>下面是一个将流量根据路由规则发送不同 Service 的 Ingress 示例：</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/AdamShang2333/picGo/img/20230312192329.png" alt="ingress-diagram" /></p>
<p>Ingress 可为 Service 提供外部可访问的 URL、负载均衡流量、终止 SSL/TLS，以及基于名称的虚拟托管。 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvc2VydmljZXMtbmV0d29ya2luZy9pbmdyZXNzLWNvbnRyb2xsZXJz">Ingress 控制器</span> 通常负责通过负载均衡器来实现 Ingress，尽管它也可以配置边缘路由器或其他前端来帮助处理流量。</p>
<p>Ingress 不会公开任意端口或协议。 将 HTTP 和 HTTPS 以外的服务公开到 Internet 时，通常使用 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvc2VydmljZXMtbmV0d29ya2luZy9zZXJ2aWNlLyN0eXBlLW5vZGVwb3J0">Service.Type=NodePort</span> 或 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvc2VydmljZXMtbmV0d29ya2luZy9zZXJ2aWNlLyNsb2FkYmFsYW5jZXI=">Service.Type=LoadBalancer</span> 类型的 Service。</p>
<blockquote>
<p>使用 Ingress 对象前需要先安装 Ingress-Controller, 像阿里云、亚马逊 AWS 他们的 K8s 企业服务都会提供自己的 Controller ，对于自己搭建的集群，通常使用 nginx-ingress 作为控制器，它使用 NGINX 服务器作为反向代理，访问 Ingress 的流量按规则路由给集群内部的 Service。</p>
</blockquote>
<h1 id="四-k8s的集群网络"><a class="anchor" href="#四-k8s的集群网络">#</a> 四.  k8s 的集群网络</h1>
<h2 id="kubernetes-网络模型"><a class="anchor" href="#kubernetes-网络模型">#</a> Kubernetes 网络模型</h2>
<p>集群中每一个 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/"> <code>Pod</code> </a> 都会获得自己的、 独一无二的 IP 地址， 这就意味着你不需要显式地在  <code>Pod</code>  之间创建链接，你几乎不需要处理容器端口到主机端口之间的映射。 这将形成一个干净的、向后兼容的模型；在这个模型里，从端口分配、命名、服务发现、 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvc2VydmljZXMtbmV0d29ya2luZy9pbmdyZXNzLyNsb2FkLWJhbGFuY2luZw==">负载均衡</span>、 应用配置和迁移的角度来看， <code>Pod</code>  可以被视作虚拟机或者物理主机。</p>
<p>Kubernetes 强制要求所有网络设施都满足以下基本要求（从而排除了有意隔离网络的策略）：</p>
<ul>
<li>Pod 能够与所有其他<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvY29uY2VwdHMvYXJjaGl0ZWN0dXJlL25vZGVzLw==">节点</span>上的 Pod 通信， 且不需要网络地址转译（NAT）</li>
<li>节点上的代理（比如：系统守护进程、kubelet）可以和节点上的所有 Pod 通信</li>
</ul>
<h2 id="k8s网络要解决的问题"><a class="anchor" href="#k8s网络要解决的问题">#</a> k8s 网络要解决的问题</h2>
<p>Kubernetes 网络主要需要解决以下方面的问题：</p>
<ul>
<li>
<p>同 pod, 不同容器间的网络通信</p>
<ul>
<li>同 pod 下，利用 pause 容器和 localhost IO 通信解决
<ul>
<li>所有容器来共享 pause 容器的网络，组成一个子网，通信时直接使用 loopback 回环接口</li>
</ul>
</li>
</ul>
</li>
<li>
<p>不同 Pod 间通信</p>
<ul>
<li>同物理机
<ul>
<li>Docker0 网桥实现报文转发</li>
<li>不同 pod 部署到同一物理机上，需要借助 k8s 的调度器 (利用亲和性等)</li>
</ul>
</li>
<li>不同物理机
<ul>
<li>利用 Flannel (UDP 连接 数据包二次封装) 等技术 实现扁平化网络</li>
</ul>
</li>
</ul>
<p>基于 Flannel 实现 K8s 的不同物理机 Pod 间通信:</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/AdamShang2333/picGo/img/20230313112820.png" alt="Flannel实现网络模型" /></p>
</li>
<li>
<p>Pod 与 Service 间通信</p>
</li>
<li>
<p>外部与 service 间通信</p>
</li>
</ul>
<h2 id="如何实现-kubernetes-的网络模型"><a class="anchor" href="#如何实现-kubernetes-的网络模型">#</a> 如何实现 Kubernetes 的网络模型</h2>
<p>网络模型由每个节点上的容器运行时实现。最常见的容器运行时使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NvbnRhaW5lcm5ldHdvcmtpbmcvY25p">Container Network Interface</span> (CNI) 插件来管理其网络和安全功能。 许多不同的 CNI 插件来自于许多不同的供应商。其中一些仅提供添加和删除网络接口的基本功能， 而另一些则提供更复杂的解决方案，例如与其他容器编排系统集成、运行多个 CNI 插件、高级 IPAM 功能等。</p>
<p>以下是几个较为流行的三方工具:</p>
<ol>
<li>Flannel—— 一种为 k8s 设计的开源网络结构。Flannel 通过每个主机上的二进制代理运行。该代理将子网租用分配给主机并使用 etcd 来存储配置数据。</li>
<li>Project Calico—— 一个开源网络供应商和政策引擎。Calico 使您能够创建一个可扩展的网络解决方案来连接 k8s pod。它还使您能够在主机网络或服务网格层上实施安全策略。</li>
<li>Weave Net — 一种专有网络工具包，可用于创建虚拟网络。Weave Net 包括弹性、可扩展性、安全性、多播网络和服务发现等功能。它基于去中心化架构，不需要任何外部配置服务或存储</li>
</ol>
<h1 id="五-k8s-集群搭建"><a class="anchor" href="#五-k8s-集群搭建">#</a> 五.  K8S 集群搭建</h1>
<h2 id="搭建基础要求"><a class="anchor" href="#搭建基础要求">#</a> 搭建基础要求</h2>
<p>K8S 集群搭建时，对硬件设施有些建议的要求:</p>
<ol>
<li>建议安装单网卡机器</li>
<li>CPU 数量 ≥ 2</li>
<li>内存建议 3G 以上</li>
<li>存储 100G 以上 (镜像 &amp; 数据等)</li>
</ol>
<p>部署流程参考:</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9rOHMuaXN3Ym0uY29tL2MwMS9wMDFfZGVwb2x5LWt1YmVybmV0ZXMtY2x1c3Rlci13aXRoLWt1YmVsZXQuaHRtbCNpZDk=">图解 k8s - 基于 ubuntu 部署最新版 k8s 集群 (推荐)</span></p>
<p><span class="exturl" data-url="aHR0cDovL3d3dy5qdW55YW8udGVjaC9wb3N0cy8yMWY2Nzc4MC5odG1s">k8s v1.25.4&amp; containerd 部署 (推荐)</span></p>
<p><span class="exturl" data-url="aHR0cDovL2RvY3Mua3ViZXJuZXRlcy5vcmcuY24vNDU5Lmh0bWw=">k8s 中文社区文档 (推荐)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3M/X19iaXo9TXpVME9URTRNell6TXc9PSZhbXA7bWlkPTIyNDc1NTAxODUmYW1wO2lkeD0yJmFtcDtzbj02Mjg2ZGIzMzNkZTk3Yjk5NTg0MzAxOTU2YTMzOWUzYSZhbXA7Y2hrc209ZmJiMThkMTdjY2M2MDQwMWIyMzJlOWViYjU0ZWIyOTcwMTI5Y2FhMDU5NWM0NTRmNDM1NmY2ZWUyOWY4N2E2YjYzYWRjOWI5N2FmMCZhbXA7c2NlbmU9Mjc=">详解 K8S 高可用部署          </span></p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/xiaowangzai/5167661"><strong>跨云厂商公网 IP 搭建 k8s 集群</strong></a></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9rOHMuZWFzeWRvYy5uZXQvZG9jcy9kUmlRanlUWS8yODM2Njg0NS82R2lOT3p5Wi9uZDd5T3ZkWQ==">k8s 社区文档</span></p>
<h2 id="系统初始化准备"><a class="anchor" href="#系统初始化准备">#</a> 系统初始化准备</h2>
<h3 id="设置系统主机名以及-host-文件的相互解析"><a class="anchor" href="#设置系统主机名以及-host-文件的相互解析">#</a> 设置系统主机名以及 Host 文件的相互解析</h3>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>hostnamectl  set-hostname  k8s-master01</pre></td></tr><tr><td data-num="2"></td><td><pre>hostnamectl  set-hostname  k8s-node01</pre></td></tr><tr><td data-num="3"></td><td><pre>hostnamectl  set-hostname  k8s-node02</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">vim</span> /etc/hosts</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">172.16</span>.32.2 node1</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">172.16</span>.32.6 node2</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">172.16</span>.0.4 master</pre></td></tr></table></figure><h3 id="安装依赖包"><a class="anchor" href="#安装依赖包">#</a> 安装依赖包</h3>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> yum <span class="token function">install</span> -y conntrack ntpdate ntp ipvsadm ipset  iptables <span class="token function">curl</span> sysstat libseccomp <span class="token function">wget</span>  <span class="token function">vim</span> net-tools <span class="token function">git</span></pre></td></tr></table></figure><h3 id="设置防火墙为-iptables-并设置空规则"><a class="anchor" href="#设置防火墙为-iptables-并设置空规则">#</a> 设置防火墙为 Iptables 并设置空规则</h3>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> systemctl  stop firewalld  <span class="token operator">&amp;&amp;</span>  systemctl  disable firewalld</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> yum -y <span class="token function">install</span> iptables-services  <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> systemctl  start iptables  <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> systemctl  <span class="token builtin class-name">enable</span> iptables  <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> iptables -F  <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">service</span> iptables save</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># iptables -F 清空规则</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># service iptables save 保存空规则</span></pre></td></tr></table></figure><h3 id="关闭-selinux"><a class="anchor" href="#关闭-selinux">#</a> 关闭 SELINUX</h3>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 在旧版的 k8s 中 kubelet 都要求关闭 swapoff ，但最新版的 kubelet 其实已经支持 swap ，因此这一步其实可以不做。</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> swapoff -a <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'/ swap / s/^\(.*\)$/#<span class="token entity" title="\1">\1</span>/g'</span> /etc/fstab</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#  sed [options] 'command' file (s);  逐行替换符合正则 ^SELINUX=.* 的内容为 SELINUX=disabled</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># sudo setenforce 0 &amp;&amp; sudo sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 所有节点关闭 SELinux</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">sudo</span> setenforce <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">sed</span> -i --follow-symlinks <span class="token string">'s/SELINUX=enforcing/SELINUX=disabled/g'</span> /etc/sysconfig/selinux</pre></td></tr></table></figure><h3 id="调整系统时区"><a class="anchor" href="#调整系统时区">#</a> 调整系统时区</h3>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 使用阿里云校准时间</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> ntpdate -u ntp1.aliyun.com</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 设置系统时区为 中国 / 上海</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">sudo</span> timedatectl set-timezone Asia/Shanghai</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 将当前的 UTC 时间写入硬件时钟</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">sudo</span> timedatectl set-local-rtc <span class="token number">0</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 重启依赖于系统时间的服务</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">sudo</span> systemctl restart rsyslog </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token function">sudo</span> systemctl restart crond</pre></td></tr></table></figure><h3 id="关闭系统不需要服务非必须"><a class="anchor" href="#关闭系统不需要服务非必须">#</a> 关闭系统不需要服务 (非必须)</h3>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 关闭邮件服务，减少不必要的资源消耗</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> systemctl stop postfix <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> systemctl disable postfix</pre></td></tr></table></figure><h3 id="装容器-containerd所有节点"><a class="anchor" href="#装容器-containerd所有节点">#</a> 装容器 containerd（所有节点）</h3>
<ul>
<li>
<p>安装 containerd</p>
<pre><code>sudo yum install -y yum-utils
sudo yum-config-manager \才
--add-repo \
https://download.docker.com/linux/centos/docker-ce.repo

# 或

wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo


sudo yum install containerd.io -y

systemctl enable containerd
systemctl start containerd
</code></pre>
</li>
<li>
<p>配置 containerd，修改 sandbox_image 镜像源</p>
<blockquote>
<p>不提前修改 sandbox_image, 在 kubelet init 容器时 会报错找不到 k8s 官方 pause 镜像</p>
</blockquote>
<pre><code># 导出默认配置，config.toml这个文件默认是不存在的
containerd config default &gt; /etc/containerd/config.toml

# 修改前检查
grep sandbox_image  /etc/containerd/config.toml

# 修改sandbox_image 镜像源，1.24以下k8s.gcr.io 、1.25 改成了registry.k8s.io
sed -i &quot;s#registry.k8s.io/pause#registry.aliyuncs.com/google_containers/pause#g&quot; /etc/containerd/config.toml

# 修改后检查
grep sandbox_image  /etc/containerd/config.toml
</code></pre>
</li>
<li>
<p>配置 containerd cgroup 驱动程序 systemd</p>
<blockquote>
<p>kubernets 自ｖ1.24.0 后，就不再使用 docker.shim，替换采用 containerd 作为容器运行时端点</p>
</blockquote>
<pre><code># 把SystemdCgroup = false修改为：SystemdCgroup = true，
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
</code></pre>
</li>
<li>
<p>Containerd 配置镜像加速<br />
 endpoint 位置添加阿里云的镜像源</p>
<blockquote>
<p>防止 containerd 在部署 Flannel 等操作时 下载镜像失败问题</p>
</blockquote>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">vim</span> /etc/containerd/config.toml</pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.registry<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span class="token string">"docker.io"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>          endpoint <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"https://xxxxxxxx.mirror.aliyuncs.com"</span> ,<span class="token string">"https://registry-1.docker.io"</span><span class="token punctuation">]</span></pre></td></tr></table></figure></li>
<li>
<p>重启 containerd</p>
<pre><code>systemctl daemon-reload
systemctl enable --now containerd
systemctl restart containerd
</code></pre>
</li>
</ul>
<h3 id="配置-k8s-yum-源所有节点"><a class="anchor" href="#配置-k8s-yum-源所有节点">#</a> 配置 k8s yum 源（所有节点）</h3>
<pre><code>cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF
[k8s]
name=k8s
enabled=1
gpgcheck=0
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
EOF
</code></pre>
<h3 id="调整内核参数对于-k8s非必须"><a class="anchor" href="#调整内核参数对于-k8s非必须">#</a> 调整内核参数，对于 K8S (非必须)</h3>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 下面的三个参数是必须的，其他可以不设置</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 在 ipv4 的网络下，所有经过网桥的流量都必须要经过防火墙处理 </span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># net.bridge.bridge-nf-call-iptables=1</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 在 ipv6 的网络下，所有经过网桥的流量都必须要经过防火墙处理 </span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># net.bridge.bridge-nf-call-ip6tables=1</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 数据包转发</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># net.ipv4.ip_forward=1</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 在当前目录下创建并写入 kubernetes.conf</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token function">sudo</span> <span class="token function">cat</span> <span class="token operator">></span> kubernetes.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF</pre></td></tr><tr><td data-num="12"></td><td><pre>net.bridge.bridge-nf-call-iptables=1</pre></td></tr><tr><td data-num="13"></td><td><pre>net.bridge.bridge-nf-call-ip6tables=1</pre></td></tr><tr><td data-num="14"></td><td><pre>net.ipv4.ip_forward=1</pre></td></tr><tr><td data-num="15"></td><td><pre>#net.ipv4.tcp_tw_recycle=0</pre></td></tr><tr><td data-num="16"></td><td><pre>#vm.swappiness=0 # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它</pre></td></tr><tr><td data-num="17"></td><td><pre>#vm.overcommit_memory=1 # 不检查物理内存是否够用</pre></td></tr><tr><td data-num="18"></td><td><pre>#vm.panic_on_oom=0 # 开启 OOM	</pre></td></tr><tr><td data-num="19"></td><td><pre>#fs.inotify.max_user_instances=8192</pre></td></tr><tr><td data-num="20"></td><td><pre>#fs.inotify.max_user_watches=1048576</pre></td></tr><tr><td data-num="21"></td><td><pre>#fs.file-max=52706963</pre></td></tr><tr><td data-num="22"></td><td><pre>#fs.nr_open=52706963</pre></td></tr><tr><td data-num="23"></td><td><pre>#net.ipv6.conf.all.disable_ipv6=1</pre></td></tr><tr><td data-num="24"></td><td><pre>#net.netfilter.nf_conntrack_max=2310720</pre></td></tr><tr><td data-num="25"></td><td><pre>EOF</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 将配置文件拷贝至指定目录 (重启时依然生效)</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token function">sudo</span> <span class="token function">cp</span> kubernetes.conf  /etc/sysctl.d/kubernetes.conf</pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># 刷新配置 (当前即时生效)</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token function">sudo</span> sysctl -p /etc/sysctl.d/kubernetes.conf</pre></td></tr></table></figure><h3 id="设置系统日志优化非必须"><a class="anchor" href="#设置系统日志优化非必须">#</a> 设置系统日志优化 (非必须)</h3>
<p>不使用 rsyslogd , 只使用 systemd journald 收集日志</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">mkdir</span> /var/log/journal <span class="token comment"># 持久化保存日志的目录</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> <span class="token function">mkdir</span> /etc/systemd/journald.conf.d</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">cat</span> <span class="token operator">></span> /etc/systemd/journald.conf.d/99-prophet.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF</pre></td></tr><tr><td data-num="4"></td><td><pre>[Journal]</pre></td></tr><tr><td data-num="5"></td><td><pre># 持久化保存到磁盘</pre></td></tr><tr><td data-num="6"></td><td><pre>Storage=persistent</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre># 压缩历史日志</pre></td></tr><tr><td data-num="9"></td><td><pre>Compress=yes</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>SyncIntervalSec=5m</pre></td></tr><tr><td data-num="12"></td><td><pre>RateLimitInterval=30s</pre></td></tr><tr><td data-num="13"></td><td><pre>RateLimitBurst=1000</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre># 最大占用空间 10G</pre></td></tr><tr><td data-num="16"></td><td><pre>SystemMaxUse=10G</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre># 单日志文件最大 200M</pre></td></tr><tr><td data-num="19"></td><td><pre>SystemMaxFileSize=200M</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre># 日志保存时间 2 周</pre></td></tr><tr><td data-num="22"></td><td><pre>MaxRetentionSec=2week</pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre># 不将日志转发到 syslog</pre></td></tr><tr><td data-num="25"></td><td><pre>ForwardToSyslog=no</pre></td></tr><tr><td data-num="26"></td><td><pre>EOF</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token function">sudo</span> systemctl restart systemd-journald</pre></td></tr></table></figure><h3 id="升级系统内核为-444非必须"><a class="anchor" href="#升级系统内核为-444非必须">#</a> 升级系统内核为 4.44 (非必须)</h3>
<p>&lt;u&gt;CentOS 7.x 系统自带的 3.10.x 内核存在一些 Bugs，导致运行的 Docker、Kubernetes 不稳定，例如： rpm -Uvh <span class="exturl" data-url="aHR0cDovL3d3dy5lbHJlcG8ub3JnL2VscmVwby1yZWxlYXNlLTcuMC0zLmVsNy5lbHJlcG8ubm9hcmNoLnJwbQ==">http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span>&lt;/u&gt;</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">rpm</span> -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 安装完成后检查 /boot/grub2/grub.cfg 中对应内核 menuentry 中是否包含 initrd16 配置，如果没有，再安装一次！</span></pre></td></tr><tr><td data-num="3"></td><td><pre>yum --enablerepo<span class="token operator">=</span>elrepo-kernel <span class="token function">install</span> -y kernel-lt</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 查看内核版本</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">sudo</span> <span class="token function">cat</span> /boot/grub2/grub.cfg <span class="token operator">|</span> <span class="token function">grep</span> .x86_64.img</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 设置开机从新内核启动</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># '4.4.189-1.el7.elrepo.x86_64' 这个版本由上面的 cat 命令查看得到</span></pre></td></tr><tr><td data-num="8"></td><td><pre>grub2-set-default <span class="token string">'CentOS Linux (4.4.189-1.el7.elrepo.x86_64) 7 (Core)'</span></pre></td></tr></table></figure><h3 id="kube-proxy开启ipvs准备"><a class="anchor" href="#kube-proxy开启ipvs准备">#</a> kube-proxy 开启 ipvs 准备</h3>
<h4 id="开启ipvs的前置条件"><a class="anchor" href="#开启ipvs的前置条件">#</a> 开启 ipvs 的前置条件</h4>
<p>在 K8S 中，kube-proxy 可以使用 ipvs 和 iptable 模式，而 K8S 底层使用 ipvs 时 是存在降级机制:<br />
 如果系统中有 IPVS 运行，那么就使用系统的 ipvs 实现对应负载均衡；<br />
 如果系统中没有 ipvs 运行，那么会降级成 iptable 实现对应负载均衡</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sdXplamlhLmJsb2cuY3Nkbi5uZXQvYXJ0aWNsZS9kZXRhaWxzLzEyNzMzMzM2OD9zcG09MTAwMS4yMTAxLjMwMDEuNjY1MC4zJmFtcDt1dG1fbWVkaXVtPWRpc3RyaWJ1dGUucGNfcmVsZXZhbnQubm9uZS10YXNrLWJsb2ctMiU3RWRlZmF1bHQlN0VDVFJMSVNUJTdFUmF0ZS0zLTEyNzMzMzM2OC1ibG9nLTExMDMwODQ1Ni5wY19yZWxldmFudF8zbW90aG5fc3RyYXRlZ3lfcmVjb3ZlcnkmYW1wO2RlcHRoXzEtdXRtX3NvdXJjZT1kaXN0cmlidXRlLnBjX3JlbGV2YW50Lm5vbmUtdGFzay1ibG9nLTIlN0VkZWZhdWx0JTdFQ1RSTElTVCU3RVJhdGUtMy0xMjczMzMzNjgtYmxvZy0xMTAzMDg0NTYucGNfcmVsZXZhbnRfM21vdGhuX3N0cmF0ZWd5X3JlY292ZXJ5JmFtcDt1dG1fcmVsZXZhbnRfaW5kZXg9NA==">k8s 中为什么需要 br_netfilter 与 net.bridge.bridge-nf-call-iptables=1</span></p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 加载 br_netfilter 模块 (网桥和防火墙连接模块)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># br_netfilter 可以使 iptables 规则可以在 Linux Bridges 上面工作，用于将桥接的流量转发至 iptables 链</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">sudo</span> modprobe br_netfilter</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 确认是否加载 br_netfilter 模块</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>ec2-user@k8s-master01 ~<span class="token punctuation">]</span>$ lsmod <span class="token operator">|</span> <span class="token function">grep</span> br_netfilter</pre></td></tr><tr><td data-num="7"></td><td><pre>br_netfilter           <span class="token number">32768</span>  <span class="token number">0</span></pre></td></tr><tr><td data-num="8"></td><td><pre>bridge                <span class="token number">262144</span>  <span class="token number">1</span> br_netfilter</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 确认内核参数 bridge-nf-call-iptables 是否正确</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>ec2-user@k8s-master01 ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> sysctl -a <span class="token operator">|</span> <span class="token function">grep</span> bridge</pre></td></tr><tr><td data-num="12"></td><td><pre>net.bridge.bridge-nf-call-arptables <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="13"></td><td><pre>net.bridge.bridge-nf-call-ip6tables <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="14"></td><td><pre>net.bridge.bridge-nf-call-iptables <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="15"></td><td><pre>net.bridge.bridge-nf-filter-pppoe-tagged <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="16"></td><td><pre>net.bridge.bridge-nf-filter-vlan-tagged <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="17"></td><td><pre>net.bridge.bridge-nf-pass-vlan-input-dev <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="18"></td><td><pre>sysctl: reading key <span class="token string">"net.ipv6.conf.all.stable_secret"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>sysctl: reading key <span class="token string">"net.ipv6.conf.default.stable_secret"</span></pre></td></tr><tr><td data-num="20"></td><td><pre>sysctl: reading key <span class="token string">"net.ipv6.conf.docker0.stable_secret"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>sysctl: reading key <span class="token string">"net.ipv6.conf.eth0.stable_secret"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>sysctl: reading key <span class="token string">"net.ipv6.conf.lo.stable_secret"</span></pre></td></tr></table></figure><h4 id="配置ipvs"><a class="anchor" href="#配置ipvs">#</a> 配置 ipvs</h4>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">777</span> /etc/sysconfig/modules</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 配置 加载 ipvs 模块的脚本</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">sudo</span> <span class="token function">cat</span> <span class="token operator">></span> /etc/sysconfig/modules/ipvs.modules <span class="token operator">&lt;&lt;</span><span class="token string">EOF</pre></td></tr><tr><td data-num="4"></td><td><pre>#!/bin/bash</pre></td></tr><tr><td data-num="5"></td><td><pre>sudo modprobe -- ip_vs</pre></td></tr><tr><td data-num="6"></td><td><pre>sudo modprobe -- ip_vs_rr</pre></td></tr><tr><td data-num="7"></td><td><pre>sudo modprobe -- ip_vs_wrr</pre></td></tr><tr><td data-num="8"></td><td><pre>sudo modprobe -- ip_vs_sh</pre></td></tr><tr><td data-num="9"></td><td><pre>sudo modprobe -- nf_conntrack_ipv4</pre></td></tr><tr><td data-num="10"></td><td><pre>EOF</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 即时加载 ipvs 相关模块</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">755</span> /etc/sysconfig/modules/ipvs.modules <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span> /etc/sysconfig/modules/ipvs.modules <span class="token operator">&amp;&amp;</span> lsmod <span class="token operator">|</span> <span class="token function">grep</span> -e ip_vs -e nf_conntrack_ipv4</pre></td></tr></table></figure><blockquote>
<p>在 K8S 中，kube-proxyd 的工作模式可以选择 ipvs 和 iptable;</p>
<p><strong>iptables</strong> 是一个 Linux 内核功能，是一个高效的防火墙，并提供了大量的数据包处理和过滤方面的能力。它可以在核心数据包处理管线上用 Hook 挂接一系列的规则。</p>
<p>然而 kube-proxy 的用法是一种 O (n) 算法，其中的 n 随集群规模同步增长，这里的集群规模，更明确的说就是服务和后端 Pod 的数量。</p>
<p><strong>IPVS</strong> 被设计成可以支持大量 service 的负载均衡；它有一个优化的 API 和优化过的查询方式，而不是顺序的规则列表。</p>
<p>带来的结果就是 kube-proxy 在 IPVS 模式下处理链接的算法复杂度是 O (1)。换句话说，在大多数的场景中，他的链接处理性能是保持恒定的，和你的集群规模无关。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNDcwMDMzP2Zyb209MTU0MjUmYW1wO2FyZWFTb3VyY2U9MTAyMDAxLjImYW1wO3RyYWNlSWQ9MzVydXlKQkhFMmdySXJmWjRXTDZX">参考: K8S ipvs&amp;iptable</span></p>
</blockquote>
<h2 id="集群搭建"><a class="anchor" href="#集群搭建">#</a> 集群搭建</h2>
<h3 id="安装k8s的方式"><a class="anchor" href="#安装k8s的方式">#</a> 安装 K8S 的方式</h3>
<p>K8S 的安装有几种方式:</p>
<ul>
<li>源码包编译安装
<ul>
<li>master 不需要安装 docker (直接编译运行 master 需要的组件即可)</li>
</ul>
</li>
<li>容器化安装 (<strong>kubeadm</strong> 自动安装容器化的组件)
<ul>
<li>K8S 由 golang 编写，每一个组件 (etcd,kube-scheduler kubelet 等) 都是一个独立的进程</li>
<li>所有节点都需要 docker</li>
<li>存在自愈的优势 (docker 重新启动新容器即可)</li>
</ul>
</li>
<li>自动化部署
<ul>
<li>rancher 平台搭建 k8s 集群</li>
<li></li>
</ul>
</li>
</ul>
<p>现在主流的安装方式都是容器化安装，相比于源码包编译 难度会小很多.</p>
<p>但是 kubeadm 也有一些缺点:</p>
<ol>
<li>镜像存储于 GCR (GoogleContainerRepository), 国内无法访问</li>
<li>证书有效期只有 1 年 (过期后 K8S 集群失效)</li>
</ol>
<h3 id="安装-docker-软件"><a class="anchor" href="#安装-docker-软件">#</a> 安装 Docker 软件</h3>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>yum <span class="token function">install</span> -y yum-utils device-mapper-persistent-data lvm2</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>yum-config-manager <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  --add-repo <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</pre></td></tr><tr><td data-num="6"></td><td><pre> </pre></td></tr><tr><td data-num="7"></td><td><pre>yum <span class="token function">install</span> -y docker-ce</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">## 创建 /etc/docker 目录</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">mkdir</span> /etc/docker</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 配置 daemon</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">cat</span> <span class="token operator">></span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF</pre></td></tr><tr><td data-num="14"></td><td><pre>&#123;</pre></td></tr><tr><td data-num="15"></td><td><pre>  "exec-opts": ["native.cgroupdriver=systemd"],</pre></td></tr><tr><td data-num="16"></td><td><pre>  "log-driver": "json-file",</pre></td></tr><tr><td data-num="17"></td><td><pre>  "log-opts": &#123;</pre></td></tr><tr><td data-num="18"></td><td><pre>    "max-size": "100m"</pre></td></tr><tr><td data-num="19"></td><td><pre>  &#125;,</pre></td></tr><tr><td data-num="20"></td><td><pre>  # 镜像仓库</pre></td></tr><tr><td data-num="21"></td><td><pre>  "insecure-registries": ["harbor.hongfu.com"]</pre></td></tr><tr><td data-num="22"></td><td><pre>&#125;</pre></td></tr><tr><td data-num="23"></td><td><pre>EOF</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token function">mkdir</span> -p /etc/systemd/system/docker.service.d</pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># 也可以直接通过 yum 安装新版本 docker, 不执行上面的 docker-ce 安装</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token function">sudo</span> yum <span class="token function">install</span> docker</pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment"># 重启 docker 服务</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token function">sudo</span> systemctl daemon-reload <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> systemctl restart docker <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> docker</pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment"># 将当前非 root 用户添加到 docker 用户组</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span> <span class="token function">id</span> -un</pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment"># 添加用户到 docker 用户组</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token function">sudo</span> gpasswd -a <span class="token variable">$&#123;<span class="token environment constant">USER</span>&#125;</span> docker</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">#更新用户组</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token function">sudo</span> newgrp docker</pre></td></tr></table></figure><h3 id="安装-kubeadm-kubelet主从均配置"><a class="anchor" href="#安装-kubeadm-kubelet主从均配置">#</a> 安装 Kubeadm, kubelet（主从均配置）</h3>
<p><strong>在 master 和 worker 节点 上执行</strong></p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 更换谷歌源为阿里源</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /etc/yum.repos.d/kubernetes.repo</span></pre></td></tr><tr><td data-num="3"></td><td><pre>[kubernetes]</pre></td></tr><tr><td data-num="4"></td><td><pre>name=Kubernetes</pre></td></tr><tr><td data-num="5"></td><td><pre>baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</pre></td></tr><tr><td data-num="6"></td><td><pre>enabled=1</pre></td></tr><tr><td data-num="7"></td><td><pre>gpgcheck=0</pre></td></tr><tr><td data-num="8"></td><td><pre>repo_gpgcheck=0</pre></td></tr><tr><td data-num="9"></td><td><pre>gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</pre></td></tr><tr><td data-num="10"></td><td><pre>EOF</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># yum -y  install  kubeadm-1.15.1 kubectl-1.15.1 kubelet-1.15.1</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">sudo</span> yum -y  <span class="token function">install</span>  kubeadm kubectl kubelet</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 设置 kubelet 开机自启</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> kubelet.service</pre></td></tr></table></figure><blockquote>
<p>K8S 集群启动时，是需要 kubelet 来引导其他组件的启动</p>
<p>--&gt; kubelet 需要在服务器设置开机自启</p>
</blockquote>
<h3 id="初始化主节点"><a class="anchor" href="#初始化主节点">#</a> 初始化主节点</h3>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 打印 kubeadm 的默认初始化配置文件到当前目录下的 kubeadm-config.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># kubeadm config print [command]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># Available Commands:</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#  init-defaults Print default init configuration, that can be used for 'kubeadm init'</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#  join-defaults Print default join configuration, that can be used for 'kubeadm join'</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>kubeadm config print init-defaults <span class="token operator">></span> kubeadm-config.yaml</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">vim</span> kubeadm-config.yaml</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># kubeadm init --config kubeadm-config.yaml --experimental-upload-certs | tee kubeadm-init.log</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">sudo</span> kubeadm init --config kubeadm-config.yaml --v<span class="token operator">=</span><span class="token number">6</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 初始化错误时 重置 kubeadm</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">sudo</span> kubeadm reset</pre></td></tr></table></figure><p>调整后的 kubeadm 的 config:</p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta3</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">bootstrapTokens</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">groups</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">-</span> system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>kubeadm<span class="token punctuation">:</span>default<span class="token punctuation">-</span>node<span class="token punctuation">-</span>token</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">token</span><span class="token punctuation">:</span> abcdef.0123456789abcdef</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">ttl</span><span class="token punctuation">:</span> 24h0m0s</pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">usages</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> signing</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">-</span> authentication</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> InitConfiguration</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token key atrule">localAPIEndpoint</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token comment"># 主服务器端的 ip 地址 (node 节点要找的 api-server 的 ip)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">advertiseAddress</span><span class="token punctuation">:</span> 52.81.179.223</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment"># 从外部访问当前集群时的端口 (默认 6443)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">bindPort</span><span class="token punctuation">:</span> <span class="token number">6443</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token key atrule">criSocket</span><span class="token punctuation">:</span> /var/run/dockershim.sock</pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment"># 当前节点的名称 (与主机名一致)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>master01</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">taints</span><span class="token punctuation">:</span> <span class="token null important">null</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token key atrule">apiServer</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token key atrule">timeoutForControlPlane</span><span class="token punctuation">:</span> 4m0s</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta3</pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token key atrule">certificatesDir</span><span class="token punctuation">:</span> /etc/kubernetes/pki</pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token key atrule">clusterName</span><span class="token punctuation">:</span> kubernetes</pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token key atrule">controllerManager</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token key atrule">dns</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token key atrule">etcd</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token key atrule">local</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token key atrule">dataDir</span><span class="token punctuation">:</span> /var/lib/etcd</pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"># 配置镜像源</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token key atrule">imageRepository</span><span class="token punctuation">:</span> registry.aliyuncs.com/google_containers</pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterConfiguration</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment"># 当前 K8S 版本 (模板中的版本相较于安装的 kubeadm 版本，会有些许落后 需要按照真正安装版本修正)</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token key atrule">kubernetesVersion</span><span class="token punctuation">:</span> 1.26.2</pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token key atrule">networking</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token comment"># 域名设置 (默认的 cluster.local 即可)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token key atrule">dnsDomain</span><span class="token punctuation">:</span> cluster.local</pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token comment"># 当前 ipvs/iptable 负载均衡的网段，可以不改</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token key atrule">serviceSubnet</span><span class="token punctuation">:</span> 10.96.0.0/12</pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token comment"># pod 所在网段 (如果使用 Flannel 构建网络 则必须指定网段)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token comment"># Flannel 规定 pod 网段必须在 10.244.0.0/16 下</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token key atrule">podSubnet</span><span class="token punctuation">:</span> <span class="token string">"10.244.0.0/16"</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token key atrule">scheduler</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment"># 额外添加 kubelet 修改</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeletConfiguration</pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubelet.config.k8s.io/v1beta3</pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment">#cgroupDriver: systemd</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token key atrule">cgroupDriver</span><span class="token punctuation">:</span> cgroupfs    </pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment"># 额外添加 kube-proxy 修改</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeproxy.config.k8s.io/v1alpha1</pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeProxyConfiguration</pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token key atrule">featureGates</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token key atrule">SupportIPVSProxyMode</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token comment"># 指定 proxy 工作方式为 ipvs</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token key atrule">mode</span><span class="token punctuation">:</span> ipvs</pre></td></tr></table></figure><p>初始化成功后，控制台输出如下:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 省略 kubeadm init 大部分输出日志</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="3"></td><td><pre>I0315 <span class="token number">13</span>:32:25.069192    <span class="token number">5163</span> loader.go:373<span class="token punctuation">]</span> Config loaded from file:  /etc/kubernetes/admin.conf</pre></td></tr><tr><td data-num="4"></td><td><pre>Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 使用集群前的配置指令</span></pre></td></tr><tr><td data-num="6"></td><td><pre>To start using your cluster, you need to run the following as a regular user:</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 将 /etc/kubernetes/admin.conf 拷贝至 $HOME/.kube/config</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 当前用户是 root 用户 可执行下面命令  </span></pre></td></tr><tr><td data-num="12"></td><td><pre>Alternatively, <span class="token keyword">if</span> you are the root user, you can run:</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/kubernetes/admin.conf</pre></td></tr><tr><td data-num="14"></td><td><pre>  </pre></td></tr><tr><td data-num="15"></td><td><pre>You should now deploy a pod network to the cluster.</pre></td></tr><tr><td data-num="16"></td><td><pre>Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:</pre></td></tr><tr><td data-num="17"></td><td><pre>  https://kubernetes.io/docs/concepts/cluster-administration/addons/</pre></td></tr><tr><td data-num="18"></td><td><pre>Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:</pre></td></tr><tr><td data-num="19"></td><td><pre>kubeadm <span class="token function">join</span> <span class="token number">172.31</span>.5.183:6443 --token abcdef.0123456789abcdef <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        --discovery-token-ca-cert-hash sha256:d6ef04fee60ddb95b9be99f9de42d632a1b736868c9973dab592ac27c4c4405c</pre></td></tr></table></figure><p><code>kubeadm join</code>  这条命令是有有效期的，需要的时候，可以执行如下命令进行获取</p>
<pre><code>kubeadm token create --print-join-command
</code></pre>
<h3 id="加入其余工作节点"><a class="anchor" href="#加入其余工作节点">#</a> 加入其余工作节点</h3>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 执行安装日志中的加入命令即可</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kubeadm <span class="token function">join</span> <span class="token number">172.31</span>.5.183:6443 --token abcdef.0123456789abcdef <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        --discovery-token-ca-cert-hash sha256:d6ef04fee60ddb95b9be99f9de42d632a1b736868c9973dab592ac27c4c4405c</pre></td></tr></table></figure><blockquote>
<p>在各个工作节点上，需要将主节点的 admin.config 文件拷贝过去，并同样处理 才能在工作节点使用 kubectl 指令</p>
<pre><code># 将 /etc/kubernetes/admin.conf拷贝至$HOME/.kube/config
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
# 当前用户是root用户 可执行下面命令  
  export KUBECONFIG=/etc/kubernetes/admin.conf
</code></pre>
</blockquote>
<h3 id="部署网络插件"><a class="anchor" href="#部署网络插件">#</a> 部署网络插件</h3>
<p>将工作节点都加入集群后，查看集群节点:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ec2-user<span class="token punctuation">]</span> kubectl get nodes</pre></td></tr><tr><td data-num="2"></td><td><pre>NAME           STATUS     ROLES           AGE     VERSION</pre></td></tr><tr><td data-num="3"></td><td><pre>k8s-master01   NotReady   control-plane   6h17m   v1.26.2</pre></td></tr><tr><td data-num="4"></td><td><pre>k8s-node01     NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>          51m     v1.26.2</pre></td></tr><tr><td data-num="5"></td><td><pre>k8s-node02     NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>          137m    v1.26.2</pre></td></tr></table></figure><blockquote>
<p>可以发现，所有节点都处于 <code>NotReady</code>  状态，这是因为 K8S 要求集群网络是扁平化的才可以满足网络模型.</p>
<p>那么就需要安装对应的网络插件，构建扁平化集群网络</p>
</blockquote>
<h4 id="安装-pod-网络插件cnicontainer-network-interface"><a class="anchor" href="#安装-pod-网络插件cnicontainer-network-interface">#</a> 安装 Pod 网络插件（CNI：Container Network Interface)</h4>
<p>你必须部署一个基于 Pod 网络插件的 容器网络接口 (CNI)，以便你的 Pod 可以相互通信。</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 最好提前下载镜像（所有节点！！）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># sudo docker pull quay.io/coreos/flannel:v0.14.0</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 新版本 k8s (v1.26) 默认使用 containerd 来作为容器运行时</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">sudo</span> ctr image pull docker.io/flannel/flannel:v0.21.3</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">sudo</span> ctr image pull docker.io/flannel/flannel-cni-plugin</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 创建 flannel 工作文件夹，方便以后移出 flannel 时 使用安装时的 yaml 配置整体移除</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">sudo</span> <span class="token function">mkdir</span> /usr/local/kubernetes/cni/flannel -p</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token builtin class-name">cd</span> /usr/local/kubernetes/cni/flannel</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># master 节点执行</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">wget</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token function">sudo</span> kubectl apply -f kube-flannel.yml</pre></td></tr></table></figure><p>如果上面安装失败，则下载我百度里的，离线安装</p>
<blockquote>
<p>链接：<span class="exturl" data-url="aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMUhCOXh1TzNic3NBVzd2NUh6cFhrZVE=">https://pan.baidu.com/s/1HB9xuO3bssAW7v5HzpXkeQ</span><br />
 提取码：8888</p>
</blockquote>
<p>再查看 node 节点，就已经正常了</p>
<p>查看安装时的环境变量:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>ec2-user@k8s-master01 ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span>  <span class="token function">cat</span> /var/lib/kubelet/kubeadm-flags.env</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># --pod-infra-container-image 指定初始化容器 pause 的镜像 tag</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">KUBELET_KUBEADM_ARGS</span><span class="token operator">=</span><span class="token string">"--container-runtime-endpoint=unix:///var/run/containerd/containerd.sock --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9"</span></pre></td></tr></table></figure><h2 id="安装报错解决"><a class="anchor" href="#安装报错解决">#</a> 安装报错解决</h2>
<h3 id="kubeadm-init-报错解决"><a class="anchor" href="#kubeadm-init-报错解决">#</a> kubeadm init 报错解决</h3>
<h4 id="initial-timeout-of-40s-passed"><a class="anchor" href="#initial-timeout-of-40s-passed">#</a> Initial timeout of 40s passed.</h4>
<ul>
<li>
<p>按照报错提示 执行指令查看，发现报错无权限创建容器 (etcd 默认是需要 root 用户启动)</p>
</li>
<li>
<p>使用非 root 用户操作 init, 切换成 root 用户执行 kubeadm init</p>
</li>
</ul>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 切换成 root 用户</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> <span class="token function">su</span></pre></td></tr></table></figure><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC85NDdkMzEzYmZiZGY=">参考:etcd 如何以 non-root 用户运行</span></p>
<h4 id="failed-to-get-sandbox-image-k8sgcriopause36"><a class="anchor" href="#failed-to-get-sandbox-image-k8sgcriopause36">#</a> Failed to get sandbox image “<span class="exturl" data-url="aHR0cDovL2s4cy5nY3IuaW8vcGF1c2U6My42JUUyJTgwJTlD">k8s.gcr.io/pause:3.6“</span></h4>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 执行 init 端口访问一致超时</span></pre></td></tr><tr><td data-num="2"></td><td><pre>round_trippers.go:553<span class="token punctuation">]</span> GET https://公网IP:6443/healthz?timeout<span class="token operator">=</span>10s  <span class="token keyword">in</span> <span class="token number">0</span> milliseconds</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 查看日志  </span></pre></td></tr><tr><td data-num="4"></td><td><pre>journalctl -xeu kubelet</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>02:32:13 kuberuntime_manager.go:782<span class="token punctuation">]</span> <span class="token string">"CreatePodSandbox for pod failed"</span> <span class="token assign-left variable">err</span><span class="token operator">=</span><span class="token string">"rpc error: code = Unknown desc = failed to get sandbox image <span class="token entity" title="\&quot;">\"</span>k8s.gcr.io/pause:3.6<span class="token entity" title="\&quot;">\"</span>: failed to pull image <span class="token entity" title="\&quot;">\"</span>k8s.gcr.io/pause:3.6<span class="token entity" title="\&quot;">\"</span>: failed to pull and unpack image <span class="token entity" title="\&quot;">\"</span>k8s.gcr.io</pre></td></tr><tr><td data-num="2"></td><td><pre>02:32:13 pod_workers.go:965] "</span>Error syncing pod, skipping<span class="token string">" err="</span>failed to <span class="token punctuation">\</span>"CreatePodSandbox<span class="token punctuation">\</span>" <span class="token keyword">for</span> <span class="token punctuation">\</span>"kube-apiserver-k8s-master01_kube-system<span class="token punctuation">(</span>4938c9069b4be542aebc1a77467fcead<span class="token punctuation">)</span><span class="token punctuation">\</span>" with CreatePodSandboxError: <span class="token punctuation">\</span>"Failed to create sandbox <span class="token keyword">for</span> pod <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">\</span>"kube-apise</pre></td></tr><tr><td data-num="3"></td><td><pre>02:32:17 controller.go:146<span class="token punctuation">]</span> failed to ensure lease exists, will retry <span class="token keyword">in</span> 7s, error: Get <span class="token string">"https://host:6443/apis/coordination.k8s.io/v1/namespaces/kube-node-lease/leases/k8s-master01?timeout=10s"</span><span class="token builtin class-name">:</span> dial tcp host:6443: connect: connection </pre></td></tr><tr><td data-num="4"></td><td><pre>02:32:17 kubelet_node_status.go:70<span class="token punctuation">]</span> <span class="token string">"Attempting to register node"</span> <span class="token assign-left variable">node</span><span class="token operator">=</span><span class="token string">"k8s-master01"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>02:32:17 kubelet_node_status.go:92<span class="token punctuation">]</span> <span class="token string">"Unable to register node with API server"</span> <span class="token assign-left variable">err</span><span class="token operator">=</span><span class="token string">"Post <span class="token entity" title="\&quot;">\"</span>https://:6443/api/v1/nodes<span class="token entity" title="\&quot;">\"</span>: dial tcp :6443: connect: connection refused"</span> <span class="token assign-left variable">node</span><span class="token operator">=</span><span class="token string">"k8s-master01"</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看镜像</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> crictl img</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 拉取国内 pause 镜像</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">sudo</span> crictl pull registry.aliyuncs.com/google_containers/pause:3.9</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 将 aliyuncs.com/google_containers/pause:3.9 tag 改为 k8s 需要的 k8s.gcr.io/pause:3.6 镜像 tag</span></pre></td></tr><tr><td data-num="6"></td><td><pre>ctr -n k8s.io i tag registry.aliyuncs.com/google_containers/pause:3.9 k8s.gcr.io/pause:3.6</pre></td></tr></table></figure><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hhd2sxOTkvYXJ0aWNsZS9kZXRhaWxzLzEyNTA1ODAzMA==">参考:kubeadm 创建集群失败报 Unable to register node with API server</span></p>
<h4 id="failed-to-start-containerd-container-runtime"><a class="anchor" href="#failed-to-start-containerd-container-runtime">#</a> Failed to start containerd container runtime</h4>
<p>移除以前的配置文件</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">rm</span> -rf /etc/containerd</pre></td></tr></table></figure><p>重新执行文章中的安装部分</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">tar</span> -C / -xzf cri-containerd-cni-1.4.3-linux-amd64.tar.gz</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span>:/usr/local/bin:/usr/local/sbin</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin class-name">source</span> ~/.bashrc</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">mkdir</span> /etc/containerd</pre></td></tr><tr><td data-num="5"></td><td><pre>containerd config default <span class="token operator">></span> /etc/containerd/config.toml</pre></td></tr></table></figure><p>镜像加速的配置就在 cri 插件配置块下面的 registry 配置块</p>
<p>修改镜像</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">vim</span> /etc/containerd/config.toml</pre></td></tr></table></figure><p>修改为如下配置文件格式</p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 修改 cri 的 pause 镜像选择</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>plugins."io.containerd.grpc.v1.cri"<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  sandbox_image = "registry.aliyuncs.com/k8sxio/pause<span class="token punctuation">:</span>3.6"</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 修改 ctl 的镜像源</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>plugins."io.containerd.grpc.v1.cri".registry.mirrors<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">[</span>plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    endpoint = <span class="token punctuation">[</span><span class="token string">"https://dockerhub.mirrors.nwafu.edu.cn"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">[</span>plugins."io.containerd.grpc.v1.cri".registry.mirrors."k8s.gcr.io"<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    endpoint = <span class="token punctuation">[</span><span class="token string">"https://registry.aliyuncs.com/k8sxio"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p>保存并退出</p>
<p>启动 Containerd，并查询状态</p>
<pre><code class="language-cobol">sudo systemctl daemon-reload
sudo systemctl enable containerd
sudo systemctl restart containerd
sudo systemctl status containerd -l
</code></pre>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNjMyNjAyL2FydGljbGUvZGV0YWlscy8xMjYwMDkyOTE/c3BtPTEwMDEuMjAxNC4zMDAxLjU1MDE=">解决方案参考</span></p>
<h4 id="etcd启动失败"><a class="anchor" href="#etcd启动失败">#</a> etcd 启动失败</h4>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看 cir 启动容器的情况</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>ec2-user@k8s-master01 ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock <span class="token function">ps</span> -a</pre></td></tr><tr><td data-num="3"></td><td><pre>CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID              POD</pre></td></tr><tr><td data-num="4"></td><td><pre>d01d905891c30       fce326961ae2d       <span class="token number">6</span> seconds ago       Exited              etcd                      <span class="token number">143</span>                 2abd5c4d17db7       etcd-k8s-master01</pre></td></tr><tr><td data-num="5"></td><td><pre>3f184f999fa3a       63d3239c3c159       <span class="token number">17</span> seconds ago      Running             kube-apiserver            <span class="token number">136</span>                 b16ab63d9f98f       kube-apiserver-k8s-master01</pre></td></tr><tr><td data-num="6"></td><td><pre>856484f110ca4       db8f409d9a5d7       <span class="token number">17</span> seconds ago      Running             kube-scheduler            <span class="token number">5</span>                   f45f3fe851e01       kube-scheduler-k8s-master01</pre></td></tr><tr><td data-num="7"></td><td><pre>846da4beb8688       240e201d5b0d8       <span class="token number">18</span> seconds ago      Running             kube-controller-manager   <span class="token number">5</span>                   ef4abc95c53b6       kube-controller-manager-k8s-master01</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 指定容器 id 查看日志</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>ec2-user@k8s-master01 ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock logs d01d905891c30</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"info"</span>,<span class="token string">"ts"</span><span class="token builtin class-name">:</span><span class="token string">"2023-03-15T05:10:32.537Z"</span>,<span class="token string">"caller"</span><span class="token builtin class-name">:</span><span class="token string">"etcdmain/etcd.go:73"</span>,<span class="token string">"msg"</span><span class="token builtin class-name">:</span><span class="token string">"Running: "</span>,<span class="token string">"args"</span>:<span class="token punctuation">[</span><span class="token string">"etcd"</span>,<span class="token string">"--advertise-client-urls=https://公网IP:2379"</span>,<span class="token string">"--cert-file=/etc/kubernetes/pki/etcd/server.crt"</span>,<span class="token string">"--client-cert-auth=true"</span>,<span class="token string">"--data-dir=/var/lib/etcd"</span>,<span class="token string">"--experimental-initial-corrupt-check=true"</span>,<span class="token string">"--experimental-watch-progress-notify-interval=5s"</span>,<span class="token string">"--initial-advertise-peer-urls=https://公网IP:2380"</span>,<span class="token string">"--initial-cluster=k8s-master01=https://公网IP:2380"</span>,<span class="token string">"--key-file=/etc/kubernetes/pki/etcd/server.key"</span>,<span class="token string">"--listen-client-urls=https://127.0.0.1:2379,https://公网IP:2379"</span>,<span class="token string">"--listen-metrics-urls=http://127.0.0.1:2381"</span>,<span class="token string">"--listen-peer-urls=https://公网IP:2380"</span>,<span class="token string">"--name=k8s-master01"</span>,<span class="token string">"--peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt"</span>,<span class="token string">"--peer-client-cert-auth=true"</span>,<span class="token string">"--peer-key-file=/etc/kubernetes/pki/etcd/peer.key"</span>,<span class="token string">"--peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt"</span>,<span class="token string">"--snapshot-count=10000"</span>,<span class="token string">"--trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"info"</span>,<span class="token string">"ts"</span><span class="token builtin class-name">:</span><span class="token string">"2023-03-15T05:10:32.537Z"</span>,<span class="token string">"caller"</span><span class="token builtin class-name">:</span><span class="token string">"embed/etcd.go:124"</span>,<span class="token string">"msg"</span><span class="token builtin class-name">:</span><span class="token string">"configuring peer listeners"</span>,<span class="token string">"listen-peer-urls"</span>:<span class="token punctuation">[</span><span class="token string">"https://公网IP:2380"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"info"</span>,<span class="token string">"ts"</span><span class="token builtin class-name">:</span><span class="token string">"2023-03-15T05:10:32.537Z"</span>,<span class="token string">"caller"</span><span class="token builtin class-name">:</span><span class="token string">"embed/etcd.go:484"</span>,<span class="token string">"msg"</span><span class="token builtin class-name">:</span><span class="token string">"starting with peer TLS"</span>,<span class="token string">"tls-info"</span><span class="token builtin class-name">:</span><span class="token string">"cert = /etc/kubernetes/pki/etcd/peer.crt, key = /etc/kubernetes/pki/etcd/peer.key, client-cert=, client-key=, trusted-ca = /etc/kubernetes/pki/etcd/ca.crt, client-cert-auth = true, crl-file = "</span>,<span class="token string">"cipher-suites"</span>:<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"info"</span>,<span class="token string">"ts"</span><span class="token builtin class-name">:</span><span class="token string">"2023-03-15T05:10:32.537Z"</span>,<span class="token string">"caller"</span><span class="token builtin class-name">:</span><span class="token string">"embed/etcd.go:373"</span>,<span class="token string">"msg"</span><span class="token builtin class-name">:</span><span class="token string">"closing etcd server"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"k8s-master01"</span>,<span class="token string">"data-dir"</span><span class="token builtin class-name">:</span><span class="token string">"/var/lib/etcd"</span>,<span class="token string">"advertise-peer-urls"</span>:<span class="token punctuation">[</span><span class="token string">"https://公网IP:2380"</span><span class="token punctuation">]</span>,<span class="token string">"advertise-client-urls"</span>:<span class="token punctuation">[</span><span class="token string">"https://公网IP:2379"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"info"</span>,<span class="token string">"ts"</span><span class="token builtin class-name">:</span><span class="token string">"2023-03-15T05:10:32.537Z"</span>,<span class="token string">"caller"</span><span class="token builtin class-name">:</span><span class="token string">"embed/etcd.go:375"</span>,<span class="token string">"msg"</span><span class="token builtin class-name">:</span><span class="token string">"closed etcd server"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"k8s-master01"</span>,<span class="token string">"data-dir"</span><span class="token builtin class-name">:</span><span class="token string">"/var/lib/etcd"</span>,<span class="token string">"advertise-peer-urls"</span>:<span class="token punctuation">[</span><span class="token string">"https://公网IP:2380"</span><span class="token punctuation">]</span>,<span class="token string">"advertise-client-urls"</span>:<span class="token punctuation">[</span><span class="token string">"https://公网IP:2379"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># 启动失败 网络连通报错</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"warn"</span>,<span class="token string">"ts"</span><span class="token builtin class-name">:</span><span class="token string">"2023-03-15T05:10:32.537Z"</span>,<span class="token string">"caller"</span><span class="token builtin class-name">:</span><span class="token string">"etcdmain/etcd.go:146"</span>,<span class="token string">"msg"</span><span class="token builtin class-name">:</span><span class="token string">"failed to start etcd"</span>,<span class="token string">"error"</span><span class="token builtin class-name">:</span><span class="token string">"listen tcp 公网IP:2380: bind: cannot assign requested address"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"fatal"</span>,<span class="token string">"ts"</span><span class="token builtin class-name">:</span><span class="token string">"2023-03-15T05:10:32.537Z"</span>,<span class="token string">"caller"</span><span class="token builtin class-name">:</span><span class="token string">"etcdmain/etcd.go:204"</span>,<span class="token string">"msg"</span><span class="token builtin class-name">:</span><span class="token string">"discovery failed"</span>,<span class="token string">"error"</span><span class="token builtin class-name">:</span><span class="token string">"listen tcp 公网IP:2380: bind: cannot assign requested address"</span>,<span class="token string">"stacktrace"</span><span class="token builtin class-name">:</span><span class="token string">"go.etcd.io/etcd/server/v3/etcdmain.startEtcdOrProxyV2<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>go.etcd.io/etcd/server/v3/etcdmain/etcd.go:204<span class="token entity" title="\n">\n</span>go.etcd.io/etcd/server/v3/etcdmain.Main<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>go.etcd.io/etcd/server/v3/etcdmain/main.go:40<span class="token entity" title="\n">\n</span>main.main<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>go.etcd.io/etcd/server/v3/main.go:32<span class="token entity" title="\n">\n</span>runtime.main<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>runtime/proc.go:225"</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>问题原因:</p>
<blockquote>
<p>因为阿里云主机网络是 VPC，公网 IP 只能在控制台上看到，在系统里面看到的是内部网卡的 IP，阿里云采用 NAT 方式将公网 IP 映射到 ECS 的位于私网的网卡上，所以在网卡上看不到公网 IP，使用  <code>ifconfig</code>  查看到的也是私有网卡的 IP，导致  <code>etcd</code>  无法启动。</p>
</blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGlmZS1vZi1jb2RpbmcvcC8xMTg3OTA2Ny5odG1s">参考:kubeadm 部署 k8s 无法指定公网 IP</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmxhbndlaWhvbmcuY29tL3Bvc3RzLzU2MzE0Lw==">参考：基于公网 IP 部署 K8S</span></p>
<p>解决方案:</p>
<p><strong>kubeadm 的配置文件中，将 ip 地址改为内网 (或使用参考中的公网 IP 部署方案)</strong></p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>localAPIEndpoint:</pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token comment"># 主服务器端的内网 ip 地址 (node 节点要找的 api-server 的 ip)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  advertiseAddress: <span class="token number">172.55</span>.32.2</pre></td></tr></table></figure><h3 id="安装flannel报错解决"><a class="anchor" href="#安装flannel报错解决">#</a> 安装 Flannel 报错解决</h3>
<h4 id="failed-to-get-sandbox-image-k8sgcriopause36-2"><a class="anchor" href="#failed-to-get-sandbox-image-k8sgcriopause36-2">#</a> Failed to get sandbox image “<span class="exturl" data-url="aHR0cDovL2s4cy5nY3IuaW8vcGF1c2U6My42JUUyJTgwJTlD">k8s.gcr.io/pause:3.6“</span></h4>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看创建时的容器信息</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock <span class="token function">ps</span> -a</pre></td></tr></table></figure><p>从日志能够看到<span class="exturl" data-url="aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/cT1rOHMmYW1wO3NwbT0xMDAxLjIxMDEuMzAwMS43MDIw"> k8s</span> 核心服务的 pod 创建失败，因为获取 pause 镜像失败，总是从 k8s.gcr.io 下载。</p>
<p>经过确认，k8s 1.26 中启用了 CRI <span class="exturl" data-url="aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/cT1zYW5kYm94JmFtcDtzcG09MTAwMS4yMTAxLjMwMDEuNzAyMA==">sandbox</span> (pause) image 的配置支持。</p>
<p>之前通过 kubeadm init –image-repository 设置的镜像地址，不再会传递给 cri 运行时去下载 pause 镜像</p>
<p>需要在 cri 运行时的配置文件中设置，修改 /etc/containerd/config.toml 文件</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">vim</span> /etc/containerd/config.toml</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 修改 config 文件中的 sandbox 参数 </span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># [plugins."io.containerd.grpc.v1.cri"]</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#  sandbox_image = "registry.aliyuncs.com/k8sxio/pause:3.6" registry.aliyuncs.com/google_containers/pause:3.9</span></pre></td></tr></table></figure><p>然后重启 containerd</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> systemctl daemon-reload</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> containerd</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">sudo</span> systemctl restart containerd</pre></td></tr></table></figure><h4 id="node节点的flannel无法启动"><a class="anchor" href="#node节点的flannel无法启动">#</a> node 节点的 flannel 无法启动</h4>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看 pod 状况</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>ec2-user@k8s-master01 ~<span class="token punctuation">]</span>$ kubectl get pods -n kube-flannel -o wide</pre></td></tr><tr><td data-num="3"></td><td><pre>NAMESPACE     NAME                   READY   STATUS              RESTARTS  AGE   NODE        </pre></td></tr><tr><td data-num="4"></td><td><pre>kube-flannel  kube-flannel-ds-5hrzn  <span class="token number">1</span>/1     Running             <span class="token number">0</span>         7h    k8s-master01</pre></td></tr><tr><td data-num="5"></td><td><pre>kube-flannel  kube-flannel-ds-b2zvn  <span class="token number">1</span>/1     Running             <span class="token number">0</span>         7h    k8s-node01  </pre></td></tr><tr><td data-num="6"></td><td><pre>kube-flannel  kube-flannel-ds-zvj7b  <span class="token number">0</span>/1     Init:ErrImagePull   <span class="token number">0</span>         70m   k8s-node02  </pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 查看具体 pod 描述</span></pre></td></tr><tr><td data-num="9"></td><td><pre>kubectl describe pod kube-flannel-ds-zvj7b -n kube-flannel</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr><tr><td data-num="11"></td><td><pre>Events:</pre></td></tr><tr><td data-num="12"></td><td><pre>  Type     Reason   Age                From     Message</pre></td></tr><tr><td data-num="13"></td><td><pre>  ----     ------   ----               ----     -------</pre></td></tr><tr><td data-num="14"></td><td><pre>  Warning  Failed   57m                kubelet  Failed to pull image <span class="token string">"docker.io/flannel/flannel:v0.21.3"</span><span class="token builtin class-name">:</span> rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to pull and unpack image <span class="token string">"docker.io/flannel/flannel:v0.21.3"</span><span class="token builtin class-name">:</span> failed to <span class="token builtin class-name">read</span> expected number of bytes: unexpected EOF</pre></td></tr><tr><td data-num="15"></td><td><pre>  Normal   BackOff  57m                kubelet  Back-off pulling image </pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token comment"># 无法 pull flannel:v0.21.3</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token string">"docker.io/flannel/flannel:v0.21.3"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  Warning  Failed   57m                kubelet  Error: ImagePullBackOff</pre></td></tr><tr><td data-num="19"></td><td><pre>  Warning  Failed   47m                kubelet  Failed to pull image <span class="token string">"docker.io/flannel/flannel:v0.21.3"</span><span class="token builtin class-name">:</span> rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to pull and unpack image <span class="token string">"docker.io/flannel/flannel:v0.21.3"</span><span class="token builtin class-name">:</span> failed to copy: <span class="token builtin class-name">read</span> tcp <span class="token number">172.31</span>.33.63:54738-<span class="token operator">></span><span class="token number">104.18</span>.125.25:443: read: connection reset by peer</pre></td></tr><tr><td data-num="20"></td><td><pre>  Warning  Failed   32m                kubelet  Failed to pull image <span class="token string">"docker.io/flannel/flannel:v0.21.3"</span><span class="token builtin class-name">:</span> rpc error: code <span class="token operator">=</span> Unavailable desc <span class="token operator">=</span> error reading from server: EOF</pre></td></tr><tr><td data-num="21"></td><td><pre>  Warning  Failed   16m <span class="token punctuation">(</span>x4 over 57m<span class="token punctuation">)</span>  kubelet  Error: ErrImagePull</pre></td></tr><tr><td data-num="22"></td><td><pre>  Warning  Failed   16m                kubelet  Failed to pull image <span class="token string">"docker.io/flannel/flannel:v0.21.3"</span><span class="token builtin class-name">:</span> rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to pull and unpack image <span class="token string">"docker.io/flannel/flannel:v0.21.3"</span><span class="token builtin class-name">:</span> failed to copy: <span class="token builtin class-name">read</span> tcp <span class="token number">172.31</span>.33.63:39934-<span class="token operator">></span><span class="token number">104.18</span>.125.25:443: read: connection reset by peer</pre></td></tr><tr><td data-num="23"></td><td><pre>  Normal   Pulling  16m <span class="token punctuation">(</span>x5 over 74m<span class="token punctuation">)</span>  kubelet  Pulling image <span class="token string">"docker.io/flannel/flannel:v0.21.3"</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># 提前手动 pull 镜像 (需更改 containerd 镜像源！！)</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token function">sudo</span> ctr image pull docker.io/flannel/flannel:v0.21.3</pre></td></tr></table></figure><blockquote>
<p>还有一种解决方案:</p>
<p>在 docker 中下载非官方的 flannel 镜像，更改 tag 后，导入 containerd 中:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 在一台机去上使用 docker tag 转换 image</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 导出镜像，并拷贝到其他机器上</span></pre></td></tr><tr><td data-num="3"></td><td><pre>docker tag busybox busyboxaaa</pre></td></tr><tr><td data-num="4"></td><td><pre>docker save -o busybox.tar busyboxaaa</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">scp</span> busybox.tar ubuntu@172.31.24.12:~/</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 需要该镜像的服务器，用 ctr 导入</span></pre></td></tr><tr><td data-num="7"></td><td><pre>ctr image <span class="token function">import</span> busybox.tar</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>ctr images list<span class="token operator">|</span><span class="token function">grep</span> app  <span class="token comment">#查看导入的镜像</span></pre></td></tr><tr><td data-num="10"></td><td><pre>crictl images list<span class="token operator">|</span><span class="token function">grep</span> app <span class="token comment">#此命令也可查看</span></pre></td></tr></table></figure></blockquote>
<h3 id="node节点在部署网络插件后一直是notready状态"><a class="anchor" href="#node节点在部署网络插件后一直是notready状态">#</a> node 节点在部署网络插件后一直是 NotReady 状态</h3>
<p>worker 节点在 master 部署网络插件后，一直是 notReady 状态。登录 worker 节点后， <code>journalctl -xeu kubelet</code>  查看信息</p>
<p>发现与 master 节点 init 时报错类似 : <strong>Failed to get sandbox image “<span class="exturl" data-url="aHR0cDovL2s4cy5nY3IuaW8vcGF1c2U6My42">k8s.gcr.io/pause:3.6</span></strong> , 无法拉取 pause 的镜像</p>
<p>解决方案与 kubead init 是一样的:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看镜像</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> crictl img</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># worker 节点拉取国内 pause 镜像</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">sudo</span> crictl pull registry.aliyuncs.com/google_containers/pause:3.9</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 将 aliyuncs.com/google_containers/pause:3.9 tag 改为 k8s 需要的 k8s.gcr.io/pause:3.6 镜像 tag</span></pre></td></tr><tr><td data-num="6"></td><td><pre>ctr -n k8s.io i tag registry.aliyuncs.com/google_containers/pause:3.9 k8s.gcr.io/pause:3.6</pre></td></tr></table></figure><h2 id="kubeadm-init日志解析"><a class="anchor" href="#kubeadm-init日志解析">#</a> kubeadm init 日志解析</h2>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ec2-user<span class="token punctuation">]</span><span class="token comment"># sudo kubeadm init --config kubeadm-config.yaml --v=6</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 加载配置文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre>I0315 <span class="token number">13</span>:32:12.802771    <span class="token number">5163</span> initconfiguration.go:254<span class="token punctuation">]</span> loading configuration from <span class="token string">"kubeadm-config.yaml"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>init<span class="token punctuation">]</span> Using Kubernetes version: v1.26.2</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># init 前环境 & amp;&amp; 配置文件检查</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checks</pre></td></tr><tr><td data-num="7"></td><td><pre>I0315 <span class="token number">13</span>:32:12.809044    <span class="token number">5163</span> checks.go:568<span class="token punctuation">]</span> validating Kubernetes and kubeadm version</pre></td></tr><tr><td data-num="8"></td><td><pre>I0315 <span class="token number">13</span>:32:12.809065    <span class="token number">5163</span> checks.go:168<span class="token punctuation">]</span> validating <span class="token keyword">if</span> the firewall is enabled and active</pre></td></tr><tr><td data-num="9"></td><td><pre>I0315 <span class="token number">13</span>:32:12.814500    <span class="token number">5163</span> checks.go:203<span class="token punctuation">]</span> validating availability of port <span class="token number">6443</span></pre></td></tr><tr><td data-num="10"></td><td><pre>I0315 <span class="token number">13</span>:32:12.814677    <span class="token number">5163</span> checks.go:203<span class="token punctuation">]</span> validating availability of port <span class="token number">10259</span></pre></td></tr><tr><td data-num="11"></td><td><pre>I0315 <span class="token number">13</span>:32:12.814711    <span class="token number">5163</span> checks.go:203<span class="token punctuation">]</span> validating availability of port <span class="token number">10257</span></pre></td></tr><tr><td data-num="12"></td><td><pre>I0315 <span class="token number">13</span>:32:12.814741    <span class="token number">5163</span> checks.go:280<span class="token punctuation">]</span> validating the existence of <span class="token function">file</span> /etc/kubernetes/manifests/kube-apiserver.yaml</pre></td></tr><tr><td data-num="13"></td><td><pre>I0315 <span class="token number">13</span>:32:12.814758    <span class="token number">5163</span> checks.go:280<span class="token punctuation">]</span> validating the existence of <span class="token function">file</span> /etc/kubernetes/manifests/kube-controller-manager.yaml</pre></td></tr><tr><td data-num="14"></td><td><pre>I0315 <span class="token number">13</span>:32:12.814770    <span class="token number">5163</span> checks.go:280<span class="token punctuation">]</span> validating the existence of <span class="token function">file</span> /etc/kubernetes/manifests/kube-scheduler.yaml</pre></td></tr><tr><td data-num="15"></td><td><pre>I0315 <span class="token number">13</span>:32:12.814782    <span class="token number">5163</span> checks.go:280<span class="token punctuation">]</span> validating the existence of <span class="token function">file</span> /etc/kubernetes/manifests/etcd.yaml</pre></td></tr><tr><td data-num="16"></td><td><pre>I0315 <span class="token number">13</span>:32:12.814801    <span class="token number">5163</span> checks.go:430<span class="token punctuation">]</span> validating <span class="token keyword">if</span> the connectivity <span class="token builtin class-name">type</span> is via proxy or direct</pre></td></tr><tr><td data-num="17"></td><td><pre>I0315 <span class="token number">13</span>:32:12.814824    <span class="token number">5163</span> checks.go:469<span class="token punctuation">]</span> validating http connectivity to first IP address <span class="token keyword">in</span> the CIDR</pre></td></tr><tr><td data-num="18"></td><td><pre>I0315 <span class="token number">13</span>:32:12.814850    <span class="token number">5163</span> checks.go:469<span class="token punctuation">]</span> validating http connectivity to first IP address <span class="token keyword">in</span> the CIDR</pre></td></tr><tr><td data-num="19"></td><td><pre>I0315 <span class="token number">13</span>:32:12.814866    <span class="token number">5163</span> checks.go:104<span class="token punctuation">]</span> validating the container runtime</pre></td></tr><tr><td data-num="20"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837381    <span class="token number">5163</span> checks.go:329<span class="token punctuation">]</span> validating the contents of <span class="token function">file</span> /proc/sys/net/bridge/bridge-nf-call-iptables</pre></td></tr><tr><td data-num="21"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837449    <span class="token number">5163</span> checks.go:329<span class="token punctuation">]</span> validating the contents of <span class="token function">file</span> /proc/sys/net/ipv4/ip_forward</pre></td></tr><tr><td data-num="22"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837485    <span class="token number">5163</span> checks.go:644<span class="token punctuation">]</span> validating whether swap is enabled or not</pre></td></tr><tr><td data-num="23"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837522    <span class="token number">5163</span> checks.go:370<span class="token punctuation">]</span> validating the presence of executable crictl</pre></td></tr><tr><td data-num="24"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837546    <span class="token number">5163</span> checks.go:370<span class="token punctuation">]</span> validating the presence of executable conntrack</pre></td></tr><tr><td data-num="25"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837557    <span class="token number">5163</span> checks.go:370<span class="token punctuation">]</span> validating the presence of executable <span class="token function">ip</span></pre></td></tr><tr><td data-num="26"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837570    <span class="token number">5163</span> checks.go:370<span class="token punctuation">]</span> validating the presence of executable iptables</pre></td></tr><tr><td data-num="27"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837584    <span class="token number">5163</span> checks.go:370<span class="token punctuation">]</span> validating the presence of executable <span class="token function">mount</span></pre></td></tr><tr><td data-num="28"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837599    <span class="token number">5163</span> checks.go:370<span class="token punctuation">]</span> validating the presence of executable nsenter</pre></td></tr><tr><td data-num="29"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837613    <span class="token number">5163</span> checks.go:370<span class="token punctuation">]</span> validating the presence of executable ebtables</pre></td></tr><tr><td data-num="30"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837624    <span class="token number">5163</span> checks.go:370<span class="token punctuation">]</span> validating the presence of executable <span class="token function">ethtool</span></pre></td></tr><tr><td data-num="31"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837637    <span class="token number">5163</span> checks.go:370<span class="token punctuation">]</span> validating the presence of executable socat</pre></td></tr><tr><td data-num="32"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837652    <span class="token number">5163</span> checks.go:370<span class="token punctuation">]</span> validating the presence of executable tc</pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">[</span>WARNING FileExisting-tc<span class="token punctuation">]</span>: tc not found <span class="token keyword">in</span> system path</pre></td></tr><tr><td data-num="34"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837703    <span class="token number">5163</span> checks.go:370<span class="token punctuation">]</span> validating the presence of executable <span class="token function">touch</span></pre></td></tr><tr><td data-num="35"></td><td><pre>I0315 <span class="token number">13</span>:32:12.837719    <span class="token number">5163</span> checks.go:516<span class="token punctuation">]</span> running all checks</pre></td></tr><tr><td data-num="36"></td><td><pre>I0315 <span class="token number">13</span>:32:12.842093    <span class="token number">5163</span> checks.go:401<span class="token punctuation">]</span> checking whether the given node name is valid and reachable using net.LookupHost</pre></td></tr><tr><td data-num="37"></td><td><pre>I0315 <span class="token number">13</span>:32:12.842266    <span class="token number">5163</span> checks.go:610<span class="token punctuation">]</span> validating kubelet version</pre></td></tr><tr><td data-num="38"></td><td><pre>I0315 <span class="token number">13</span>:32:12.902785    <span class="token number">5163</span> checks.go:130<span class="token punctuation">]</span> validating <span class="token keyword">if</span> the <span class="token string">"kubelet"</span> <span class="token function">service</span> is enabled and active</pre></td></tr><tr><td data-num="39"></td><td><pre>I0315 <span class="token number">13</span>:32:12.909836    <span class="token number">5163</span> checks.go:203<span class="token punctuation">]</span> validating availability of port <span class="token number">10250</span></pre></td></tr><tr><td data-num="40"></td><td><pre>I0315 <span class="token number">13</span>:32:12.909923    <span class="token number">5163</span> checks.go:203<span class="token punctuation">]</span> validating availability of port <span class="token number">2379</span></pre></td></tr><tr><td data-num="41"></td><td><pre>I0315 <span class="token number">13</span>:32:12.909955    <span class="token number">5163</span> checks.go:203<span class="token punctuation">]</span> validating availability of port <span class="token number">2380</span></pre></td></tr><tr><td data-num="42"></td><td><pre>I0315 <span class="token number">13</span>:32:12.909986    <span class="token number">5163</span> checks.go:243<span class="token punctuation">]</span> validating the existence and emptiness of directory /var/lib/etcd</pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment"># 下载需要使用的镜像</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Pulling images required <span class="token keyword">for</span> setting up a Kubernetes cluster</pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> This might take a minute or two, depending on the speed of your internet connection</pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> You can also perform this action <span class="token keyword">in</span> beforehand using <span class="token string">'kubeadm config images pull'</span></pre></td></tr><tr><td data-num="47"></td><td><pre>I0315 <span class="token number">13</span>:32:12.910100    <span class="token number">5163</span> checks.go:832<span class="token punctuation">]</span> using image pull policy: IfNotPresent</pre></td></tr><tr><td data-num="48"></td><td><pre>I0315 <span class="token number">13</span>:32:12.938138    <span class="token number">5163</span> checks.go:841<span class="token punctuation">]</span> image exists: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.26.2</pre></td></tr><tr><td data-num="49"></td><td><pre>I0315 <span class="token number">13</span>:32:12.960136    <span class="token number">5163</span> checks.go:841<span class="token punctuation">]</span> image exists: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.26.2</pre></td></tr><tr><td data-num="50"></td><td><pre>I0315 <span class="token number">13</span>:32:12.981251    <span class="token number">5163</span> checks.go:841<span class="token punctuation">]</span> image exists: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.26.2</pre></td></tr><tr><td data-num="51"></td><td><pre>I0315 <span class="token number">13</span>:32:13.004735    <span class="token number">5163</span> checks.go:841<span class="token punctuation">]</span> image exists: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.26.2</pre></td></tr><tr><td data-num="52"></td><td><pre>I0315 <span class="token number">13</span>:32:13.027637    <span class="token number">5163</span> checks.go:841<span class="token punctuation">]</span> image exists: registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9</pre></td></tr><tr><td data-num="53"></td><td><pre>I0315 <span class="token number">13</span>:32:13.048944    <span class="token number">5163</span> checks.go:841<span class="token punctuation">]</span> image exists: registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.6-0</pre></td></tr><tr><td data-num="54"></td><td><pre>I0315 <span class="token number">13</span>:32:13.076044    <span class="token number">5163</span> checks.go:841<span class="token punctuation">]</span> image exists: registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.9.3</pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment"># 指定安全证书位置</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Using certificateDir folder <span class="token string">"/etc/kubernetes/pki"</span></pre></td></tr><tr><td data-num="57"></td><td><pre>I0315 <span class="token number">13</span>:32:13.076138    <span class="token number">5163</span> certs.go:112<span class="token punctuation">]</span> creating a new certificate authority <span class="token keyword">for</span> ca</pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"ca"</span> certificate and key</pre></td></tr><tr><td data-num="59"></td><td><pre>I0315 <span class="token number">13</span>:32:13.386552    <span class="token number">5163</span> certs.go:519<span class="token punctuation">]</span> validating certificate period <span class="token keyword">for</span> ca certificate</pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"apiserver"</span> certificate and key</pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment"># apiserver 指定访问服务的 DNS</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> apiserver serving cert is signed <span class="token keyword">for</span> DNS names <span class="token punctuation">[</span>k8s-master01 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local<span class="token punctuation">]</span> and IPs <span class="token punctuation">[</span><span class="token number">10.96</span>.0.1 <span class="token number">172.31</span>.5.183<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"apiserver-kubelet-client"</span> certificate and key</pre></td></tr><tr><td data-num="64"></td><td><pre>I0315 <span class="token number">13</span>:32:13.673630    <span class="token number">5163</span> certs.go:112<span class="token punctuation">]</span> creating a new certificate authority <span class="token keyword">for</span> front-proxy-ca</pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"front-proxy-ca"</span> certificate and key</pre></td></tr><tr><td data-num="66"></td><td><pre>I0315 <span class="token number">13</span>:32:13.807732    <span class="token number">5163</span> certs.go:519<span class="token punctuation">]</span> validating certificate period <span class="token keyword">for</span> front-proxy-ca certificate</pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"front-proxy-client"</span> certificate and key</pre></td></tr><tr><td data-num="68"></td><td><pre>I0315 <span class="token number">13</span>:32:13.982938    <span class="token number">5163</span> certs.go:112<span class="token punctuation">]</span> creating a new certificate authority <span class="token keyword">for</span> etcd-ca</pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"etcd/ca"</span> certificate and key</pre></td></tr><tr><td data-num="70"></td><td><pre>I0315 <span class="token number">13</span>:32:14.104051    <span class="token number">5163</span> certs.go:519<span class="token punctuation">]</span> validating certificate period <span class="token keyword">for</span> etcd/ca certificate</pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"etcd/server"</span> certificate and key</pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> etcd/server serving cert is signed <span class="token keyword">for</span> DNS names <span class="token punctuation">[</span>k8s-master01 localhost<span class="token punctuation">]</span> and IPs <span class="token punctuation">[</span><span class="token number">172.31</span>.5.183 <span class="token number">127.0</span>.0.1 ::1<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"etcd/peer"</span> certificate and key</pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> etcd/peer serving cert is signed <span class="token keyword">for</span> DNS names <span class="token punctuation">[</span>k8s-master01 localhost<span class="token punctuation">]</span> and IPs <span class="token punctuation">[</span><span class="token number">172.31</span>.5.183 <span class="token number">127.0</span>.0.1 ::1<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"etcd/healthcheck-client"</span> certificate and key</pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"apiserver-etcd-client"</span> certificate and key</pre></td></tr><tr><td data-num="77"></td><td><pre>I0315 <span class="token number">13</span>:32:14.768268    <span class="token number">5163</span> certs.go:78<span class="token punctuation">]</span> creating new public/private key files <span class="token keyword">for</span> signing <span class="token function">service</span> account <span class="token function">users</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"sa"</span> key and public key</pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token comment"># 选择 kubeconfig 文件目录，admin kubelet c-m schedulaer 等组件的配置文件</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Using kubeconfig folder <span class="token string">"/etc/kubernetes"</span></pre></td></tr><tr><td data-num="81"></td><td><pre>I0315 <span class="token number">13</span>:32:14.826756    <span class="token number">5163</span> kubeconfig.go:103<span class="token punctuation">]</span> creating kubeconfig <span class="token function">file</span> <span class="token keyword">for</span> admin.conf</pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Writing <span class="token string">"admin.conf"</span> kubeconfig <span class="token function">file</span></pre></td></tr><tr><td data-num="83"></td><td><pre>I0315 <span class="token number">13</span>:32:15.142537    <span class="token number">5163</span> kubeconfig.go:103<span class="token punctuation">]</span> creating kubeconfig <span class="token function">file</span> <span class="token keyword">for</span> kubelet.conf</pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Writing <span class="token string">"kubelet.conf"</span> kubeconfig <span class="token function">file</span></pre></td></tr><tr><td data-num="85"></td><td><pre>I0315 <span class="token number">13</span>:32:15.447166    <span class="token number">5163</span> kubeconfig.go:103<span class="token punctuation">]</span> creating kubeconfig <span class="token function">file</span> <span class="token keyword">for</span> controller-manager.conf</pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Writing <span class="token string">"controller-manager.conf"</span> kubeconfig <span class="token function">file</span></pre></td></tr><tr><td data-num="87"></td><td><pre>I0315 <span class="token number">13</span>:32:15.910735    <span class="token number">5163</span> kubeconfig.go:103<span class="token punctuation">]</span> creating kubeconfig <span class="token function">file</span> <span class="token keyword">for</span> scheduler.conf</pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Writing <span class="token string">"scheduler.conf"</span> kubeconfig <span class="token function">file</span></pre></td></tr><tr><td data-num="89"></td><td><pre>I0315 <span class="token number">13</span>:32:16.024770    <span class="token number">5163</span> kubelet.go:67<span class="token punctuation">]</span> Stopping the kubelet</pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token comment"># kubelet 环境变量</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet environment <span class="token function">file</span> with flags to <span class="token function">file</span> <span class="token string">"/var/lib/kubelet/kubeadm-flags.env"</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment"># kubelet 配置文件</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet configuration to <span class="token function">file</span> <span class="token string">"/var/lib/kubelet/config.yaml"</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token comment"># 启动 kubelet</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Starting the kubelet</pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token comment"># 指定 K8S 清单所在目录 /etc/kubernetes/manifests</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token comment"># 这个清单目录很关键，目录下的所有 pod 会在初始化时完成创建</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> Using manifest folder <span class="token string">"/etc/kubernetes/manifests"</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> Creating static Pod manifest <span class="token keyword">for</span> <span class="token string">"kube-apiserver"</span></pre></td></tr><tr><td data-num="100"></td><td><pre>I0315 <span class="token number">13</span>:32:16.107767    <span class="token number">5163</span> manifests.go:99<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> getting StaticPodSpecs</pre></td></tr><tr><td data-num="101"></td><td><pre>I0315 <span class="token number">13</span>:32:16.108021    <span class="token number">5163</span> certs.go:519<span class="token punctuation">]</span> validating certificate period <span class="token keyword">for</span> CA certificate</pre></td></tr><tr><td data-num="102"></td><td><pre>I0315 <span class="token number">13</span>:32:16.108112    <span class="token number">5163</span> manifests.go:125<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> adding volume <span class="token string">"ca-certs"</span> <span class="token keyword">for</span> component <span class="token string">"kube-apiserver"</span></pre></td></tr><tr><td data-num="103"></td><td><pre>I0315 <span class="token number">13</span>:32:16.108122    <span class="token number">5163</span> manifests.go:125<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> adding volume <span class="token string">"etc-pki"</span> <span class="token keyword">for</span> component <span class="token string">"kube-apiserver"</span></pre></td></tr><tr><td data-num="104"></td><td><pre>I0315 <span class="token number">13</span>:32:16.108130    <span class="token number">5163</span> manifests.go:125<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> adding volume <span class="token string">"k8s-certs"</span> <span class="token keyword">for</span> component <span class="token string">"kube-apiserver"</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token comment"># kube-apiserver 组件创建</span></pre></td></tr><tr><td data-num="106"></td><td><pre>I0315 <span class="token number">13</span>:32:16.111358    <span class="token number">5163</span> manifests.go:154<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> wrote static Pod manifest <span class="token keyword">for</span> component <span class="token string">"kube-apiserver"</span> to <span class="token string">"/etc/kubernetes/manifests/kube-apiserver.yaml"</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> Creating static Pod manifest <span class="token keyword">for</span> <span class="token string">"kube-controller-manager"</span></pre></td></tr><tr><td data-num="108"></td><td><pre>I0315 <span class="token number">13</span>:32:16.111389    <span class="token number">5163</span> manifests.go:99<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> getting StaticPodSpecs</pre></td></tr><tr><td data-num="109"></td><td><pre>I0315 <span class="token number">13</span>:32:16.111647    <span class="token number">5163</span> manifests.go:125<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> adding volume <span class="token string">"ca-certs"</span> <span class="token keyword">for</span> component <span class="token string">"kube-controller-manager"</span></pre></td></tr><tr><td data-num="110"></td><td><pre>I0315 <span class="token number">13</span>:32:16.111664    <span class="token number">5163</span> manifests.go:125<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> adding volume <span class="token string">"etc-pki"</span> <span class="token keyword">for</span> component <span class="token string">"kube-controller-manager"</span></pre></td></tr><tr><td data-num="111"></td><td><pre>I0315 <span class="token number">13</span>:32:16.111674    <span class="token number">5163</span> manifests.go:125<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> adding volume <span class="token string">"flexvolume-dir"</span> <span class="token keyword">for</span> component <span class="token string">"kube-controller-manager"</span></pre></td></tr><tr><td data-num="112"></td><td><pre>I0315 <span class="token number">13</span>:32:16.111682    <span class="token number">5163</span> manifests.go:125<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> adding volume <span class="token string">"k8s-certs"</span> <span class="token keyword">for</span> component <span class="token string">"kube-controller-manager"</span></pre></td></tr><tr><td data-num="113"></td><td><pre>I0315 <span class="token number">13</span>:32:16.111690    <span class="token number">5163</span> manifests.go:125<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> adding volume <span class="token string">"kubeconfig"</span> <span class="token keyword">for</span> component <span class="token string">"kube-controller-manager"</span></pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token comment"># kube-controller-manager 组件创建</span></pre></td></tr><tr><td data-num="115"></td><td><pre>I0315 <span class="token number">13</span>:32:16.112773    <span class="token number">5163</span> manifests.go:154<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> wrote static Pod manifest <span class="token keyword">for</span> component <span class="token string">"kube-controller-manager"</span> to <span class="token string">"/etc/kubernetes/manifests/kube-controller-manager.yaml"</span></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> Creating static Pod manifest <span class="token keyword">for</span> <span class="token string">"kube-scheduler"</span></pre></td></tr><tr><td data-num="117"></td><td><pre>I0315 <span class="token number">13</span>:32:16.112857    <span class="token number">5163</span> manifests.go:99<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> getting StaticPodSpecs</pre></td></tr><tr><td data-num="118"></td><td><pre>I0315 <span class="token number">13</span>:32:16.113280    <span class="token number">5163</span> manifests.go:125<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> adding volume <span class="token string">"kubeconfig"</span> <span class="token keyword">for</span> component <span class="token string">"kube-scheduler"</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token comment"># scheduler 组件创建</span></pre></td></tr><tr><td data-num="120"></td><td><pre>I0315 <span class="token number">13</span>:32:16.119665    <span class="token number">5163</span> manifests.go:154<span class="token punctuation">]</span> <span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> wrote static Pod manifest <span class="token keyword">for</span> component <span class="token string">"kube-scheduler"</span> to <span class="token string">"/etc/kubernetes/manifests/kube-scheduler.yaml"</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token comment"># 创建清单下的 pod</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token punctuation">[</span>etcd<span class="token punctuation">]</span> Creating static Pod manifest <span class="token keyword">for</span> <span class="token builtin class-name">local</span> etcd <span class="token keyword">in</span> <span class="token string">"/etc/kubernetes/manifests"</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token comment"># etcd 组件创建</span></pre></td></tr><tr><td data-num="124"></td><td><pre>I0315 <span class="token number">13</span>:32:16.120549    <span class="token number">5163</span> local.go:65<span class="token punctuation">]</span> <span class="token punctuation">[</span>etcd<span class="token punctuation">]</span> wrote Static Pod manifest <span class="token keyword">for</span> a <span class="token builtin class-name">local</span> etcd member to <span class="token string">"/etc/kubernetes/manifests/etcd.yaml"</span></pre></td></tr><tr><td data-num="125"></td><td><pre>I0315 <span class="token number">13</span>:32:16.120563    <span class="token number">5163</span> waitcontrolplane.go:83<span class="token punctuation">]</span> <span class="token punctuation">[</span>wait-control-plane<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> the API server to be healthy</pre></td></tr><tr><td data-num="126"></td><td><pre>I0315 <span class="token number">13</span>:32:16.121370    <span class="token number">5163</span> loader.go:373<span class="token punctuation">]</span> Config loaded from file:  /etc/kubernetes/admin.conf</pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token comment"># 引导 /etc/kubernetes/manifests 下的 yaml 文件，创建相应的 pod</span></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token punctuation">[</span>wait-control-plane<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="token string">"/etc/kubernetes/manifests"</span><span class="token builtin class-name">.</span> This can take up to 4m0s</pre></td></tr><tr><td data-num="129"></td><td><pre>I0315 <span class="token number">13</span>:32:16.122618    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> GET https://172.31.5.183:6443/healthz?timeout<span class="token operator">=</span>10s  <span class="token keyword">in</span> <span class="token number">0</span> milliseconds</pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="131"></td><td><pre>I0315 <span class="token number">13</span>:32:23.624126    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> GET https://172.31.5.183:6443/healthz?timeout<span class="token operator">=</span>10s <span class="token number">200</span> OK <span class="token keyword">in</span> <span class="token number">0</span> milliseconds</pre></td></tr><tr><td data-num="132"></td><td><pre><span class="token punctuation">[</span>apiclient<span class="token punctuation">]</span> All control plane components are healthy after <span class="token number">7.502199</span> seconds</pre></td></tr><tr><td data-num="133"></td><td><pre>I0315 <span class="token number">13</span>:32:23.624296    <span class="token number">5163</span> uploadconfig.go:111<span class="token punctuation">]</span> <span class="token punctuation">[</span>upload-config<span class="token punctuation">]</span> Uploading the kubeadm ClusterConfiguration to a ConfigMap</pre></td></tr><tr><td data-num="134"></td><td><pre><span class="token punctuation">[</span>upload-config<span class="token punctuation">]</span> Storing the configuration used <span class="token keyword">in</span> ConfigMap <span class="token string">"kubeadm-config"</span> <span class="token keyword">in</span> the <span class="token string">"kube-system"</span> Namespace</pre></td></tr><tr><td data-num="135"></td><td><pre>I0315 <span class="token number">13</span>:32:23.627093    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/api/v1/namespaces/kube-system/configmaps?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">2</span> milliseconds</pre></td></tr><tr><td data-num="136"></td><td><pre>I0315 <span class="token number">13</span>:32:23.630797    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-system/roles?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">3</span> milliseconds</pre></td></tr><tr><td data-num="137"></td><td><pre>I0315 <span class="token number">13</span>:32:23.633767    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-system/rolebindings?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">2</span> milliseconds</pre></td></tr><tr><td data-num="138"></td><td><pre>I0315 <span class="token number">13</span>:32:23.633969    <span class="token number">5163</span> uploadconfig.go:125<span class="token punctuation">]</span> <span class="token punctuation">[</span>upload-config<span class="token punctuation">]</span> Uploading the kubelet component config to a ConfigMap</pre></td></tr><tr><td data-num="139"></td><td><pre><span class="token punctuation">[</span>kubelet<span class="token punctuation">]</span> Creating a ConfigMap <span class="token string">"kubelet-config"</span> <span class="token keyword">in</span> namespace kube-system with the configuration <span class="token keyword">for</span> the kubelets <span class="token keyword">in</span> the cluster</pre></td></tr><tr><td data-num="140"></td><td><pre>I0315 <span class="token number">13</span>:32:23.636413    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/api/v1/namespaces/kube-system/configmaps?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">1</span> milliseconds</pre></td></tr><tr><td data-num="141"></td><td><pre>I0315 <span class="token number">13</span>:32:23.638633    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-system/roles?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">1</span> milliseconds</pre></td></tr><tr><td data-num="142"></td><td><pre>I0315 <span class="token number">13</span>:32:23.640878    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-system/rolebindings?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">1</span> milliseconds</pre></td></tr><tr><td data-num="143"></td><td><pre>I0315 <span class="token number">13</span>:32:23.641126    <span class="token number">5163</span> uploadconfig.go:130<span class="token punctuation">]</span> <span class="token punctuation">[</span>upload-config<span class="token punctuation">]</span> Preserving the CRISocket information <span class="token keyword">for</span> the control-plane node</pre></td></tr><tr><td data-num="144"></td><td><pre>I0315 <span class="token number">13</span>:32:23.641148    <span class="token number">5163</span> patchnode.go:31<span class="token punctuation">]</span> <span class="token punctuation">[</span>patchnode<span class="token punctuation">]</span> Uploading the CRI Socket information <span class="token string">"unix:///var/run/containerd/containerd.sock"</span> to the Node API object <span class="token string">"k8s-master01"</span> as an annotation</pre></td></tr><tr><td data-num="145"></td><td><pre>I0315 <span class="token number">13</span>:32:24.143734    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> GET https://172.31.5.183:6443/api/v1/nodes/k8s-master01?timeout<span class="token operator">=</span>10s <span class="token number">200</span> OK <span class="token keyword">in</span> <span class="token number">1</span> milliseconds</pre></td></tr><tr><td data-num="146"></td><td><pre>I0315 <span class="token number">13</span>:32:24.148834    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> PATCH https://172.31.5.183:6443/api/v1/nodes/k8s-master01?timeout<span class="token operator">=</span>10s <span class="token number">200</span> OK <span class="token keyword">in</span> <span class="token number">3</span> milliseconds</pre></td></tr><tr><td data-num="147"></td><td><pre><span class="token punctuation">[</span>upload-certs<span class="token punctuation">]</span> Skipping phase. Please see --upload-certs</pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token punctuation">[</span>mark-control-plane<span class="token punctuation">]</span> Marking the node k8s-master01 as control-plane by adding the labels: <span class="token punctuation">[</span>node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token punctuation">[</span>mark-control-plane<span class="token punctuation">]</span> Marking the node k8s-master01 as control-plane by adding the taints <span class="token punctuation">[</span>node-role.kubernetes.io/control-plane:NoSchedule<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="150"></td><td><pre>I0315 <span class="token number">13</span>:32:24.652027    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> GET https://172.31.5.183:6443/api/v1/nodes/k8s-master01?timeout<span class="token operator">=</span>10s <span class="token number">200</span> OK <span class="token keyword">in</span> <span class="token number">1</span> milliseconds</pre></td></tr><tr><td data-num="151"></td><td><pre>I0315 <span class="token number">13</span>:32:24.657497    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> PATCH https://172.31.5.183:6443/api/v1/nodes/k8s-master01?timeout<span class="token operator">=</span>10s <span class="token number">200</span> OK <span class="token keyword">in</span> <span class="token number">4</span> milliseconds</pre></td></tr><tr><td data-num="152"></td><td><pre><span class="token comment"># 初始化 K8S 的 RBAC 授权</span></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> Using token: abcdef.0123456789abcdef</pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</pre></td></tr><tr><td data-num="155"></td><td><pre>I0315 <span class="token number">13</span>:32:24.659031    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> GET https://172.31.5.183:6443/api/v1/namespaces/kube-system/secrets/bootstrap-token-abcdef?timeout<span class="token operator">=</span>10s <span class="token number">404</span> Not Found <span class="token keyword">in</span> <span class="token number">1</span> milliseconds</pre></td></tr><tr><td data-num="156"></td><td><pre>I0315 <span class="token number">13</span>:32:24.661635    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/api/v1/namespaces/kube-system/secrets?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">2</span> milliseconds</pre></td></tr><tr><td data-num="157"></td><td><pre><span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> Configured RBAC rules to allow Node Bootstrap tokens to get nodes</pre></td></tr><tr><td data-num="158"></td><td><pre>I0315 <span class="token number">13</span>:32:24.664167    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/clusterroles?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">2</span> milliseconds</pre></td></tr><tr><td data-num="159"></td><td><pre>I0315 <span class="token number">13</span>:32:24.667064    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/clusterrolebindings?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">2</span> milliseconds</pre></td></tr><tr><td data-num="160"></td><td><pre><span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> Configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="token keyword">in</span> order <span class="token keyword">for</span> nodes to get long term certificate credentials</pre></td></tr><tr><td data-num="161"></td><td><pre>I0315 <span class="token number">13</span>:32:24.669245    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/clusterrolebindings?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">1</span> milliseconds</pre></td></tr><tr><td data-num="162"></td><td><pre><span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</pre></td></tr><tr><td data-num="163"></td><td><pre>I0315 <span class="token number">13</span>:32:24.671624    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/clusterrolebindings?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">2</span> milliseconds</pre></td></tr><tr><td data-num="164"></td><td><pre><span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> Configured RBAC rules to allow certificate rotation <span class="token keyword">for</span> all node client certificates <span class="token keyword">in</span> the cluster</pre></td></tr><tr><td data-num="165"></td><td><pre>I0315 <span class="token number">13</span>:32:24.673913    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/clusterrolebindings?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">1</span> milliseconds</pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> Creating the <span class="token string">"cluster-info"</span> ConfigMap <span class="token keyword">in</span> the <span class="token string">"kube-public"</span> namespace</pre></td></tr><tr><td data-num="167"></td><td><pre>I0315 <span class="token number">13</span>:32:24.674044    <span class="token number">5163</span> clusterinfo.go:47<span class="token punctuation">]</span> <span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> loading admin kubeconfig</pre></td></tr><tr><td data-num="168"></td><td><pre>I0315 <span class="token number">13</span>:32:24.674972    <span class="token number">5163</span> loader.go:373<span class="token punctuation">]</span> Config loaded from file:  /etc/kubernetes/admin.conf</pre></td></tr><tr><td data-num="169"></td><td><pre>I0315 <span class="token number">13</span>:32:24.674997    <span class="token number">5163</span> clusterinfo.go:58<span class="token punctuation">]</span> <span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> copying the cluster from admin.conf to the bootstrap kubeconfig</pre></td></tr><tr><td data-num="170"></td><td><pre>I0315 <span class="token number">13</span>:32:24.675312    <span class="token number">5163</span> clusterinfo.go:70<span class="token punctuation">]</span> <span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> creating/updating ConfigMap <span class="token keyword">in</span> kube-public namespace</pre></td></tr><tr><td data-num="171"></td><td><pre>I0315 <span class="token number">13</span>:32:24.680193    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/api/v1/namespaces/kube-public/configmaps?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">4</span> milliseconds</pre></td></tr><tr><td data-num="172"></td><td><pre>I0315 <span class="token number">13</span>:32:24.680339    <span class="token number">5163</span> clusterinfo.go:84<span class="token punctuation">]</span> creating the RBAC rules <span class="token keyword">for</span> exposing the cluster-info ConfigMap <span class="token keyword">in</span> the kube-public namespace</pre></td></tr><tr><td data-num="173"></td><td><pre>I0315 <span class="token number">13</span>:32:24.682263    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-public/roles?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">1</span> milliseconds</pre></td></tr><tr><td data-num="174"></td><td><pre>I0315 <span class="token number">13</span>:32:24.684307    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-public/rolebindings?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">1</span> milliseconds</pre></td></tr><tr><td data-num="175"></td><td><pre>I0315 <span class="token number">13</span>:32:24.684522    <span class="token number">5163</span> kubeletfinalize.go:90<span class="token punctuation">]</span> <span class="token punctuation">[</span>kubelet-finalize<span class="token punctuation">]</span> Assuming that kubelet client certificate rotation is enabled: found <span class="token string">"/var/lib/kubelet/pki/kubelet-client-current.pem"</span></pre></td></tr><tr><td data-num="176"></td><td><pre><span class="token punctuation">[</span>kubelet-finalize<span class="token punctuation">]</span> Updating <span class="token string">"/etc/kubernetes/kubelet.conf"</span> to point to a rotatable kubelet client certificate and key</pre></td></tr><tr><td data-num="177"></td><td><pre>I0315 <span class="token number">13</span>:32:24.685041    <span class="token number">5163</span> loader.go:373<span class="token punctuation">]</span> Config loaded from file:  /etc/kubernetes/kubelet.conf</pre></td></tr><tr><td data-num="178"></td><td><pre>I0315 <span class="token number">13</span>:32:24.685841    <span class="token number">5163</span> kubeletfinalize.go:134<span class="token punctuation">]</span> <span class="token punctuation">[</span>kubelet-finalize<span class="token punctuation">]</span> Restarting the kubelet to <span class="token builtin class-name">enable</span> client certificate rotation</pre></td></tr><tr><td data-num="179"></td><td><pre>I0315 <span class="token number">13</span>:32:24.848088    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> GET https://172.31.5.183:6443/apis/apps/v1/namespaces/kube-system/deployments?labelSelector<span class="token operator">=</span>k8s-app%3Dkube-dns <span class="token number">200</span> OK <span class="token keyword">in</span> <span class="token number">18</span> milliseconds</pre></td></tr><tr><td data-num="180"></td><td><pre>I0315 <span class="token number">13</span>:32:24.853082    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> GET https://172.31.5.183:6443/api/v1/namespaces/kube-system/configmaps/coredns?timeout<span class="token operator">=</span>10s <span class="token number">404</span> Not Found <span class="token keyword">in</span> <span class="token number">2</span> milliseconds</pre></td></tr><tr><td data-num="181"></td><td><pre>I0315 <span class="token number">13</span>:32:24.860986    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/api/v1/namespaces/kube-system/configmaps?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">7</span> milliseconds</pre></td></tr><tr><td data-num="182"></td><td><pre>I0315 <span class="token number">13</span>:32:24.865313    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/clusterroles?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">3</span> milliseconds</pre></td></tr><tr><td data-num="183"></td><td><pre>I0315 <span class="token number">13</span>:32:24.868570    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/clusterrolebindings?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">2</span> milliseconds</pre></td></tr><tr><td data-num="184"></td><td><pre>I0315 <span class="token number">13</span>:32:24.871817    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/api/v1/namespaces/kube-system/serviceaccounts?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">2</span> milliseconds</pre></td></tr><tr><td data-num="185"></td><td><pre>I0315 <span class="token number">13</span>:32:24.880695    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/apps/v1/namespaces/kube-system/deployments?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">7</span> milliseconds</pre></td></tr><tr><td data-num="186"></td><td><pre>I0315 <span class="token number">13</span>:32:24.895778    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/api/v1/namespaces/kube-system/services?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">13</span> milliseconds</pre></td></tr><tr><td data-num="187"></td><td><pre><span class="token comment"># 添加 K8S 插件</span></pre></td></tr><tr><td data-num="188"></td><td><pre><span class="token punctuation">[</span>addons<span class="token punctuation">]</span> Applied essential addon: CoreDNS</pre></td></tr><tr><td data-num="189"></td><td><pre>I0315 <span class="token number">13</span>:32:24.900577    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/api/v1/namespaces/kube-system/configmaps?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">3</span> milliseconds</pre></td></tr><tr><td data-num="190"></td><td><pre>I0315 <span class="token number">13</span>:32:24.907631    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/apps/v1/namespaces/kube-system/daemonsets?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">5</span> milliseconds</pre></td></tr><tr><td data-num="191"></td><td><pre>I0315 <span class="token number">13</span>:32:24.911231    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/api/v1/namespaces/kube-system/serviceaccounts?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">2</span> milliseconds</pre></td></tr><tr><td data-num="192"></td><td><pre>I0315 <span class="token number">13</span>:32:24.914353    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/clusterrolebindings?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">2</span> milliseconds</pre></td></tr><tr><td data-num="193"></td><td><pre>I0315 <span class="token number">13</span>:32:24.917490    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-system/roles?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">2</span> milliseconds</pre></td></tr><tr><td data-num="194"></td><td><pre>I0315 <span class="token number">13</span>:32:25.062913    <span class="token number">5163</span> request.go:622<span class="token punctuation">]</span> Waited <span class="token keyword">for</span> <span class="token number">145</span>.251945ms due to client-side throttling, not priority and fairness, request: POST:https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-system/rolebindings?timeout<span class="token operator">=</span>10s</pre></td></tr><tr><td data-num="195"></td><td><pre>I0315 <span class="token number">13</span>:32:25.068061    <span class="token number">5163</span> round_trippers.go:553<span class="token punctuation">]</span> POST https://172.31.5.183:6443/apis/rbac.authorization.k8s.io/v1/namespaces/kube-system/rolebindings?timeout<span class="token operator">=</span>10s <span class="token number">201</span> Created <span class="token keyword">in</span> <span class="token number">5</span> milliseconds</pre></td></tr><tr><td data-num="196"></td><td><pre><span class="token comment"># 添加 K8S 附件</span></pre></td></tr><tr><td data-num="197"></td><td><pre><span class="token punctuation">[</span>addons<span class="token punctuation">]</span> Applied essential addon: kube-proxy</pre></td></tr><tr><td data-num="198"></td><td><pre>I0315 <span class="token number">13</span>:32:25.068748    <span class="token number">5163</span> loader.go:373<span class="token punctuation">]</span> Config loaded from file:  /etc/kubernetes/admin.conf</pre></td></tr><tr><td data-num="199"></td><td><pre>I0315 <span class="token number">13</span>:32:25.069192    <span class="token number">5163</span> loader.go:373<span class="token punctuation">]</span> Config loaded from file:  /etc/kubernetes/admin.conf</pre></td></tr><tr><td data-num="200"></td><td><pre>Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span></pre></td></tr><tr><td data-num="201"></td><td><pre>To start using your cluster, you need to run the following as a regular user:</pre></td></tr><tr><td data-num="202"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span>.</pre></td></tr></table></figure><p>kubelet 的 config:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">cat</span> /var/lib/kubelet/config.yaml</pre></td></tr><tr><td data-num="2"></td><td><pre>apiVersion: kubelet.config.k8s.io/v1beta1</pre></td></tr><tr><td data-num="3"></td><td><pre>authentication:</pre></td></tr><tr><td data-num="4"></td><td><pre>  anonymous:</pre></td></tr><tr><td data-num="5"></td><td><pre>    enabled: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  webhook:</pre></td></tr><tr><td data-num="7"></td><td><pre>    cacheTTL: 0s</pre></td></tr><tr><td data-num="8"></td><td><pre>    enabled: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  x509:</pre></td></tr><tr><td data-num="10"></td><td><pre>    clientCAFile: /etc/kubernetes/pki/ca.crt</pre></td></tr><tr><td data-num="11"></td><td><pre>authorization:</pre></td></tr><tr><td data-num="12"></td><td><pre>  mode: Webhook</pre></td></tr><tr><td data-num="13"></td><td><pre>  webhook:</pre></td></tr><tr><td data-num="14"></td><td><pre>    cacheAuthorizedTTL: 0s</pre></td></tr><tr><td data-num="15"></td><td><pre>    cacheUnauthorizedTTL: 0s</pre></td></tr><tr><td data-num="16"></td><td><pre>cgroupDriver: systemd</pre></td></tr><tr><td data-num="17"></td><td><pre>clusterDNS:</pre></td></tr><tr><td data-num="18"></td><td><pre>- <span class="token number">10.96</span>.0.10</pre></td></tr><tr><td data-num="19"></td><td><pre>clusterDomain: cluster.local</pre></td></tr><tr><td data-num="20"></td><td><pre>cpuManagerReconcilePeriod: 0s</pre></td></tr><tr><td data-num="21"></td><td><pre>evictionPressureTransitionPeriod: 0s</pre></td></tr><tr><td data-num="22"></td><td><pre>fileCheckFrequency: 0s</pre></td></tr><tr><td data-num="23"></td><td><pre>healthzBindAddress: <span class="token number">127.0</span>.0.1</pre></td></tr><tr><td data-num="24"></td><td><pre>healthzPort: <span class="token number">10248</span></pre></td></tr><tr><td data-num="25"></td><td><pre>httpCheckFrequency: 0s</pre></td></tr><tr><td data-num="26"></td><td><pre>imageMinimumGCAge: 0s</pre></td></tr><tr><td data-num="27"></td><td><pre>kind: KubeletConfiguration</pre></td></tr><tr><td data-num="28"></td><td><pre>logging:</pre></td></tr><tr><td data-num="29"></td><td><pre>  flushFrequency: <span class="token number">0</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  options:</pre></td></tr><tr><td data-num="31"></td><td><pre>    json:</pre></td></tr><tr><td data-num="32"></td><td><pre>      infoBufferSize: <span class="token string">"0"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  verbosity: <span class="token number">0</span></pre></td></tr><tr><td data-num="34"></td><td><pre>memorySwap: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>nodeStatusReportFrequency: 0s</pre></td></tr><tr><td data-num="36"></td><td><pre>nodeStatusUpdateFrequency: 0s</pre></td></tr><tr><td data-num="37"></td><td><pre>rotateCertificates: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="38"></td><td><pre>runtimeRequestTimeout: 0s</pre></td></tr><tr><td data-num="39"></td><td><pre>shutdownGracePeriod: 0s</pre></td></tr><tr><td data-num="40"></td><td><pre>shutdownGracePeriodCriticalPods: 0s</pre></td></tr><tr><td data-num="41"></td><td><pre>staticPodPath: /etc/kubernetes/manifests</pre></td></tr><tr><td data-num="42"></td><td><pre>streamingConnectionIdleTimeout: 0s</pre></td></tr><tr><td data-num="43"></td><td><pre>syncFrequency: 0s</pre></td></tr><tr><td data-num="44"></td><td><pre>volumeStatsAggPeriod: 0s</pre></td></tr></table></figure><h1 id="六k8s的资源"><a class="anchor" href="#六k8s的资源">#</a> 六.K8S 的资源</h1>
<h2 id="什么是资源"><a class="anchor" href="#什么是资源">#</a> 什么是资源</h2>
<p>K8S 中，所有的内容都抽象为 <code>资源</code> ，资源实例化之后 叫做 <code>对象</code></p>
<h3 id="资源的分类"><a class="anchor" href="#资源的分类">#</a> 资源的分类</h3>
<h4 id="名称空间级资源"><a class="anchor" href="#名称空间级资源">#</a> 名称空间级资源</h4>
<p>资源按照不同名称空间划分隔离 ( <code>kubelctl get pod -n namespace </code> )</p>
<p>工作负载型资源: Pod, RS, Deployment...</p>
<p>服务发现及负载均衡型资源: Service, Ingress...</p>
<p>配置与存储型资源: Volune, CSI...</p>
<p>特殊类型存储卷: configMap, secre...</p>
<h4 id="集群级资源"><a class="anchor" href="#集群级资源">#</a> 集群级资源</h4>
<p>Namespace, Node, ClusterRole</p>
<h4 id="元数据型资源"><a class="anchor" href="#元数据型资源">#</a> 元数据型资源</h4>
<p>HPA, PodTemplate, LimitRange</p>
<h3 id="资源清单"><a class="anchor" href="#资源清单">#</a> 资源清单</h3>
<p>资源清单用来描述一个资源的创建要求，K8S 根据资源清单 来解读及达到期望资源</p>
<p>在 k8s 中，一般使用 <code>yaml</code>  格式的文件来创建符合我们预期期望的 pod, <mark>这样的 yaml 文件我们一般称为资源清单</mark></p>
<h2 id="资源清单格式"><a class="anchor" href="#资源清单格式">#</a> 资源清单格式</h2>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 如果没有给定 group 名称，那么默认为 core，可以使用 kubectl api-versions </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 获取当前 k8s 版本上所有的 apiVersion 版本信息 (每个版本可能不同)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> group/apiversion  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span>       <span class="token comment">#资源类别</span></pre></td></tr><tr><td data-num="5"></td><td><pre>metadata：  <span class="token comment">#资源元数据</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   name</pre></td></tr><tr><td data-num="7"></td><td><pre>   namespace.</pre></td></tr><tr><td data-num="8"></td><td><pre>   lables</pre></td></tr><tr><td data-num="9"></td><td><pre>   annotations   <span class="token comment"># 主要目的是方便用户阅读查找</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 期望的状态（disired state）</span></pre></td></tr><tr><td data-num="11"></td><td><pre>status：<span class="token comment"># 当前状态，本字段有 Kubernetes 自身维护，用户不能去定义</span></pre></td></tr></table></figure><blockquote>
<p>配置清单主要有五个<strong>一级字段</strong>，其中 status 用户不能定义，有 k8s 自身维护</p>
</blockquote>
<h2 id="资源清单的常用命令"><a class="anchor" href="#资源清单的常用命令">#</a> 资源清单的常用命令</h2>
<p><strong>获取 apiversion 版本信息</strong></p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl api-versions </span></pre></td></tr><tr><td data-num="2"></td><td><pre>admissionregistration.k8s.io/v1beta1</pre></td></tr><tr><td data-num="3"></td><td><pre>apiextensions.k8s.io/v1beta1</pre></td></tr><tr><td data-num="4"></td><td><pre>apiregistration.k8s.io/v1</pre></td></tr><tr><td data-num="5"></td><td><pre>apiregistration.k8s.io/v1beta1</pre></td></tr><tr><td data-num="6"></td><td><pre>apps/v1</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">(</span>以下省略<span class="token punctuation">)</span></pre></td></tr></table></figure><p><strong>获取资源的 apiVersion 版本信息</strong></p>
<pre><code class="language-shel">[root@k8s-master01 ~]# kubectl explain pod
KIND:     Pod
VERSION:  v1
.....(以下省略)

[root@k8s-master01 ~]# kubectl explain Ingress
KIND:     Ingress
VERSION:  extensions/v1beta1
</code></pre>
<p><strong>获取字段设置帮助文档</strong></p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre>KIND:     Pod</pre></td></tr><tr><td data-num="3"></td><td><pre>VERSION:  v1</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>DESCRIPTION:</pre></td></tr><tr><td data-num="6"></td><td><pre>     Pod is a collection of containers that can run on a host. This resource is</pre></td></tr><tr><td data-num="7"></td><td><pre>     created by clients and scheduled onto hosts.</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>FIELDS:</pre></td></tr><tr><td data-num="10"></td><td><pre>   apiVersion    <span class="token operator">&lt;</span>string<span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre>     <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr><tr><td data-num="12"></td><td><pre>     <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr></table></figure><p><strong>字段配置格式</strong></p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre>apiVersion &lt;string<span class="token punctuation">></span>          <span class="token comment">#表示字符串类型</span></pre></td></tr><tr><td data-num="2"></td><td><pre>metadata &lt;Object<span class="token punctuation">></span>            <span class="token comment">#表示需要嵌套多层字段</span></pre></td></tr><tr><td data-num="3"></td><td><pre>labels &lt;map<span class="token punctuation">[</span>string<span class="token punctuation">]</span>string<span class="token punctuation">></span>   <span class="token comment">#表示由 k:v 组成的映射</span></pre></td></tr><tr><td data-num="4"></td><td><pre>finalizers &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>string<span class="token punctuation">></span>        <span class="token comment">#表示字串列表</span></pre></td></tr><tr><td data-num="5"></td><td><pre>ownerReferences &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">></span>   <span class="token comment">#表示对象列表</span></pre></td></tr><tr><td data-num="6"></td><td><pre>hostPID &lt;boolean<span class="token punctuation">></span>            <span class="token comment">#布尔类型</span></pre></td></tr><tr><td data-num="7"></td><td><pre>priority &lt;integer<span class="token punctuation">></span>           <span class="token comment">#整型</span></pre></td></tr><tr><td data-num="8"></td><td><pre>name &lt;string<span class="token punctuation">></span> <span class="token punctuation">-</span>required<span class="token punctuation">-</span>     <span class="token comment">#如果类型后面接 -required-，表示为必填字段</span></pre></td></tr></table></figure><h2 id="通过定义清单文件创建-pod"><a class="anchor" href="#通过定义清单文件创建-pod">#</a> 通过定义清单文件创建 Pod</h2>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>demo</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span><span class="token number">1</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.hongfu.com/library/myapp<span class="token punctuation">:</span>v1</pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox<span class="token punctuation">-</span><span class="token number">1</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.hongfu.com/library/busybox<span class="token punctuation">:</span>v1</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">-</span> <span class="token string">"-c"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">-</span> <span class="token string">"sleep 3600"</span></pre></td></tr></table></figure><pre><code class="language-she">kubectl get pod xx.xx.xx -o yaml  
&lt;!--使用 -o 参数 加 yaml，可以将资源的配置以 yaml的格式输出出来，也可以使用json，输出为json格式--&gt; 
</code></pre>
<p>&lt;!-- 资源被创建的流程：Kubectl（Yaml）&gt;&gt;&gt; KubeapiServer（Json）--&gt;</p>
<h2 id="init-容器"><a class="anchor" href="#init-容器">#</a> Init 容器</h2>
<h5 id="init-模板"><a class="anchor" href="#init-模板">#</a> init 模板</h5>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>container</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span>  harbor.hongfu.com/library/busybox<span class="token punctuation">:</span>v1</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'echo The app is running! &amp;&amp; sleep 3600'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">initContainers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>myservice</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span>  harbor.hongfu.com/library/busybox<span class="token punctuation">:</span>v1</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'until nslookup myservice; do echo waiting for myservice; sleep 2; done;'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>mydb</pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.hongfu.com/library/busybox<span class="token punctuation">:</span>v1</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'until nslookup mydb; do echo waiting for mydb; sleep 2; done;'</span><span class="token punctuation">]</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myservice</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9376</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mydb</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9377</span></pre></td></tr></table></figure><h2 id="检测探针-就绪检测"><a class="anchor" href="#检测探针-就绪检测">#</a> 检测探针 - 就绪检测</h2>
<h5 id="readinessprobe-httpget"><a class="anchor" href="#readinessprobe-httpget">#</a> readinessProbe-httpget</h5>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> readiness<span class="token punctuation">-</span>httpget<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> readiness<span class="token punctuation">-</span>httpget<span class="token punctuation">-</span>container</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> wangyanglinux/myapp<span class="token punctuation">:</span>v1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /index1.html</pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr></table></figure><h2 id="检测探针-存活检测"><a class="anchor" href="#检测探针-存活检测">#</a> 检测探针 - 存活检测</h2>
<h5 id="livenessprobe-exec"><a class="anchor" href="#livenessprobe-exec">#</a> livenessProbe-exec</h5>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>container</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.hongfu.com/library/busybox<span class="token punctuation">:</span>v1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span>"touch /tmp/live ; sleep 60; rm <span class="token punctuation">-</span>rf /tmp/live; sleep</pre></td></tr><tr><td data-num="12"></td><td><pre>3600"<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">exec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"-e"</span><span class="token punctuation">,</span><span class="token string">"/tmp/live"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr></table></figure><h5 id="livenessprobe-httpget"><a class="anchor" href="#livenessprobe-httpget">#</a> livenessProbe-httpget</h5>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>httpget<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>httpget<span class="token punctuation">-</span>container</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.hongfu.com/library/myapp<span class="token punctuation">:</span>v1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http</pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /index.html</pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr></table></figure><h5 id="livenessprobe-tcp"><a class="anchor" href="#livenessprobe-tcp">#</a> livenessProbe-tcp</h5>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> probe<span class="token punctuation">-</span>tcp</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.hongfu.com/library/myapp<span class="token punctuation">:</span>v1</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr></table></figure><h2 id="启动-退出动作"><a class="anchor" href="#启动-退出动作">#</a> 启动、退出动作</h2>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> lifecycle<span class="token punctuation">-</span>demo</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lifecycle<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>container</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.hongfu.com/library/myapp<span class="token punctuation">:</span>v1</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">postStart</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token key atrule">exec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"echo Hello from the postStart handler > /usr/share/message"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">preStop</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">exec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"echo Hello from the poststop handler > /usr/share/message"</span><span class="token punctuation">]</span></pre></td></tr></table></figure>
      <div class="tags">
          <a href="/tags/K8s/" rel="tag"><i class="ic i-tag"></i> K8s</a>
          <a href="/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/" rel="tag"><i class="ic i-tag"></i> 容器化</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2023-03-18 17:40:33" itemprop="dateModified" datetime="2023-03-18T17:40:33+08:00">2023-03-18</time>
  </span>
  <span id="hou-duan/ci-cd/k8s/" class="item leancloud_visitors" data-flag-title="Kubernetes" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="别人都叫我老范 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="别人都叫我老范 支付宝">
        <p>支付宝</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="别人都叫我老范 贝宝">
        <p>贝宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>别人都叫我老范 <i class="ic i-at"><em>@</em></i>一位 Blog
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="http://adamshang2333.github.io/hou-duan/ci-cd/k8s/" title="Kubernetes">http://adamshang2333.github.io/hou-duan/ci-cd/k8s/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/qi-ta/markdown-yu-fa-zong-jie/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;oldFun&#x2F;picGitee&#x2F;raw&#x2F;master&#x2F;img&#x2F;wallhaven-zm1lwy.png" title="Markdown语法">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> Markdown</span>
  <h3>Markdown语法</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/qian-duan/js-h5/css-dong-tai-xiao-guo/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;oldFun&#x2F;picGitee&#x2F;raw&#x2F;master&#x2F;img&#x2F;wallhaven-83yp2j.jpg" title="css动态效果总结">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>css动态效果总结</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text"> 一。简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%86%E8%A7%A3k8s-%E5%AE%B9%E5%99%A8%E5%8C%96"><span class="toc-number">1.1.</span> <span class="toc-text"> 了解 K8s &amp; 容器化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%AE%B9%E5%99%A8"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 什么是容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E6%A0%87%E5%87%86"><span class="toc-number">1.1.2.</span> <span class="toc-text"> 容器标准</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Ek8s%E5%92%8Cdocker%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">1.1.3.</span> <span class="toc-text"> 关于 K8s 和 Docker 的关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E7%9A%84%E5%8A%9F%E8%83%BD%E7%89%B9%E6%80%A7"><span class="toc-number">1.2.</span> <span class="toc-text"> k8s 的功能特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B8%8A%E7%BA%BF%E5%92%8C%E5%9B%9E%E6%BB%9A"><span class="toc-number">1.2.0.1.</span> <span class="toc-text"> 自动化上线和回滚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.2.0.2.</span> <span class="toc-text"> 服务发现与负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E6%88%91%E4%BF%AE%E5%A4%8D"><span class="toc-number">1.2.0.3.</span> <span class="toc-text"> 自我修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E7%BC%96%E6%8E%92"><span class="toc-number">1.2.0.4.</span> <span class="toc-text"> 存储编排</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#secret-%E5%92%8C%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">1.2.0.5.</span> <span class="toc-text"> Secret 和配置管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E8%A3%85%E7%AE%B1"><span class="toc-number">1.2.0.6.</span> <span class="toc-text"> 自动装箱</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%89%A7%E8%A1%8C"><span class="toc-number">1.2.0.7.</span> <span class="toc-text"> 批量执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ipv4ipv6-%E5%8F%8C%E5%8D%8F%E8%AE%AE%E6%A0%88"><span class="toc-number">1.2.0.8.</span> <span class="toc-text"> IPv4&#x2F;IPv6 双协议栈</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B0%B4%E5%B9%B3%E6%89%A9%E7%BC%A9"><span class="toc-number">1.2.0.9.</span> <span class="toc-text"> 水平扩缩</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E6%89%A9%E5%B1%95%E6%80%A7%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.0.10.</span> <span class="toc-text"> 为扩展性设计</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C-k8s%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84%E5%92%8C%E7%BB%84%E4%BB%B6"><span class="toc-number">2.</span> <span class="toc-text"> 二.  K8s 的集群架构和组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text"> 集群架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%BB%84%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text"> 集群组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#master%E7%BB%84%E4%BB%B6"><span class="toc-number">2.2.1.</span> <span class="toc-text"> Master 组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-api-kube-apiserver"><span class="toc-number">2.2.1.1.</span> <span class="toc-text"> 1. api (kube-apiserver)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-etcd"><span class="toc-number">2.2.1.2.</span> <span class="toc-text"> 2. etcd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-kube-scheduler"><span class="toc-number">2.2.1.3.</span> <span class="toc-text"> 3. kube-scheduler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-c-m-kube-controller-manager"><span class="toc-number">2.2.1.4.</span> <span class="toc-text"> 4. c-m (kube-controller-manager)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-c-c-m-cloud-controller-manager"><span class="toc-number">2.2.1.5.</span> <span class="toc-text"> 5. c-c-m (cloud-controller-manager)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node%E7%BB%84%E4%BB%B6"><span class="toc-number">2.2.2.</span> <span class="toc-text"> Node 组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-kubelet"><span class="toc-number">2.2.2.1.</span> <span class="toc-text"> 1. kubelet </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-kube-proxy"><span class="toc-number">2.2.2.2.</span> <span class="toc-text"> 2. kube-proxy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6container-runtime"><span class="toc-number">2.2.2.3.</span> <span class="toc-text"> 3. 容器运行时（Container Runtime）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6addons"><span class="toc-number">2.3.</span> <span class="toc-text"> 插件（Addons）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E6%8F%92%E4%BB%B6"><span class="toc-number">2.3.1.</span> <span class="toc-text"> 常用的插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#coredns"><span class="toc-number">2.3.1.1.</span> <span class="toc-text"> CoreDNS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ingresscontroller"><span class="toc-number">2.3.1.2.</span> <span class="toc-text"> ingressController</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#prometheus"><span class="toc-number">2.3.1.3.</span> <span class="toc-text"> Prometheus</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dashboard%E4%BB%AA%E8%A1%A8%E7%9B%98"><span class="toc-number">2.3.1.4.</span> <span class="toc-text"> Dashboard（仪表盘） </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7"><span class="toc-number">2.3.1.5.</span> <span class="toc-text"> 容器资源监控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%B1%82%E9%9D%A2%E6%97%A5%E5%BF%97"><span class="toc-number">2.3.1.6.</span> <span class="toc-text"> 集群层面日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rancher"><span class="toc-number">2.3.2.</span> <span class="toc-text"> Rancher</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#federation"><span class="toc-number">2.3.3.</span> <span class="toc-text"> Federation</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89-k8s%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">3.</span> <span class="toc-text"> 三.  k8s 核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.1.</span> <span class="toc-text"> K8S 对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.1.1.</span> <span class="toc-text"> 什么是对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%8F%8F%E8%BF%B0k8s%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.1.2.</span> <span class="toc-text"> 如何描述 k8s 对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.2.1.</span> <span class="toc-text"> 查询对象配置文件结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%AD%97%E6%AE%B5"><span class="toc-number">3.1.2.2.</span> <span class="toc-text"> 常用的对象字段</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BAk8s%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.1.3.</span> <span class="toc-text"> 如何创建 k8s 对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pod"><span class="toc-number">3.2.</span> <span class="toc-text"> Pod</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">3.2.1.</span> <span class="toc-text"> 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pod%E7%9A%84%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="toc-number">3.2.2.</span> <span class="toc-text"> pod 的创建流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pause%E5%AE%B9%E5%99%A8"><span class="toc-number">3.2.3.</span> <span class="toc-text"> pause 容器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#node"><span class="toc-number">3.3.</span> <span class="toc-text"> Node</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E5%90%8D%E7%A7%B0%E5%94%AF%E4%B8%80%E6%80%A7"><span class="toc-number">3.3.1.</span> <span class="toc-text"> 节点名称唯一性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#namespace"><span class="toc-number">3.4.</span> <span class="toc-text"> Namespace</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#label"><span class="toc-number">3.5.</span> <span class="toc-text"> Label</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#annotations"><span class="toc-number">3.6.</span> <span class="toc-text"> Annotations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#controller"><span class="toc-number">3.7.</span> <span class="toc-text"> controller</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFcontroller"><span class="toc-number">3.7.1.</span> <span class="toc-text"> 什么是 controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E7%A7%8D%E7%B1%BB"><span class="toc-number">3.7.2.</span> <span class="toc-text"> 控制器种类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E5%88%86%E7%B1%BB"><span class="toc-number">3.7.3.</span> <span class="toc-text"> 控制器分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8"><span class="toc-number">3.7.3.1.</span> <span class="toc-text"> 无状态应用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E5%9E%8B"><span class="toc-number">3.7.3.1.1.</span> <span class="toc-text"> 通用型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E5%9C%BA%E6%99%AF"><span class="toc-number">3.7.3.1.2.</span> <span class="toc-text"> 特殊场景</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%89%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8"><span class="toc-number">3.7.3.2.</span> <span class="toc-text"> 有状态应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">3.7.3.3.</span> <span class="toc-text"> 自定义控制器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E5%9F%BA%E4%BA%8E%E9%9B%86%E5%90%88%E9%9C%80%E6%B1%82%E7%9A%84%E8%B5%84%E6%BA%90"><span class="toc-number">3.7.3.4.</span> <span class="toc-text"> 支持基于集合需求的资源</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rc-rs"><span class="toc-number">3.7.4.</span> <span class="toc-text"> RC &#x2F; RS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#deployment"><span class="toc-number">3.7.5.</span> <span class="toc-text"> Deployment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#statefulset"><span class="toc-number">3.7.6.</span> <span class="toc-text"> StatefulSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#daemonset"><span class="toc-number">3.7.7.</span> <span class="toc-text"> DaemonSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#job"><span class="toc-number">3.7.8.</span> <span class="toc-text"> Job</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cronjob"><span class="toc-number">3.7.9.</span> <span class="toc-text"> CronJob</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hpa"><span class="toc-number">3.7.10.</span> <span class="toc-text"> HPA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s%E4%B8%AD%E7%9A%84%E6%B0%B4%E5%B9%B3%E6%89%A9%E7%BC%A9%E5%92%8C%E5%9E%82%E7%9B%B4%E6%89%A9%E7%BC%A9"><span class="toc-number">3.7.11.</span> <span class="toc-text"> K8s 中的水平扩缩和垂直扩缩</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#service"><span class="toc-number">3.8.</span> <span class="toc-text"> Service</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-number">3.8.1.</span> <span class="toc-text"> 功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service%E7%9A%84%E5%85%AC%E5%BC%80%E6%96%B9%E5%BC%8F"><span class="toc-number">3.8.2.</span> <span class="toc-text"> service 的公开方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ingress"><span class="toc-number">3.9.</span> <span class="toc-text"> ingress</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B-k8s%E7%9A%84%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C"><span class="toc-number">4.</span> <span class="toc-text"> 四.  k8s 的集群网络</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#kubernetes-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B"><span class="toc-number">4.1.</span> <span class="toc-text"> Kubernetes 网络模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E7%BD%91%E7%BB%9C%E8%A6%81%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.</span> <span class="toc-text"> k8s 网络要解决的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0-kubernetes-%E7%9A%84%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B"><span class="toc-number">4.3.</span> <span class="toc-text"> 如何实现 Kubernetes 的网络模型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94-k8s-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">5.</span> <span class="toc-text"> 五.  K8S 集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%9F%BA%E7%A1%80%E8%A6%81%E6%B1%82"><span class="toc-number">5.1.</span> <span class="toc-text"> 搭建基础要求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%86%E5%A4%87"><span class="toc-number">5.2.</span> <span class="toc-text"> 系统初始化准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E7%B3%BB%E7%BB%9F%E4%B8%BB%E6%9C%BA%E5%90%8D%E4%BB%A5%E5%8F%8A-host-%E6%96%87%E4%BB%B6%E7%9A%84%E7%9B%B8%E4%BA%92%E8%A7%A3%E6%9E%90"><span class="toc-number">5.2.1.</span> <span class="toc-text"> 设置系统主机名以及 Host 文件的相互解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%8C%85"><span class="toc-number">5.2.2.</span> <span class="toc-text"> 安装依赖包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99%E4%B8%BA-iptables-%E5%B9%B6%E8%AE%BE%E7%BD%AE%E7%A9%BA%E8%A7%84%E5%88%99"><span class="toc-number">5.2.3.</span> <span class="toc-text"> 设置防火墙为 Iptables 并设置空规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%AD-selinux"><span class="toc-number">5.2.4.</span> <span class="toc-text"> 关闭 SELINUX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E7%B3%BB%E7%BB%9F%E6%97%B6%E5%8C%BA"><span class="toc-number">5.2.5.</span> <span class="toc-text"> 调整系统时区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E7%B3%BB%E7%BB%9F%E4%B8%8D%E9%9C%80%E8%A6%81%E6%9C%8D%E5%8A%A1%E9%9D%9E%E5%BF%85%E9%A1%BB"><span class="toc-number">5.2.6.</span> <span class="toc-text"> 关闭系统不需要服务 (非必须)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A3%85%E5%AE%B9%E5%99%A8-containerd%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9"><span class="toc-number">5.2.7.</span> <span class="toc-text"> 装容器 containerd（所有节点）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-k8s-yum-%E6%BA%90%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9"><span class="toc-number">5.2.8.</span> <span class="toc-text"> 配置 k8s yum 源（所有节点）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E5%AF%B9%E4%BA%8E-k8s%E9%9D%9E%E5%BF%85%E9%A1%BB"><span class="toc-number">5.2.9.</span> <span class="toc-text"> 调整内核参数，对于 K8S (非必须)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97%E4%BC%98%E5%8C%96%E9%9D%9E%E5%BF%85%E9%A1%BB"><span class="toc-number">5.2.10.</span> <span class="toc-text"> 设置系统日志优化 (非必须)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8%E4%B8%BA-444%E9%9D%9E%E5%BF%85%E9%A1%BB"><span class="toc-number">5.2.11.</span> <span class="toc-text"> 升级系统内核为 4.44 (非必须)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kube-proxy%E5%BC%80%E5%90%AFipvs%E5%87%86%E5%A4%87"><span class="toc-number">5.2.12.</span> <span class="toc-text"> kube-proxy 开启 ipvs 准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AFipvs%E7%9A%84%E5%89%8D%E7%BD%AE%E6%9D%A1%E4%BB%B6"><span class="toc-number">5.2.12.1.</span> <span class="toc-text"> 开启 ipvs 的前置条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEipvs"><span class="toc-number">5.2.12.2.</span> <span class="toc-text"> 配置 ipvs</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">5.3.</span> <span class="toc-text"> 集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85k8s%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">5.3.1.</span> <span class="toc-text"> 安装 K8S 的方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-docker-%E8%BD%AF%E4%BB%B6"><span class="toc-number">5.3.2.</span> <span class="toc-text"> 安装 Docker 软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-kubeadm-kubelet%E4%B8%BB%E4%BB%8E%E5%9D%87%E9%85%8D%E7%BD%AE"><span class="toc-number">5.3.3.</span> <span class="toc-text"> 安装 Kubeadm, kubelet（主从均配置）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="toc-number">5.3.4.</span> <span class="toc-text"> 初始化主节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%85%A5%E5%85%B6%E4%BD%99%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9"><span class="toc-number">5.3.5.</span> <span class="toc-text"> 加入其余工作节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6"><span class="toc-number">5.3.6.</span> <span class="toc-text"> 部署网络插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-pod-%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6cnicontainer-network-interface"><span class="toc-number">5.3.6.1.</span> <span class="toc-text"> 安装 Pod 网络插件（CNI：Container Network Interface)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3"><span class="toc-number">5.4.</span> <span class="toc-text"> 安装报错解决</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kubeadm-init-%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3"><span class="toc-number">5.4.1.</span> <span class="toc-text"> kubeadm init 报错解决</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#initial-timeout-of-40s-passed"><span class="toc-number">5.4.1.1.</span> <span class="toc-text"> Initial timeout of 40s passed.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#failed-to-get-sandbox-image-k8sgcriopause36"><span class="toc-number">5.4.1.2.</span> <span class="toc-text"> Failed to get sandbox image “k8s.gcr.io&#x2F;pause:3.6“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#failed-to-start-containerd-container-runtime"><span class="toc-number">5.4.1.3.</span> <span class="toc-text"> Failed to start containerd container runtime</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#etcd%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5"><span class="toc-number">5.4.1.4.</span> <span class="toc-text"> etcd 启动失败</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85flannel%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3"><span class="toc-number">5.4.2.</span> <span class="toc-text"> 安装 Flannel 报错解决</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#failed-to-get-sandbox-image-k8sgcriopause36-2"><span class="toc-number">5.4.2.1.</span> <span class="toc-text"> Failed to get sandbox image “k8s.gcr.io&#x2F;pause:3.6“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#node%E8%8A%82%E7%82%B9%E7%9A%84flannel%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8"><span class="toc-number">5.4.2.2.</span> <span class="toc-text"> node 节点的 flannel 无法启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node%E8%8A%82%E7%82%B9%E5%9C%A8%E9%83%A8%E7%BD%B2%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E5%90%8E%E4%B8%80%E7%9B%B4%E6%98%AFnotready%E7%8A%B6%E6%80%81"><span class="toc-number">5.4.3.</span> <span class="toc-text"> node 节点在部署网络插件后一直是 NotReady 状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubeadm-init%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90"><span class="toc-number">5.5.</span> <span class="toc-text"> kubeadm init 日志解析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%ADk8s%E7%9A%84%E8%B5%84%E6%BA%90"><span class="toc-number">6.</span> <span class="toc-text"> 六.K8S 的资源</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%B5%84%E6%BA%90"><span class="toc-number">6.1.</span> <span class="toc-text"> 什么是资源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-number">6.1.1.</span> <span class="toc-text"> 资源的分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4%E7%BA%A7%E8%B5%84%E6%BA%90"><span class="toc-number">6.1.1.1.</span> <span class="toc-text"> 名称空间级资源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%BA%A7%E8%B5%84%E6%BA%90"><span class="toc-number">6.1.1.2.</span> <span class="toc-text"> 集群级资源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E5%9E%8B%E8%B5%84%E6%BA%90"><span class="toc-number">6.1.1.3.</span> <span class="toc-text"> 元数据型资源</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95"><span class="toc-number">6.1.2.</span> <span class="toc-text"> 资源清单</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%A0%BC%E5%BC%8F"><span class="toc-number">6.2.</span> <span class="toc-text"> 资源清单格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E7%9A%84%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">6.3.</span> <span class="toc-text"> 资源清单的常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%AE%9A%E4%B9%89%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA-pod"><span class="toc-number">6.4.</span> <span class="toc-text"> 通过定义清单文件创建 Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#init-%E5%AE%B9%E5%99%A8"><span class="toc-number">6.5.</span> <span class="toc-text"> Init 容器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#init-%E6%A8%A1%E6%9D%BF"><span class="toc-number">6.5.0.0.1.</span> <span class="toc-text"> init 模板</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%8E%A2%E9%92%88-%E5%B0%B1%E7%BB%AA%E6%A3%80%E6%B5%8B"><span class="toc-number">6.6.</span> <span class="toc-text"> 检测探针 - 就绪检测</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#readinessprobe-httpget"><span class="toc-number">6.6.0.0.1.</span> <span class="toc-text"> readinessProbe-httpget</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%8E%A2%E9%92%88-%E5%AD%98%E6%B4%BB%E6%A3%80%E6%B5%8B"><span class="toc-number">6.7.</span> <span class="toc-text"> 检测探针 - 存活检测</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#livenessprobe-exec"><span class="toc-number">6.7.0.0.1.</span> <span class="toc-text"> livenessProbe-exec</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#livenessprobe-httpget"><span class="toc-number">6.7.0.0.2.</span> <span class="toc-text"> livenessProbe-httpget</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#livenessprobe-tcp"><span class="toc-number">6.7.0.0.3.</span> <span class="toc-text"> livenessProbe-tcp</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-%E9%80%80%E5%87%BA%E5%8A%A8%E4%BD%9C"><span class="toc-number">6.8.</span> <span class="toc-text"> 启动、退出动作</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li><a href="/hou-duan/ci-cd/ci-cd-jenkins/" rel="bookmark" title="CI_CD&&Jenkins">CI_CD&&Jenkins</a></li><li><a href="/hou-duan/ci-cd/ce-shi-jenkins/" rel="bookmark" title="测试Jenkins">测试Jenkins</a></li><li class="active"><a href="/hou-duan/ci-cd/k8s/" rel="bookmark" title="Kubernetes">Kubernetes</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="别人都叫我老范"
      data-src="/images/%E5%90%90%E8%88%8C.jpeg">
  <p class="name" itemprop="name">别人都叫我老范</p>
  <div class="description" itemprop="description"><div style='font-size: 0.8em;'> I.is (null); <br/>If (U.appear ()) <br/>I.turn (new World ('Fill With Love')) <br/>// 我的世界 <br/>// 直至遇见你 <br/>// 才熠熠生辉 </div> </div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">44</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">16</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">14</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL093bGNpdHkyMzMz" title="https:&#x2F;&#x2F;github.com&#x2F;Owlcity2333"><i class="ic i-github"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTI1MTg0NjMxMw==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;251846313"><i class="ic i-cloud-music"></i></span>
      <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yourname"><i class="ic i-zhihu"></i></span>
      <span class="exturl item weixin" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTI1MTg0NjMxMw==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;251846313"><i class="ic i-weixin"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOjc1OTU0NzkxNkBxcS5jb20=" title="mailto:759547916@qq.com"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>文章</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>

</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/qi-ta/markdown-yu-fa-zong-jie/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/qian-duan/js-h5/css-dong-tai-xiao-guo/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/shu-ju-ku/shu-ju-ku-duo-biao-cha-xun/" title="数据库多表查询">数据库多表查询</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/java/" title="分类于 java">java</a>
<i class="ic i-angle-right"></i>
<a href="/categories/java/basics/" title="分类于 基础">基础</a>
</div>

    <span><a href="/hou-duan/java/basics/java-ji-chu/" title="IO基础">IO基础</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/hou-duan/bing-fa-fen-bu-shi/fen-bu-shi-shi-wu/" title="分布式事务">分布式事务</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/qian-duan/angular/angular-ru-men/" title="Angular入门">Angular入门</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/hou-duan/spring/spring-yu-springmvc-de-guan-xi/" title="Spring&amp;&amp;SpringMVC">Spring&&SpringMVC</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/hou-duan/java/java-collection/" title="Java collection">Java collection</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/qian-duan/js-h5/css-yang-shi-ji-chu/" title="css基础样式">css基础样式</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/hou-duan/docker/docker-ru-men/" title="Docker入门 2333">Docker入门 2333</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/qian-duan/js-h5/js-ji-chu/" title="JS总结">JS总结</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/qian-duan/js-h5/h5-xin-zeng/" title="H5新增内容总结">H5新增内容总结</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">别人都叫我老范 @ bit Blog</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">358k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">5:26</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: 'hou-duan/ci-cd/k8s/',
    favicon: {
      show: "(^_^) 呦吼~",
      hide: "(´Д｀)哪去了?"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"superSample":2,"width":180,"height":360,"position":"right","hOffset":-20,"vOffset":-15},"log":false,"tagMode":false});</script></body>
</html>
